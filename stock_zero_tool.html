<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리코드별 색상/사이즈 품절툴</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Pretendard','Apple SD Gothic Neo','맑은 고딕',sans-serif; background:#fff; color:#203326; font-size:16px; margin:0; padding:0;}
    .container { max-width:820px; margin:40px auto 0 auto; background:#f7faf7; border-radius:16px; box-shadow:0 2px 18px rgba(40,80,60,0.07); padding:38px 38px 30px 38px;}
    .back-btn { margin-bottom:20px; background:#f3f5f6; color:#2d684a; border:1.2px solid #b0c9bb; border-radius:9px; padding:8px 18px; font-size:15.2px; font-weight:500; cursor:pointer; transition:background 0.13s, border 0.14s, color 0.13s; display:inline-block;}
    .back-btn:hover { background:#d2e3da; color:#184c37; border-color:#92bfa7;}
    .main-title { font-size:2rem; font-weight:700; color:#184c37; margin-bottom:20px; letter-spacing:0.02em;}
    .desc { font-size:15px; color:#427057; margin-bottom:26px; line-height:1.7;}
    .file-btn-wrap { display:flex; align-items:center; gap:12px; margin-bottom:28px;}
    .custom-file-label { background:#e1ece6; color:#2d684a; border:1.2px solid #b0c9bb; border-radius:8px; padding:8px 18px; font-size:15px; font-weight:500; cursor:pointer; transition:background 0.15s, border 0.14s; display:inline-block;}
    .custom-file-label:hover { background:#d2e3da; color:#184c37; border-color:#89ac98;}
    #fileName { font-size:14.5px; color:#5b6c65; min-width:130px;}
    .toggle-btn { min-width:130px; height:40px; background:#e1ece6; color:#2d684a; border:1.3px solid #b0c9bb; border-radius:10px; font-size:15.5px; font-weight:600; cursor:pointer; transition:background 0.14s, border 0.14s, color 0.12s; outline:none;}
    .toggle-btn.on { background:#61ad80 !important; color:#fff !important; border-color:#46855b !important;}
    .reset-btn { min-width:80px; height:40px; background:#f7e6e6; color:#a85b5b; border:1.2px solid #c5a3a3; border-radius:10px; font-size:15.2px; font-weight:600; cursor:pointer; margin-left:3px; transition:background 0.12s, border 0.14s, color 0.13s;}
    .reset-btn:hover { background:#ffdada; border-color:#d68c8c; color:#b43939;}
    .tip { font-size:13px; color:#818484; margin-bottom:3px; margin-top:-9px; margin-left:2px;}
    .option-cb { font-size:14.5px; color:#306e49; margin-left:2px; margin-bottom:5px;}
    .option-cb input[type=checkbox] { accent-color:#61ad80; margin-right:4px; }
    .code-list-wrap { margin:18px 0 8px 0; padding:0; display:flex; flex-wrap:wrap; gap:11px 15px; min-height:38px; flex-direction: row;}
    .code-btn { padding:8px 18px; font-size:15px; border-radius:7px; border:1.3px solid #c3d7c5; background:#e1ece6; color:#20432a; font-weight:500; cursor:pointer; transition:background 0.15s, border 0.13s, color 0.13s; user-select:none; outline:none; position:relative;}
    .code-btn.selected, .code-btn:active { background:#61ad80 !important; color:#fff !important; border-color:#46855b !important;}
    .code-btn:hover:not(.selected) { background:#d2e3da; border-color:#92bfa7; color:#184c37;}
    .option-chooser { width:100%; max-width:600px; min-width:320px; background:#f2f8f3; border-radius:10px; margin:16px 0 18px 0; padding:18px 18px 11px 18px; border:1.2px solid #d3e6d8; box-shadow:0 2px 12px rgba(40,80,60,0.08); display:flex; flex-direction:column; gap:12px 0; animation:fadein 0.15s; z-index:10; position:relative;}
    @keyframes fadein { from { opacity:0; transform:translateY(-5px);} to   { opacity:1; transform:none;}}
    .option-title { font-size:15.2px; color:#386c52; font-weight:500; margin-bottom:3px;}
    .opt-group { display:flex; flex-wrap:wrap; gap:8px 10px; margin-bottom:2px;}
    .opt-btn { padding:7px 13px; font-size:14.2px; border-radius:7px; border:1.2px solid #b9d1c0; background:#e1ece6; color:#24402c; font-weight:500; cursor:pointer; transition:background 0.14s, border 0.14s, color 0.14s; outline:none; user-select:none;}
    .opt-btn.selected { background:#61ad80 !important; color:#fff !important; border-color:#46855b !important;}
    .opt-btn:hover:not(.selected) { background:#d2e3da; color:#184c37;}
    .action-btn { background:#e1ece6; color:#2d684a; border:1.3px solid #b0c9bb; border-radius:9px; padding:0 28px; font-size:17px; font-weight:600; height:46px; cursor:pointer; margin:0 auto; display:block; margin-top:6px; transition:background 0.13s, border 0.14s;}
    .action-btn:active,.action-btn.selected { background:#61ad80 !important; color:#fff !important; border-color:#46855b !important;}
    .action-btn:hover:not(.selected) { background:#d2e3da; border-color:#92bfa7; color:#184c37;}
    @media (max-width:700px) {.container { max-width:99%; padding:22px 5vw 20px 5vw; } .main-title { font-size:1.4rem; } .file-btn-wrap { flex-direction:column; gap:9px; align-items:stretch; } .option-chooser { max-width:99vw;}}
  </style>
</head>
<body>
  <div class="container">
    <button id="backToMainBtn" class="back-btn">← 스마트스토어 옵션 자동 생성기로 돌아가기</button>
    <div class="main-title">관리코드별 색상/사이즈 품절툴</div>
    <div class="desc">
      여러 옵션 파일을 업로드하고<br>
      <b>관리코드</b>를 클릭하면 전체 품절, 또는<br>
      <b>색상·사이즈별 품절</b>을 선택해서<br>
      원하는 옵션만 재고 0(품절)로 변경합니다.<br>
      <span style="color:#b23b3b">옵션 이름은 반드시 각 행의 '색상', '사이즈' 컬럼에 정확히 입력되어 있어야 합니다.</span>
    </div>
    <div class="file-btn-wrap">
      <input type="file" id="files" multiple accept=".xls,.xlsx" style="display:none;">
      <button type="button" class="custom-file-label" onclick="document.getElementById('files').click();">엑셀 파일 선택</button>
      <span id="fileName">파일을 업로드 해주세요</span>
      <button id="togglePartialBtn" class="toggle-btn" type="button">색상,사이즈별 품절 OFF</button>
      <button id="resetBtn" class="reset-btn" type="button">초기화</button>
    </div>
    <div class="tip" id="total-codes-tip"></div>
    <div class="option-cb" style="margin-bottom:16px;">
      <label><input type="checkbox" id="setRestStock" checked>품절 외 재고 99999</label>
    </div>
    <div id="code-list" class="code-list-wrap"></div>
    <!-- 옵션창은 동적으로 code-list 아래 한 곳에만 붙음 -->
    <button id="downloadBtn" class="action-btn" disabled>선택 품절처리 & 파일 다운로드</button>
  </div>
  <script>
    document.getElementById('backToMainBtn').addEventListener('click', function() {
      window.location.href = 'https://easyhara.github.io/smartstore_options/smartstore_options.html';
    });

    let fileSheets = [];
    let allCodes = [];
    let selectedCodes = new Set();
    let partialMode = false;
    let partialMap = {};
    let setRestStock = true;

    document.getElementById('setRestStock').addEventListener('change', function() {
      setRestStock = this.checked;
    });

    // ★★★★★ 초기화 함수 추가 ★★★★★
    function resetAll() {
      fileSheets = [];
      allCodes = [];
      selectedCodes = new Set();
      partialMap = {};
      partialMode = false;
      setRestStock = true;
      document.getElementById('files').value = '';
      document.getElementById('fileName').textContent = '파일을 업로드 해주세요';
      document.getElementById('togglePartialBtn').textContent = "색상,사이즈별 품절 OFF";
      document.getElementById('togglePartialBtn').classList.remove('on');
      document.getElementById('setRestStock').checked = true;
      document.getElementById('code-list').innerHTML = '';
      document.getElementById('downloadBtn').disabled = true;
      document.getElementById('total-codes-tip').textContent = '';
      // 옵션창도 모두 닫기
      document.querySelectorAll('.option-chooser').forEach(el => el.remove());
    }

    // 초기화 버튼 이벤트 연결
    document.getElementById('resetBtn').addEventListener('click', resetAll);

    function parseValues(str) {
      if(!str) return [];
      return str.split(/[,，·､\/／]/g).map(s=>s.trim()).filter(Boolean);
    }
    function uniqueSort(arr) {
      return Array.from(new Set(arr)).sort();
    }

    // 파일 선택 input: 파일 추가시 기존 fileSheets에 추가(초기화 안 하면 누적)
    document.getElementById('files').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      if (!files.length) return;
      let prevFileNames = fileSheets.map(f=>f.fileName);
      let codeSet = new Set(allCodes);
      let readCnt = 0;
      files.forEach(file => {
        // 같은 파일명 이미 있으면 skip
        if(prevFileNames.includes(file.name)) {
          readCnt++;
          if(readCnt === files.length) showCodes();
          return;
        }
        const reader = new FileReader();
        reader.onload = function(evt) {
          const wb = XLSX.read(evt.target.result, {type: 'array'});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
          rows.forEach(r => { if(r['관리코드']) codeSet.add(r['관리코드']); });
          fileSheets.push({fileName: file.name, rows});
          readCnt++;
          if(readCnt === files.length) {
            allCodes = Array.from(codeSet);
            document.getElementById('fileName').textContent =
              fileSheets.map(f=>f.fileName).join(', ');
            showCodes();
          }
        };
        reader.readAsArrayBuffer(file);
      });
    });

    document.getElementById('togglePartialBtn').addEventListener('click', function() {
      partialMode = !partialMode;
      this.textContent = partialMode ? "색상,사이즈별 품절 ON" : "색상,사이즈별 품절 OFF";
      this.classList.toggle('on', partialMode);
      selectedCodes.clear();
      partialMap = {};
      showCodes();
      document.getElementById('downloadBtn').disabled = true;
      // 옵션창도 닫기
      document.querySelectorAll('.option-chooser').forEach(el => el.remove());
    });

    function showCodes() {
      const listDiv = document.getElementById('code-list');
      listDiv.innerHTML = '';
      document.querySelectorAll('.option-chooser').forEach(el => el.remove()); // 옵션창 모두 제거
      if(!allCodes.length) {
        document.getElementById('total-codes-tip').textContent = '업로드된 파일에서 관리코드가 없습니다.';
        return;
      }
      updateTip();
      allCodes.forEach(code => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'code-btn';
        btn.textContent = code;
        btn.style.position = 'relative';
        if(!partialMode) {
          btn.classList.toggle('selected', selectedCodes.has(code));
          btn.addEventListener('click', function() {
            if(btn.classList.contains('selected')) {
              btn.classList.remove('selected');
              selectedCodes.delete(code);
            } else {
              btn.classList.add('selected');
              selectedCodes.add(code);
            }
            updateTip();
            document.getElementById('downloadBtn').disabled = selectedCodes.size === 0;
          });
        }
        else {
          btn.classList.toggle('selected', !!partialMap[code]);
          btn.addEventListener('click', function(e) {
            // 옵션창 모두 닫기
            document.querySelectorAll('.option-chooser').forEach(el => el.remove());
            // 다른 버튼 selected 해제
            document.querySelectorAll('.code-btn.selected').forEach(b=>{
              if(b!==btn) b.classList.remove('selected');
            });
            // 옵션창 이미 열려있으면 닫기
            if(btn.classList.contains('selected')) {
              btn.classList.remove('selected');
              delete partialMap[code];
              updateTip();
              document.getElementById('downloadBtn').disabled = !hasPartialAny();
              return;
            }
            btn.classList.add('selected');
            // option-chooser 생성
            let optWrap = document.createElement('div');
            optWrap.className = 'option-chooser';
            let allRows = [];
            fileSheets.forEach(f=>{
              allRows = allRows.concat(f.rows.filter(r=>r['관리코드']===code));
            });
            let colors = uniqueSort([].concat(...allRows.map(r=>parseValues(r['색상']))));
            let sizes  = uniqueSort([].concat(...allRows.map(r=>parseValues(r['사이즈']))));
            let combos = [];
            if(colors.length && sizes.length) {
              colors.forEach(c=>sizes.forEach(s=>combos.push([c,s])));
            } else if(colors.length) {
              combos = colors.map(c=>[c,""]);
            } else if(sizes.length) {
              combos = sizes.map(s=>["",s]);
            } else {
              combos = [["",""]];
            }
            let selSet = partialMap[code] || new Set();
            let label = document.createElement('div');
            label.className = 'option-title';
            label.textContent = "품절로 처리할 색상/사이즈 옵션을 선택하세요.";
            optWrap.appendChild(label);
            let group = document.createElement('div');
            group.className = 'opt-group';
            combos.forEach(([col, sz])=>{
              let txt = [col, sz].filter(Boolean).join(" / ") || "(옵션없음)";
              let id = col+"||"+sz;
              let b = document.createElement('button');
              b.type = 'button';
              b.className = 'opt-btn';
              b.textContent = txt;
              if(selSet.has(id)) b.classList.add('selected');
              b.addEventListener('click',function(){
                if(b.classList.contains('selected')) {
                  b.classList.remove('selected');
                  selSet.delete(id);
                } else {
                  b.classList.add('selected');
                  selSet.add(id);
                }
                partialMap[code] = selSet;
                updateTip();
                document.getElementById('downloadBtn').disabled = !hasPartialAny();
              });
              group.appendChild(b);
            });
            optWrap.appendChild(group);
            let closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.textContent = "닫기";
            closeBtn.className = "opt-btn";
            closeBtn.style.background = "#f9dadb";
            closeBtn.style.color = "#9d3636";
            closeBtn.style.borderColor = "#efbdbd";
            closeBtn.style.marginTop = "8px";
            closeBtn.addEventListener('click', function(){
              optWrap.remove();
              btn.classList.remove('selected');
              if(selSet.size===0) delete partialMap[code];
              updateTip();
              document.getElementById('downloadBtn').disabled = !hasPartialAny();
            });
            optWrap.appendChild(closeBtn);
            // <<<<<< 옵션창을 항상 code-list-wrap(버튼 라인) 바로 아래 한 번만 띄우기!
            document.getElementById('code-list').after(optWrap);
            partialMap[code] = selSet;
            updateTip();
            document.getElementById('downloadBtn').disabled = !hasPartialAny();
          });
        }
        listDiv.appendChild(btn);
      });
    }
    function updateTip() {
      if(!partialMode)
        document.getElementById('total-codes-tip').textContent =
          `관리코드 ${allCodes.length}개 중 선택: ${selectedCodes.size}개`;
      else {
        let cnt = Object.values(partialMap).map(s=>s?s.size:0).reduce((a,b)=>a+b,0);
        document.getElementById('total-codes-tip').textContent =
          `색상/사이즈별 품절: 총 ${cnt}개 선택됨`;
      }
    }
    function hasPartialAny() {
      return Object.values(partialMap).some(s=>s && s.size>0);
    }

    document.getElementById('downloadBtn').addEventListener('click', function() {
      if(!partialMode && !selectedCodes.size)
        return alert('관리코드를 1개 이상 선택하세요.');
      if(partialMode && !hasPartialAny())
        return alert('옵션 조합을 1개 이상 선택하세요.');
      const zip = new JSZip();
      fileSheets.forEach(({fileName, rows}) => {
        let stockBackup = rows.map(r => r['재고수량']);
        let changed = false;
        rows.forEach((r, idx) => {
          if(!r['관리코드']) return;
          if(!partialMode) {
            if(selectedCodes.has(r['관리코드'])) {
              r['재고수량'] = 0;
              changed = true;
            } else if(setRestStock) {
              r['재고수량'] = 99999;
            } else {
              r['재고수량'] = stockBackup[idx];
            }
          }
          else {
            let sels = partialMap[r['관리코드']];
            let changedThisRow = false;
            if(!sels||!sels.size) {
              if(setRestStock) r['재고수량'] = 99999;
              else r['재고수량'] = stockBackup[idx];
              return;
            }
            let colors = parseValues(r['색상']);
            let sizes  = parseValues(r['사이즈']);
            let combos = [];
            if(colors.length&&sizes.length)
              colors.forEach(c=>sizes.forEach(s=>combos.push([c,s])));
            else if(colors.length)
              combos = colors.map(c=>[c,""]);
            else if(sizes.length)
              combos = sizes.map(s=>["",s]);
            else combos=[["",""]];
            for(const [col,sz] of combos) {
              let id = col+"||"+sz;
              if(sels.has(id)) {
                r['재고수량'] = 0;
                changed = true;
                changedThisRow = true;
              }
            }
            if(!changedThisRow) {
              if(setRestStock) r['재고수량'] = 99999;
              else r['재고수량'] = stockBackup[idx];
            }
          }
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "옵션데이터");
        const out = XLSX.write(wb, {bookType:'xls', type:'array'});
        zip.file(fileName, out);
      });
      zip.generateAsync({type:'blob'}).then(content =>
        saveAs(content, '관리코드_일괄품절.zip')
      );
    });
  </script>
</body>
</html>
