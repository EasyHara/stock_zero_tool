<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì½”ë“œë³„ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ í’ˆì ˆíˆ´ (ê²€ìƒ‰ ë° ì¼ê´„í’ˆì ˆ)</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
body {
  font-family: 'Pretendard', 'Apple SD Gothic Neo', 'ë§‘ì€ ê³ ë”•', sans-serif;
  background: #f8fcf9;
  color: #163326;
  font-size: 16px;
  margin: 0; padding: 0;
}

/* --- 1. ë ˆì´ì•„ì›ƒ (3ë‹¨ êµ¬ì¡°) --- */
.container {
  max-width: 1800px;
  margin: 22px auto 0 auto;
  padding: 0 24px;
  overflow-x: auto;
  min-height: 96vh;
  display: flex;
  flex-direction: row;
  gap: 24px;
  align-items: flex-start;
}

/* 1ë‹¨: ë©”ì¸ ì˜ì—­ (íŒŒì¼, ëª¨ë“œ, ì½”ë“œ ëª©ë¡) */
.main-area {
  flex: 1;
  min-width: 500px;
  background: #fff;
  padding: 30px 42px 38px 42px;
  border-radius: 18px;
  box-shadow: 0 2px 28px rgba(60,80,60,0.09);
}

/* 2ë‹¨: ì»¨í…ìŠ¤íŠ¸ ì˜ì—­ (ìƒì„¸ ì‘ì—… íŒ¨ë„) */
.context-area {
  width: 420px;
  min-width: 400px;
  background: #fdfdfd;
  border: 1px solid #e8f0eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(120,160,120,0.07);
  padding: 22px 24px;
  align-self: flex-start;
  position: sticky;
  top: 22px;
  height: calc(100vh - 44px);
  overflow-y: auto;
  transition: border-color 0.2s, background 0.2s;
}
.context-placeholder {
  text-align: center;
  padding-top: 60px;
  color: #9ab0a5;
  font-size: 15px;
  font-weight: 500;
  line-height: 1.6;
}

/* 3ë‹¨: ì‚¬ì´ë“œ ì˜ì—­ (ê²°ê³¼ ìš”ì•½) */
.side-area {
  width: 380px;
  min-width: 320px;
  background: #f7faf8;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(120,160,120,0.07);
  padding: 18px 22px 24px 22px;
  margin-top: 0;
  align-self: flex-start;
  position: sticky;
  top: 22px;
  height: calc(100vh - 44px);
  display: flex;
  flex-direction: column;
}
.side-area h3 { font-size: 1.1rem; font-weight: 600; color: #195140; margin-bottom: 10px; }

.side-area ul {
  font-size: 14.5px; list-style: none; margin: 0; padding: 0;
  flex: 1;
  overflow-y: auto;
}
/* ê·¸ë£¹ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.side-group {
  background: #fff;
  border: 1px solid #dae8e2;
  border-radius: 8px;
  margin-bottom: 10px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}
/* ê·¸ë£¹ í—¤ë” (ê´€ë¦¬ì½”ë“œ) */
.side-group-title {
  background: #eef5f2;
  padding: 8px 12px;
  color: #246b5c;
  font-weight: 700;
  font-size: 14px;
  border-bottom: 1px solid #e6f0ec;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
/* ê·¸ë£¹ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ (ì˜µì…˜) */
.side-sub-list {
  list-style: none; margin: 0; padding: 0;
}
.side-sub-list li {
  padding: 7px 12px;
  border-bottom: 1px solid #f4f8f6;
  color: #444;
  font-size: 13.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.side-sub-list li:last-child { border-bottom: none; }
.badge-state {
  font-size: 11px; font-weight: 700; padding: 2px 5px; border-radius: 4px;
  min-width: 28px; text-align: center;
}
.badge-soldout { background: #ffeaea; color: #c53030; }
.badge-discont { background: #ede9fe; color: #6d28d9; }
.badge-all-soldout { background: #c6f6d5; color: #22543d; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
.badge-all-discont { background: #e9d8fd; color: #44337a; font-size: 11px; padding: 2px 6px; border-radius: 4px; }


/* --- 2. ì»¨íŠ¸ë¡¤ (ë²„íŠ¼, ì…ë ¥ ë“±) --- */
.main-title-wrap {
  display: flex; align-items: flex-end; justify-content: space-between;
  min-height: 48px; margin-bottom: 16px; position: relative; padding-right: 42px;
}
.main-title {
  font-size: 2.2rem; font-weight: 700; color: #184c37;
  margin: 0 0 0 16px; letter-spacing: 0.02em;
}
.back-btn {
  background: #e1ece6; border: 1.2px solid #b0c9bb; color: #246b5c;
  border-radius: 10px; padding: 11px 22px; font-size: 15px; font-weight: 600;
  margin-bottom: 18px; margin-top: 6px; margin-left: 8px; cursor: pointer;
  transition: background 0.13s, color 0.13s;
}
.back-btn:hover { background: #d2e3da; color: #184c37; border-color: #89ac98; }

.file-select-area {
  display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
}
.file-label {
  background: #e1ece6; color: #296149; border: 1.2px solid #b0c9bb;
  border-radius: 10px; padding: 11px 23px; font-size: 15px; font-weight: 600;
  cursor: pointer; display: inline-block; margin-right: 8px;
  transition: background 0.13s; text-align: center;
}
.file-label:hover { background: #d2e3da; color: #184c37; border-color: #89ac98; }
.file-input { display: none; }

.switch-btn {
  min-width: 135px; background: #e1ece6; color: #247467;
  border: 1.2px solid #b0c9bb; border-radius: 10px; padding: 11px 18px;
  font-size: 15px; font-weight: 700; margin-left: 8px; cursor: pointer;
  transition: background 0.14s;
}
.switch-btn.on { background: #61ad80; color: #fff; border-color: #38885b; }

.reset-btn {
  min-width: 72px; margin-left: 8px; background: #f5c8c8; color: #ad2c2c;
  border: 1.2px solid #f3d1d1; font-weight: 500; transition: background 0.12s, color 0.13s;
  padding: 11px 14px; font-size: 14px; border-radius: 10px;
}
.reset-btn:hover { background: #f3b0b0; color: #8a2525; border-color: #e2b1b1; }

.check-row {
  display: flex; align-items: center; gap: 18px; margin: 7px 0 18px 0; font-size: 15px;
}
.check-row input[type="checkbox"] {
  accent-color: #2a6e52; width: 19px; height: 19px;
  vertical-align: middle; margin-right: 5px; margin-top: 1.5px;
}

/* ê²€ìƒ‰ë°” ìŠ¤íƒ€ì¼ ì¶”ê°€ */
.search-bar-wrap {
    width: 100%;
    margin-bottom: 12px;
    position: relative;
}
.search-input {
    width: 100%;
    padding: 12px 15px;
    font-size: 15px;
    border: 1.2px solid #b0c9bb;
    border-radius: 10px;
    box-sizing: border-box;
    background: #fbfdfc;
    color: #163326;
}
.search-input:focus {
    outline: none;
    border-color: #5cb88a;
    background: #fff;
    box-shadow: 0 0 0 3px rgba(92, 184, 138, 0.1);
}
.search-input::placeholder {
    color: #9ab0a5;
}

/* ì¼ê´„ í’ˆì ˆ ì…ë ¥ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
.bulk-input-area {
  margin: 15px 0;
  padding: 12px;
  background: #f5fbf8;
  border: 1px solid #dbece5;
  border-radius: 10px;
}
.bulk-input-title {
  font-size: 13px; font-weight: 700; color: #2c6e58; margin-bottom: 6px;
}
.bulk-input-row {
  display: flex; gap: 6px;
}
.bulk-input {
  flex: 1; padding: 8px 10px; border: 1px solid #b0c9bb; border-radius: 6px;
  font-size: 13px;
}
.bulk-btn {
  padding: 8px 12px; background: #4a9c80; color: #fff; font-weight: 600;
  border: none; border-radius: 6px; cursor: pointer; font-size: 13px;
}
.bulk-btn:hover { background: #3a826a; }


/* --- 3. ê´€ë¦¬ì½”ë“œ ë²„íŠ¼ (1ë‹¨) --- */
#codeBtnArea {
  margin-top: 15px; margin-bottom: 8px;
  display: flex; flex-wrap: wrap; gap: 12px 16px;
}
.code-btn {
  min-width: 128px; max-width: 220px; background: #e1ece6;
  border: 1.2px solid #b0c9bb; border-radius: 13px; font-size: 15px;
  font-weight: 700; color: #255c43; padding: 11px 12px; margin: 0;
  cursor: pointer; transition: background 0.13s, color 0.13s, border 0.13s, box-shadow 0.13s;
  outline: none; box-shadow: 0 1px 3px rgba(60,90,60,0.03);
  text-align: center; word-break: keep-all; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap; letter-spacing: 0.01em;
}
/* ìƒíƒœ: ê°œë³„ í’ˆì ˆ/ë‹¨ì¢… ìˆìŒ */
.code-btn.has-soldout {
  background: #73bc98 !important; color: #fff !important; border-color: #5cb88a;
  filter: brightness(0.98); border-style: dashed;
}
/* ìƒíƒœ: ì „ì²´ í’ˆì ˆ */
.code-btn.is-soldout-all {
  background: #73bc98 !important; color: #fff !important; border-color: #5cb88a;
}
/* ìƒíƒœ: ì „ì²´ ë‹¨ì¢… */
.code-btn.is-discont-all {
  background: #856ed9 !important; color: #fff !important; border-color: #533e8e;
}
/* ìƒíƒœ: í˜„ì¬ ì„ íƒë¨ (í™œì„±) */
.code-btn.selected {
  box-shadow: 0 0 0 3px #b5e9d6 inset !important;
  border-color: #4bc79f !important; border-width: 2px;
}
/* ìˆ¨ê¹€ ì²˜ë¦¬ìš© í´ë˜ìŠ¤ */
.hidden { display: none !important; }


/* --- 4. ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„ ë‚´ë¶€ (2ë‹¨) --- */
.context-area h2 {
  font-size: 1.5rem; color: #146f58; margin: 0 0 12px 0;
  word-break: break-all;
}
.context-area .section-title {
  margin-bottom: 10px; font-weight: 600; font-size: 14px;
  color: #2b7365; border-bottom: 1px solid #e0e0e0; padding-bottom: 6px;
}
.context-area .control-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  margin-bottom: 15px;
}
.context-area .control-grid .switch-btn {
  margin-left: 0; width: 100%; min-width: unset; padding: 14px 10px;
}

/* 2ë‹¨: ì˜µì…˜ ë²„íŠ¼ ê·¸ë¦¬ë“œ (í’ˆì ˆ ëª¨ë“œ) */
.option-btn-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  gap: 8px 10px;
  width: 100%;
  margin: 11px 0 6px 0;
}
.option-btn {
  display: inline-block; min-width: 46px; min-height: 28px;
  background: #e1ece6; border: 1.2px solid #b0c9bb; border-radius: 9px;
  font-size: 12px !important; font-weight: 500; color: #315e4d;
  padding: 8px 6px; margin: 0; cursor: pointer;
  transition: background 0.13s, color 0.13s;
  outline: none; text-align: center; box-sizing: border-box;
  word-break: break-all;
}
.option-btn.selected {
  background: #f3d8d8 !important; color: #b45454 !important;
  border-color: #e1bbbb; font-weight: 600;
}
.option-btn.discont {
  background: #533e8e !important; color: #fff !important;
  border-color: #6c4ff8; font-weight: 700;
}

/* 2ë‹¨: ì˜µì…˜ í¸ì§‘ í¼ (í¸ì§‘ ëª¨ë“œ) */
.edit-form-area {
  padding: 10px; border:1px solid #cfe3d8; border-radius:8px; margin-bottom:12px;
  background: #fcfefd;
}
.edit-form-area .form-title {
  font-size: 12px; color: #547a6b; margin-bottom: 8px; font-weight: 600;
}
.edit-form-area input[type="text"],
.edit-form-area input[type="number"] {
  flex: 1; padding: 6px 8px; font-size: 13px; border: 1px solid #b0c9bb;
  border-radius: 6px; box-sizing: border-box; width: 100%;
}
.edit-form-area input[type="text"]:disabled { background: #f0f0f0; }
.edit-form-area .input-row { display:flex; gap:6px; margin-bottom:6px; }
.edit-form-area .add-btn {
  width: 100%; padding: 8px; font-size: 14px; background: #2b7365;
  color: #fff; border: none; border-radius: 6px; cursor: pointer;
  font-weight: 600; margin-top: 4px;
}
.edit-form-area .form-help {
  margin-top: 8px; font-size: 11px; color: #7a8d84; line-height: 1.4;
}

/* 2ë‹¨: ì˜µì…˜ ëª©ë¡ (í¸ì§‘ ëª¨ë“œ) */
.option-list-container {
  display: flex; flex-direction: column; gap: 4px;
  max-height: 350px; overflow: auto;
  border: 1px solid #e0eee8; padding: 6px; border-radius: 8px;
}
.opt-file { border:1px solid #e3efe7; border-radius:10px; padding:10px; margin:4px 0; background:#fbfdfc; }
.opt-file__title { font-size:12px; color:#5b7e6f; font-weight:700; margin-bottom:6px; }
.opt-color { padding:8px 10px; border-radius:8px; background:#f5fbf8; border:1px solid #e0eee8; margin:6px 0; }
.opt-color__title { font-size:13px; color:#1f6e59; font-weight:700; margin-bottom:6px; }
.opt-sizes { display:flex; flex-wrap:wrap; gap:6px; }
.size-chip {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 8px; border-radius:999px;
  background:#e8f3ee; border:1px solid #cfe3d8; font-size:12px; color:#275c4a;
}
.size-chip__stock { font-style:normal; font-size:11px; opacity:.75; }
.size-chip.is-zero { background:#fdecec; border-color:#f3c9c9; color:#a43a3a; }
.opt-empty { color:#9aa8a2; font-size:12px; text-align:center; padding:12px 0; }

/* 2ë‹¨/3ë‹¨ ê³µí†µ ë‹«ê¸°/ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
.panel-close-btn {
  margin-top: 15px; background: #f8f3f3; border-radius: 8px;
  padding: 10px 0; border: 1.1px solid #eed1d1; font-size: 14px !important;
  color: #c34343; text-align: center; cursor: pointer; width: 100%;
  font-weight: 600; margin-bottom: 0;
}
.download-btn {
  margin-top: 24px; background: #e1ece6; color: #27624f; border: 1.2px solid #b0c9bb;
  border-radius: 11px; padding: 16px 22px; font-size: 17px; font-weight: 700;
  cursor: pointer; min-width: 240px; transition: background 0.13s, color 0.13s;
  display: block; width: 100%; box-sizing: border-box;
  box-shadow: 0 2px 14px rgba(120,180,120,0.09);
}
.download-btn:hover { background: #bce3c7; color: #155c3f; border-color: #5cb88a; }

/* --- 5. ë°˜ì‘í˜• --- */
@media (max-width: 1500px) {
  .container { flex-direction: column; max-width: 99vw; padding: 22px 3vw; }
  .main-area, .context-area, .side-area {
    min-width: unset; width: 90vw; max-width: 800px;
    margin: 0 auto;
    position: static; height: auto; max-height: unset;
  }
  .context-area { margin-top: 24px; }
  .side-area { margin-top: 24px; }
}
@media (max-width: 660px) {
  .main-title { font-size: 1.8rem; }
  .container { padding: 5vw 0; }
  .main-area, .context-area, .side-area { padding: 18px 4vw; width: 92vw; }
  .file-select-area { flex-wrap: wrap; }
  .code-btn { min-width: 92px; font-size: 13px; padding: 9px 7px; }
}
/* --- 6. ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ --- */
.modal-overlay {
  display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4); /* ë°°ê²½ ì–´ë‘¡ê²Œ */
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: #fff;
  padding: 28px;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.15);
  width: 400px;
  max-width: 90vw;
  text-align: left;
  position: relative;
  animation: modalFadeIn 0.2s ease-out;
}
@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.modal-header {
  font-size: 1.2rem; font-weight: 700; color: #184c37;
  margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 12px;
  display: flex; justify-content: space-between; align-items: center;
}
.modal-close-icon {
  cursor: pointer; font-size: 24px; color: #999; line-height: 1;
}
.modal-close-icon:hover { color: #333; }
.modal-row {
  margin-bottom: 16px;
}
.modal-btn-group {
  display: flex; gap: 8px; margin-top: 20px;
}
/* ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë©”ì¸ í™”ë©´ìš©) */
.manage-btn {
  background: #fff; border: 1.2px solid #b0c9bb; color: #246b5c;
  border-radius: 10px; padding: 11px 16px; font-size: 14px; font-weight: 600;
  cursor: pointer; margin-left: 8px; display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.13s;
}
.manage-btn:hover { background: #f1f8f5; border-color: #89ac98; }
/* [ì‹ ê·œ] ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ì˜ì—­ ìŠ¤íƒ€ì¼ */
.excel-paste-box {
  width: 100%; height: 60px;
  border: 2px dashed #b0c9bb; background: #fdfdfd;
  border-radius: 8px; padding: 10px; box-sizing: border-box;
  font-size: 13px; color: #555; margin-bottom: 10px;
  resize: vertical; transition: all 0.2s;
}
.excel-paste-box:focus {
  border-color: #2b7365; background: #fff; outline: none;
  height: 100px; /* í¬ì»¤ìŠ¤ ë˜ë©´ ì…ë ¥í•˜ê¸° ì¢‹ê²Œ ëŠ˜ì–´ë‚¨ */
}
.excel-paste-box::placeholder { color: #999; }
/* [ìˆ˜ì •] ë™ì  ì…ë ¥ì°½(í–‰ ë‹¨ìœ„) ìŠ¤íƒ€ì¼ */
.manual-add-area {
  background: #f1f6f4; border: 1px solid #dbece5; border-radius: 8px;
  padding: 12px; margin-bottom: 12px;
  display: flex; flex-direction: column; gap: 8px;
}
/* ìŠ¤í¬ë¡¤ ì˜ì—­ */
.manual-scroll-box {
  max-height: 200px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 6px; padding-right: 4px;
}
/* í•œ ì¤„(í–‰) ë ˆì´ì•„ì›ƒ */
.dynamic-row {
  display: flex; gap: 6px; align-items: center;
  animation: rowFadeIn 0.2s ease-out;
}
@keyframes rowFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* ì…ë ¥ì°½ ë””ìì¸ */
.d-input {
  border: 1px solid #b0c9bb; border-radius: 6px; padding: 9px 10px; font-size: 13px;
  transition: border 0.2s;
}
.d-input:focus { outline: none; border-color: #2b7365; box-shadow: 0 0 0 2px rgba(43,115,101,0.1); }
.d-code { flex: 1; min-width: 110px; } 
.d-opt  { flex: 1.8; } /* ì˜µì…˜ ì…ë ¥ì°½ì„ ë” ë„“ê²Œ */

/* ë‹¨ì¢… ë²„íŠ¼ */
.d-disc-btn {
  padding: 9px 12px; border: 1px solid #d1d5db; background: #fff; color: #666;
  border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;
}
.d-disc-btn:hover { background: #f3f4f6; }
.d-disc-btn.active { background: #856ed9; color: #fff; border-color: #7c3aed; }

/* ì‚­ì œ(X) ë²„íŠ¼ */
.d-del-btn { color: #9ca3af; cursor: pointer; padding: 4px 8px; font-size: 18px; }
.d-del-btn:hover { color: #ef4444; }
.d-del-btn.disabled { opacity: 0; pointer-events: none; }

.storage-list-area {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  background: #fafafa;
  height: 220px; /* ê³ ì • ë†’ì´ */
  overflow-y: auto; /* ìŠ¤í¬ë¡¤ ìƒì„± */
  margin-bottom: 15px;
}
/* [ìˆ˜ì •] ëª©ë¡ ì•„ì´í…œ ìŠ¤íƒ€ì¼ (ì²´í¬ë°•ìŠ¤, ìˆ˜ì •ë²„íŠ¼ ì¶”ê°€) */
.storage-ctrl-bar { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 6px; }
.storage-item { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 13.5px; background: #fff; transition: background 0.2s; }
.storage-item:hover { background: #f9fafb; }

/* ì²´í¬ë°•ìŠ¤ */
.item-chk { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; accent-color: #2b7365; }

/* ì •ë³´ ì˜ì—­ */
.item-info { flex: 1; display: flex; flex-direction: column; gap: 2px; cursor: pointer; } /* í´ë¦­ ì‹œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ í¬ì¸í„° */
.item-code { font-weight: 700; color: #333; font-size: 13px; }

/* ë²„íŠ¼ ê·¸ë£¹ (ìˆ˜ì •/ì‚­ì œ) */
.item-btns { display: flex; gap: 8px; align-items: center; }
.icon-btn { cursor: pointer; font-size: 14px; padding: 4px; color: #999; border-radius: 4px; transition: all 0.2s; }
.icon-btn:hover { background: #eee; color: #333; }
.icon-btn.del:hover { background: #fee2e2; color: #dc2626; }

/* ì„ íƒ ì‚­ì œ ë²„íŠ¼ */
.del-sel-btn { background: #fff; border: 1px solid #d1d5db; color: #555; padding: 4px 10px; font-size: 12px; border-radius: 6px; cursor: pointer; }
.del-sel-btn:hover { background: #f3f4f6; color: #111; }
.badge-sold { background: #ffeaea; color: #c53030; }
.badge-disc { background: #ede9fe; color: #6d28d9; }
.badge-mix  { background: #e1ece6; color: #246b5c; }

.delete-icon-btn {
  color: #ccc; cursor: pointer; padding: 4px; font-size: 16px; transition: color 0.2s;
}
.delete-icon-btn:hover { color: #ff4444; }
/* [ì‹ ê·œ] ë¶€ë¶„ ë‹¨ì¢…/í’ˆì ˆ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.badge-part-disc { background: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
.badge-part-sold { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
.badge-mixed     { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
/* [ì‹ ê·œ] ëª©ë¡ ë‚´ ìƒì„¸ ì˜µì…˜ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.opt-detail-wrap { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.opt-chip { 
  font-size: 11px; padding: 2px 6px; border-radius: 4px; border: 1px solid; display: inline-flex; align-items: center; gap: 4px;
}
.opt-chip.sold { background: #fff5f5; color: #c53030; border-color: #feb2b2; }
.opt-chip.disc { background: #faf5ff; color: #6b46c1; border-color: #e9d8fd; }
.opt-chip span { font-weight: 700; opacity: 0.7; font-size: 10px; }

/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
#toast {
  visibility: hidden;
  min-width: 250px;
  margin-left: -125px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 50px; /* ë‘¥ê¸€ê²Œ */
  padding: 16px;
  position: fixed;
  z-index: 3000; /* íŒì—…ë³´ë‹¤ ìœ„ì— */
  left: 50%;
  bottom: 30px;
  font-size: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  opacity: 0;
  transition: opacity 0.5s, bottom 0.5s;
}

#toast.show {
  visibility: visible;
  opacity: 1;
  bottom: 50px; /* ì‚´ì§ ìœ„ë¡œ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
}
  </style>
</head>
<body>

  <div class="container">

    <div class="main-area">
      <button class="back-btn" onclick="location.href='https://easyhara.github.io/smartstore_options/smartstore_options.html'">
        &larr; ì˜µì…˜ ìë™ ìƒì„±ê¸°ë¡œ ëŒì•„ê°€ê¸°
      </button>
      <div class="main-title-wrap">
        <h1 class="main-title">ê´€ë¦¬ì½”ë“œë³„ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ í’ˆì ˆíˆ´</h1>
      </div>
      <div style="margin-bottom:12px; font-size:15.5px; line-height:1.54;">
        ì—¬ëŸ¬ ì˜µì…˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  <b style="color:#248960;">ê´€ë¦¬ì½”ë“œ</b>ë¥¼ í´ë¦­í•˜ë©´<br>
        ìš°ì¸¡ íŒ¨ë„ì—ì„œ <span style="color:#3c6844; font-weight:600;">ì „ì²´ í’ˆì ˆ, ê°œë³„ í’ˆì ˆ/ë‹¨ì¢…</span>ì„ ì„ íƒí•˜ê±°ë‚˜ ì˜µì…˜ì„ í¸ì§‘í•©ë‹ˆë‹¤.<br>
        <span style="color:#c63737;">
        ì¬ê³ ê°€ 0ì¸ ì˜µì…˜ì€ ìë™ìœ¼ë¡œ í’ˆì ˆ ìƒíƒœë¡œ ì²´í¬ë©ë‹ˆë‹¤.
        </span>
      </div>

      <div class="file-select-area" id="fileDropZone">
        <label class="file-label">
          ì—‘ì…€íŒŒì¼ì„ íƒ
          <input type="file" id="inputFiles" class="file-input" multiple accept=".xls,.xlsx">
        </label>
        <span id="fileNames" style="font-size:15px;max-width:300px;overflow:hidden;white-space:nowrap;"></span>
        <span id="fileCount" style="font-size:14px;color:#1b8863;margin-left:7px;"></span>
        
        <button class="reset-btn" id="resetBtn">ì´ˆê¸°í™”</button>
        
        <button class="manage-btn" onclick="openModal()">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</button>
        
        <button class="manage-btn" onclick="applyFromBrowser()" title="ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ í’ˆì ˆ/ë‹¨ì¢… ë‚´ì—­ì„ í˜„ì¬ íŒŒì¼ì— ì¦‰ì‹œ ì ìš©í•©ë‹ˆë‹¤.">
          ğŸ“¥ ì €ì¥ê°’ ì ìš©
        </button>
      </div>

      <div class="file-select-area">
        <div id="modeSwitchGroup" style="display:flex; align-items:center; gap:6px; margin-left:8px;">
          <button class="switch-btn on" id="modeSoldoutBtn" title="í’ˆì ˆ/ë‹¨ì¢… ì„ íƒ ëª¨ë“œ">í’ˆì ˆ/ë‹¨ì¢… ëª¨ë“œ</button>
          <button class="switch-btn" id="modeEditBtn" title="ì˜µì…˜ ì¶”ê°€/ì‚­ì œ ëª¨ë“œ">ì˜µì…˜ í¸ì§‘ ëª¨ë“œ</button>
        </div>
        <button class="switch-btn" id="setAll99999Btn" title="ëª¨ë“  í–‰ ì¬ê³ ë¥¼ 99999ë¡œ ì„¤ì • ë° í’ˆì ˆ í•´ì œ">ëª¨ë‘ 99999</button>
      </div>

      <div class="check-row">
        <label>
          <input type="checkbox" id="fillStockCheckbox" checked>
          í’ˆì ˆ ì™¸ ì¬ê³  99999
        </label>
        <span id="prodCountInfo" style="font-size:15.2px;color:#3b7c53;"></span>
      </div>
      
      <div class="search-bar-wrap">
        <input type="text" id="codeSearchInput" class="search-input" placeholder="ê´€ë¦¬ì½”ë“œ ê²€ìƒ‰ (ì¼ë¶€ ì…ë ¥ ê°€ëŠ¥)...">
      </div>

      <div id="codeBtnArea"></div>
    </div>

    <div class="context-area" id="contextArea">
      <div class="context-placeholder">
        &larr; ì™¼ìª½ì—ì„œ ê´€ë¦¬ì½”ë“œë¥¼ ì„ íƒí•˜ë©´<br>ì´ê³³ì— ìƒì„¸ ì‘ì—… íŒ¨ë„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
      </div>
    </div>

    <div class="side-area">
      <h3>ì„ íƒëœ í’ˆì ˆ ì˜µì…˜</h3>
      <ul id="soldoutList">
        <li style="color:#b5b5b5;">(ì„ íƒë‚´ì—­ ì—†ìŒ)</li>
      </ul>
      <button class="download-btn" id="downloadBtn" disabled>ì„ íƒ í’ˆì ˆì²˜ë¦¬ & íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>

  </div>

  <script>
// === Global state (í•„ìˆ˜) ===
let fileList = [];
let fileDataArr = [];
let allRows = [];
let uniqueCodes = [];
let soldoutState = {};
let selectedCode = null;
let mode = 'soldout'; // 'soldout' | 'edit'

// === DOM Elements ===
const codeBtnArea = document.getElementById('codeBtnArea');
const contextArea = document.getElementById('contextArea');
const soldoutListUl = document.getElementById('soldoutList');
const downloadBtn = document.getElementById('downloadBtn');
const inputFilesElem = document.getElementById('inputFiles');
const fileNamesElem = document.getElementById('fileNames');
const fileCountElem = document.getElementById('fileCount');
const prodCountInfoElem = document.getElementById('prodCountInfo');
const modeSoldoutBtn = document.getElementById('modeSoldoutBtn');
const modeEditBtn = document.getElementById('modeEditBtn');
const codeSearchInput = document.getElementById('codeSearchInput'); // ê²€ìƒ‰ì°½

// === [ì‹ ê·œ] ê´€ë¦¬ì½”ë“œ ê²€ìƒ‰ ê¸°ëŠ¥ ===
codeSearchInput.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    const btns = codeBtnArea.getElementsByClassName('code-btn');
    Array.from(btns).forEach(btn => {
        const text = btn.textContent.toLowerCase();
        if (text.includes(query)) {
            btn.classList.remove('hidden');
        } else {
            btn.classList.add('hidden');
        }
    });
});

// [ì‹ ê·œ] ì˜¤íƒ€ ìë™ ìˆ˜ì • í•¨ìˆ˜ ("02 )" -> "02)")
function autoFixTypos(applyFix = false) {
  const targets = ['ì œí’ˆì„ íƒ', 'ì¶”ê°€ìƒí’ˆê°’'];
  const typoRe = /^(\s*\d+)\s+\)(.*)$/; // "ìˆ«ì + ê³µë°± + )" íŒ¨í„´ ê°ì§€
  let count = 0;
  const samples = [];

  allRows.forEach(r => {
    targets.forEach(key => {
      if (!r[key]) return;
      const val = String(r[key]);
      const match = val.match(typoRe);
      if (match) {
        // ê³µë°± ì œê±°í•˜ì—¬ í¬ë§· í†µì¼
        const fixedVal = `${match[1].trim()}) ${match[2].trim()}`;
        
        if (applyFix) {
          r[key] = fixedVal;
        }
        count++;
        if (samples.length < 3) {
          samples.push(`"${val}" â†’ "${fixedVal}"`);
        }
      }
    });
  });
  return { count, samples };
}

// [ìˆ˜ì •ë¨] ë‹¤ìš´ë¡œë“œ ì „ ë¦¬í¬íŠ¸ ìƒì„± (ì˜¤íƒ€ ê°ì§€ í¬í•¨)
function buildValidationReport() {
  // 1. ì˜¤íƒ€ ê²€ì‚¬ (ì ìš©ì€ ì•ˆ í•˜ê³  ì¹´ìš´íŠ¸ë§Œ)
  const typoReport = autoFixTypos(false);

  const r = {
    missingCode: [],
    parseFail: [],
    duplicates: [],
    mixedSizePattern: [],
    typoFixes: typoReport, // ì˜¤íƒ€ ë¦¬í¬íŠ¸ ì¶”ê°€
    totals: { rows: allRows.length }
  };
  const dupMap = new Map();
  const mixMap = new Map();
  const sizeSlashRe = /^([A-Za-z0-9]+)\s*\/\s*.+$/;
  allRows.forEach((row, i) => {
    const code = row['ê´€ë¦¬ì½”ë“œ'] || row['ìƒí’ˆì½”ë“œ'] || row['ì½”ë“œ'] || '';
    if (!code) r.missingCode.push(i);
    const { color, size } = extractColorAndSize(row);
    const label = (row['ì œí’ˆì„ íƒ'] || row['ì¶”ê°€ìƒí’ˆê°’'] || '').toString().trim();
    if (!color && !size && !label) r.parseFail.push(i);
    const k = `${row.file}||${code}||${color}||${size}`;
    if (!dupMap.has(k)) dupMap.set(k, { count: 0, samples: [] });
    const d = dupMap.get(k);
    d.count++;
    if (d.samples.length < 5) d.samples.push(i);
    const bucket = `${row.file}||${code}`;
    const v = (row['ì‚¬ì´ì¦ˆ'] ?? '').toString().trim();
    if (v) {
      if (!mixMap.has(bucket)) mixMap.set(bucket, { hasSlash: false, hasPlain: false });
      const cur = mixMap.get(bucket);
      if (sizeSlashRe.test(v)) cur.hasSlash = true; else cur.hasPlain = true;
    }
  });
  dupMap.forEach((v, key) => { if (v.count > 1) r.duplicates.push({ key, count: v.count, samples: v.samples }); });
  mixMap.forEach((v, bucket) => {
    if (v.hasSlash && v.hasPlain) {
      const [file, code] = bucket.split('||');
      r.mixedSizePattern.push({ file, code, detail: 'ì‚¬ì´ì¦ˆ ì—´ì— ì ‘ë¯¸ì‚¬ íŒ¨í„´ê³¼ ìˆœìˆ˜ê°’ì´ í˜¼ì¬' });
    }
  });
  
  // ì˜¤íƒ€ ì´ìŠˆë„ í•©ì‚°
  r.totals.issues =
    r.missingCode.length + r.parseFail.length + r.duplicates.length + r.mixedSizePattern.length + (typoReport.count > 0 ? 1 : 0);
  return r;
}
// [ìˆ˜ì •ë¨] ë¦¬í¬íŠ¸ ë©”ì‹œì§€ ì¶œë ¥ (ì˜¤íƒ€ ì•Œë¦¼ ì¶”ê°€)
function formatValidationSummary(report) {
  if (!report || !report.totals) return 'ê²€ì¦ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
  const lines = [];

  // ì˜¤íƒ€ ë°œê²¬ ì‹œ ìµœìƒë‹¨ì— ì•Œë¦¼
  if (report.typoFixes && report.typoFixes.count > 0) {
      lines.push(`âœ… [ìë™ë³´ì • ì•Œë¦¼] ì´ ${report.typoFixes.count}ê±´ì˜ ìˆœë²ˆ ì˜¤íƒ€("02 )")ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`);
      lines.push(`   ë‹¤ìš´ë¡œë“œ íŒŒì¼ì—ëŠ” "02)" í˜•íƒœë¡œ ìë™ ìˆ˜ì •ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.`);
      lines.push(`   (ì˜ˆì‹œ: ${report.typoFixes.samples[0]})`);
      lines.push('--------------------------------------------------');
  }

  lines.push(`ì´ í–‰: ${report.totals.rows.toLocaleString()}ê°œ`);
  lines.push(`- ê´€ë¦¬ì½”ë“œ ëˆ„ë½: ${report.missingCode.length}ê°œ`);
  lines.push(`- ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ íŒŒì‹± ì‹¤íŒ¨: ${report.parseFail.length}ê°œ`);
  lines.push(`- ì¤‘ë³µ ì˜µì…˜ í‚¤: ${report.duplicates.length}ê°œ ê·¸ë£¹`);
  lines.push(`- í˜¼ì¬ëœ ì‚¬ì´ì¦ˆ í‘œê¸°: ${report.mixedSizePattern.length}ê°œ ê·¸ë£¹`);
  if (report.duplicates.length) {
    const s = report.duplicates.slice(0, 3).map(d => {
      const [file, code, color, size] = d.key.split('||');
      return `  â€¢ (${d.count}íšŒ) [${file}] ${code} / ${color || '-'} / ${size || '-'}`;
    });
    lines.push('ì¤‘ë³µ ì˜ˆì‹œ:'); lines.push(...s);
  }
  if (report.mixedSizePattern.length) {
    const s = report.mixedSizePattern.slice(0, 3).map(m => `  â€¢ [${m.file}] ${m.code} â€” ${m.detail}`);
    lines.push('í˜¼ì¬ ì˜ˆì‹œ:'); lines.push(...s);
  }
  lines.push('');
  lines.push('ë‚´ë ¤ë°›ê¸°ë¥¼ ê³„ì†í•˜ì‹œê² ì–´ìš”?');
  return lines.join('\n');
}

// === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ===
function toSafeId(str) { return String(str).replace(/[^a-zA-Z0-9\-_:.]/g, '_'); }

// [ìµœì¢… ìˆ˜ì •] ì˜µì…˜ ì¶”ì¶œ (ì œí’ˆëª… / ìƒ‰ìƒ íŒ¨í„´ ì¸ì‹ ê¸°ëŠ¥ ì¶”ê°€)
function extractColorAndSize(row) {
  let color = '';
  let size = '';
  
  const keys = Object.keys(row);

  // 1. ëª…í™•í•œ ì»¬ëŸ¼(ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ, Color, Size, Option1...) ì°¾ê¸°
  const colorKey = keys.find(k => {
      const c = k.replace(/\s/g,'').toLowerCase();
      return (/ìƒ‰ìƒ|color|opt1|ì˜µì…˜1/i.test(c)) && !/ì‚¬ì´ì¦ˆ|size/i.test(c);
  });
  const sizeKey = keys.find(k => {
      const c = k.replace(/\s/g,'').toLowerCase();
      return /ì‚¬ì´ì¦ˆ|size|opt2|ì˜µì…˜2/i.test(c);
  });

  if (colorKey) color = String(row[colorKey] || '').trim();
  if (sizeKey) size = String(row[sizeKey] || '').trim();

  // 2. í†µí•© ì»¬ëŸ¼ ë¶„ì„ (ì˜µì…˜ëª…, í’ˆëª©, ì„ íƒ, ì œí’ˆì„ íƒ ë“±)
  if (!color && !size) {
      // 'ì œí’ˆì„ íƒ'ì´ í¬í•¨ë˜ë„ë¡ í‚¤ì›Œë“œ ë§¤ì¹­
      const mixKey = keys.find(k => /ì˜µì…˜|í’ˆëª©|ì„ íƒ|ì œí’ˆì„ íƒ|ì¶”ê°€ìƒí’ˆê°’|ìƒ‰ìƒ\/ì‚¬ì´ì¦ˆ/i.test(k.replace(/\s/g,'')));
      const mix = mixKey ? String(row[mixKey] || '').trim() : '';
      
      if (mix) {
          // [A] ê¸°í˜¸(_, /)ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ë‚˜ëˆ”
          // ì˜ˆ: "04 K2 ì•„ì´ìŠ¤ ê¸´íŒ”í‹°ì…”ì¸  / ë¸”ë™" -> parts=["04 K2...", "ë¸”ë™"]
          const parts = mix.split(/[\/_]/);

          if (parts.length > 1) {
              const lastPart = parts.pop().trim();       // ë’¤ìª½ (ì˜ˆ: ë¸”ë™ or 100)
              const frontPart = parts.join(' ').trim();  // ì•ìª½ (ì˜ˆ: ìƒí’ˆëª…)

              // â˜… [í•µì‹¬ ìˆ˜ì •] ë’¤ì— ìˆëŠ” ë‹¨ì–´ê°€ 'ì‚¬ì´ì¦ˆ'ì¸ì§€ í™•ì¸
              if (isSizeToken(lastPart)) {
                  // ë’¤ê°€ ì‚¬ì´ì¦ˆë©´ (ì˜ˆ: í‹°ì…”ì¸  / 100)
                  size = lastPart;
                  color = frontPart; 
              } else {
                  // ë’¤ê°€ ì‚¬ì´ì¦ˆê°€ ì•„ë‹ˆë©´ 'ìƒ‰ìƒ'ìœ¼ë¡œ ê°„ì£¼ (ì˜ˆ: í‹°ì…”ì¸  / ë¸”ë™)
                  color = lastPart;
                  // ì‚¬ì´ì¦ˆëŠ” ë¹„ì›Œë‘  (í•„ìš”í•˜ë‹¤ë©´ frontPartì—ì„œ ë‹¤ì‹œ ì°¾ì„ ìˆ˜ë„ ìˆìœ¼ë‚˜, ë³´í†µ ì´ ê²½ìš° ì‚¬ì´ì¦ˆ ì •ë³´ê°€ ì—†ëŠ” ê²ƒ)
              }
          } else {
              // [B] ê¸°í˜¸ê°€ ì—†ìœ¼ë©´(ê³µë°± êµ¬ë¶„): ë§¨ ë’¤ì— ìˆëŠ” "ìˆ«ì"ë‚˜ "ì˜ì–´ ì‚¬ì´ì¦ˆ"ë¥¼ ì°¾ìŒ
              const sizeRegex = /([0-9]{2,3}|[XSML]+|FREE)\s*$/i;
              const match = mix.match(sizeRegex);
              
              if (match) {
                  size = match[0].trim(); // "95"
                  color = mix.substring(0, match.index).trim(); // "ì•„ì´ìŠ¤í‹°ì…”ì¸  ë¸”ë™"
              } else {
                  // ì‚¬ì´ì¦ˆ íŒ¨í„´ë„ ì—†ìœ¼ë©´ í†µì§¸ë¡œ ì‚¬ì´ì¦ˆë¡œ ì·¨ê¸‰í–ˆì—ˆìœ¼ë‚˜, 
                  // í•œê¸€(ìƒ‰ìƒ)ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë¯€ë¡œ ë¬¸ë§¥ìƒ ìƒ‰ìƒìœ¼ë¡œ ë„£ëŠ”ê²Œ ì•ˆì „í•  ìˆ˜ ìˆìŒ.
                  // ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜, ë§Œì•½ 3ê¸€ì ì´ìƒì˜ í•œê¸€ì´ë¼ë©´ ìƒ‰ìƒìœ¼ë¡œ ëºŒ
                  if (/[ê°€-í£]{2,}/.test(mix) && !/[0-9]/.test(mix)) {
                      color = mix;
                  } else {
                      size = mix; 
                  }
              }
          }
      }
  }

  return { color, size };
}

// [ìˆ˜ì •] ì‚¬ì´ì¦ˆ ì¸ì‹ í•¨ìˆ˜ (ì‹ ë°œ ì‚¬ì´ì¦ˆ, mm ë‹¨ìœ„ í¬í•¨)
function isSizeToken(v) {
  // 1. ê°’ì—ì„œ ê³µë°± ì œê±° ë° ëŒ€ë¬¸ì ë³€í™˜
  let s = String(v || '').trim().toUpperCase();
  
  // 2. ë’¤ì— 'MM'ì´ ë¶™ì–´ìˆìœ¼ë©´ ì œê±° (ì˜ˆ: "230MM" -> "230")
  s = s.replace(/MM$/, '');

  // 3. ì •ê·œì‹ ê²€ì‚¬
  // FREE, S~XXL, 3XL~, ë˜ëŠ” ìˆ«ì 2~3ìë¦¬ (10~999)
  return /^(FREE|XS|S|M|L|XL|XXL|\d{1}XL|\d{2,3})$/i.test(s);
}
const SIZE_ORDER = ['FREE','XS','S','M','L','XL','XXL'];
function sizeKey(v){
  const u = String(v||'').toUpperCase().trim();
  const idx = SIZE_ORDER.indexOf(u);
  if (idx !== -1) return {t:0, v:idx};
  const n = parseInt(u,10);
  if (!Number.isNaN(n)) return {t:1, v:n};
  return {t:2, v:u};
}
function compareSize(a,b){
  const ka = sizeKey(a), kb = sizeKey(b);
  if (ka.t !== kb.t) return ka.t - kb.t;
  if (ka.v < kb.v) return -1;
  if (ka.v > kb.v) return 1;
  return 0;
}
function labelToTokens(rowOrLabel){
  const raw = typeof rowOrLabel === 'string'
    ? rowOrLabel
    : (rowOrLabel['ì œí’ˆì„ íƒ'] || rowOrLabel['ì¶”ê°€ìƒí’ˆê°’'] || '').toString();
  return raw.split('/').map(s => s.trim()).filter(Boolean);
}
function labelHasColorForCodeInFile(code, file){
  const rows = allRows.filter(r => r.file === file && r.ê´€ë¦¬ì½”ë“œ === code);
  const colorSetUpper = new Set(
    rows.map(r => (r['ìƒ‰ìƒ'] || extractColorAndSize(r).color || '')
          .toString().trim())
        .filter(Boolean)
        .map(c => c.toUpperCase())
  );
  if (colorSetUpper.size === 0) return false;
  return rows.some(r => {
    const toks = labelToTokens(r).map(t => t.toUpperCase());
    for (const C of colorSetUpper) if (toks.includes(C)) return true;
    return false;
  });
}
function buildLabelInsertColorAfterProductForCodeFile(code, file, tplRow, newColor){
  const tokens = labelToTokens(tplRow);
  const colorSetUpper = new Set(
    allRows
      .filter(r => r.file === file && r.ê´€ë¦¬ì½”ë“œ === code)
      .map(r => {
        let c = (r['ìƒ‰ìƒ'] || '').toString().trim();
        if (!c) {
          const ex = extractColorAndSize(r);
          c = ex.color || '';
        }
        return c;
      })
      .filter(Boolean)
      .map(c => c.toUpperCase())
  );
  const filtered = tokens.filter(t => {
    const T = t.toUpperCase();
    return !colorSetUpper.has(T) && !isSizeToken(t);
  });
  const out = [...filtered.slice(0,1), newColor, ...filtered.slice(1)];
  return out.filter(Boolean).join(' / ');
}
function replaceLastSizeTokenInLabel(labelStr, newSize){
  const tokens = labelStr.split('/').map(s => s.trim()).filter(Boolean);
  for (let i = tokens.length - 1; i >= 0; i--){
    if (isSizeToken(tokens[i])) { tokens[i] = newSize; return tokens.join(' / '); }
  }
  return [newSize, ...tokens].join(' / ');
}
function detectSizeDisplayPatternForCodeFile(code, file) {
  const rows = allRows.filter(r => r.file===file && r.ê´€ë¦¬ì½”ë“œ===code);
  for (const r of rows) {
    const v = (r['ì‚¬ì´ì¦ˆ'] ?? '').toString().trim();
    const m = v.match(/^([A-Za-z0-9]+)\s*\/\s*(.+)$/);
    if (m && isSizeToken(m[1])) {
      const suf = m[2].trim();
      return { column: 'ì‚¬ì´ì¦ˆ', suffix: suf, format: val => `${val} / ${suf}`, parse:  row => {
          const vv = (row['ì‚¬ì´ì¦ˆ'] ?? '').toString().trim();
          const mm = vv.match(/^([A-Za-z0-9]+)\s*\/\s*(.+)$/);
          return mm ? mm[1].trim() : vv;
        }
      };
    }
  }
  for (const r of rows) {
    const v = (r['ì‚¬ì´ì¦ˆ'] ?? '').toString().trim();
    if (v) {
      return { column: 'ì‚¬ì´ì¦ˆ', suffix: '', format: val => val, parse:  row => (row['ì‚¬ì´ì¦ˆ'] ?? '').toString().trim() };
    }
  }
  for (const r of rows) {
    const v = (r['ìƒ‰ìƒ'] ?? '').toString().trim();
    const m = v.match(/^([A-Za-z0-9]+)\s*\/\s*(.+)$/);
    if (m && isSizeToken(m[1])) {
      const suf = m[2].trim();
      return { column: 'ìƒ‰ìƒ', suffix: suf, format: val => `${val} / ${suf}`, parse:  row => {
          const vv = (row['ìƒ‰ìƒ'] ?? '').toString().trim();
          const mm = vv.match(/^([A-Za-z0-9]+)\s*\/\s*(.+)$/);
          return mm ? mm[1].trim() : '';
        }
      };
    }
  }
  return { column: null, suffix: '', format: v => v, parse: () => '' };
}
function rowHasColorWithPattern(row, color, pattern){
  const label = (row['ì œí’ˆì„ íƒ'] || row['ì¶”ê°€ìƒí’ˆê°’'] || '').toString();
  const tokens = label.split('/').map(s=>s.trim());
  if (tokens.some(t => t === color)) return true;
  if (pattern.column !== 'ìƒ‰ìƒ') {
    const ccol = (row['ìƒ‰ìƒ'] ?? '').toString().trim();
    if (ccol && ccol === color) return true;
  }
  return false;
}
function reorderColorBlock(file, code, color, pattern){
  const list = [];
  for (let i=0;i<allRows.length;i++){
    const r = allRows[i];
    if (r.file===file && r.ê´€ë¦¬ì½”ë“œ===code && rowHasColorWithPattern(r, color, pattern)){
      list.push({idx:i, row:r});
    }
  }
  if (list.length <= 1) return;
  const baseStart = Math.min(...list.map(o=>o.idx));
  const sortedRows = list.map(o=>o.row).sort((a,b)=>{
    const sa = pattern.parse(a);
    const sb = pattern.parse(b);
    return compareSize(sa, sb);
  });
  const removeIdx = new Set(list.map(o=>o.idx));
  const kept = [];
  for (let i=0;i<allRows.length;i++){
    if (!removeIdx.has(i)) kept.push(allRows[i]);
  }
  kept.splice(baseStart, 0, ...sortedRows);
  allRows = kept;
}
function cssEscapeId(raw) { return String(raw).replace(/([ #;?%&,.+*~\':"!^$[\]()=>|\/@])/g, '\\$1'); }
function getCodeKey(row) {
  const norm = s => String(s).replace(/\s/g, '').toLowerCase();
  const keys = Object.keys(row || {});
  const find = want => keys.find(k => norm(k) === norm(want));
  return find('ê´€ë¦¬ì½”ë“œ') || find('ìƒí’ˆì½”ë“œ') || find('ì½”ë“œ') || null;
}
function rowsByCode(code) {
  const target = normCode(code);
  return allRows.filter(r => (
    normCode(r['ê´€ë¦¬ì½”ë“œ']) === target ||
    normCode(r['ìƒí’ˆì½”ë“œ']) === target ||
    normCode(r['ì½”ë“œ'])       === target
  ));
}
function makeDiscontCode(origin) {
  let base = String(origin || '').replace(/^(ë‹¨ì¢…\s*)+/g, '').trim();
  let out = 'ë‹¨ì¢… ' + base;
  if (out.length > 20) {
    const compact = out.replace(/\s+/g, '');
    out = 'ë‹¨ì¢…' + compact.slice(2);
    if (out.length > 20) out = out.slice(0, 20);
  }
  return out;
}
function findLastIndex(arr, pred){
  for (let i = arr.length - 1; i >= 0; i--) if (pred(arr[i], i, arr)) return i;
  return -1;
}
function normCode(s) { return String(s ?? '').replace(/\s+/g, '').toUpperCase(); }

// === [ì‹ ê·œ] ìˆœë²ˆ ì¬ì •ë ¬ ìœ í‹¸ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ===
function getLabelKey(row){
  if (Object.prototype.hasOwnProperty.call(row, 'ì œí’ˆì„ íƒ')) return 'ì œí’ˆì„ íƒ';
  if (Object.prototype.hasOwnProperty.call(row, 'ì¶”ê°€ìƒí’ˆê°’')) return 'ì¶”ê°€ìƒí’ˆê°’';
  return null;
}
// [ìˆ˜ì •ë¨] ê´„í˜¸ ì• ê³µë°±(\s*) í—ˆìš©í•˜ë„ë¡ ì •ê·œì‹ ë³€ê²½
function hasSeqPrefix(label){ return /^\s*\d+\s*\)\s*/.test(String(label||'')); }

function stripSeqPrefix(label){ return String(label||'').replace(/^\s*\d+\s*\)\s*/, ''); }

function detectSeqWidthInFile(file){
  let width = 2;
  for (const r of allRows){
    if (r.file !== file) continue;
    const key = getLabelKey(r); if (!key) continue;
    // ì—¬ê¸°ë„ ì •ê·œì‹ ë³€ê²½
    const m = String(r[key]||'').match(/^\s*(\d+)\s*\)/); 
    if (m) width = Math.max(width, m[1].length);
  }
  return width;
}
function padSeq(n, width){
  const s = String(n);
  return s.length >= width ? s : '0'.repeat(width - s.length) + s;
}
function renumberProductPrefixesPerFile(file){
  const width = detectSeqWidthInFile(file);
  const firstIdxByCode = new Map();
  for (let i=0; i<allRows.length; i++){
    const r = allRows[i];
    if (r.file !== file) continue;
    const key = getLabelKey(r); if (!key) continue;
    const label = r[key];
    if (!hasSeqPrefix(label)) continue;
    const code = r['ê´€ë¦¬ì½”ë“œ'] || r['ìƒí’ˆì½”ë“œ'] || r['ì½”ë“œ'] || '';
    if (code && !firstIdxByCode.has(code)) firstIdxByCode.set(code, i);
  }
  const orderedCodes = Array.from(firstIdxByCode.entries())
    .sort((a,b)=>a[1]-b[1])
    .map(([c])=>c);
  orderedCodes.forEach((code, idx)=>{
    const seq = padSeq(idx+1, width);
    for (const r of allRows){
      if (r.file !== file) continue;
      const c = r['ê´€ë¦¬ì½”ë“œ'] || r['ìƒí’ˆì½”ë“œ'] || r['ì½”ë“œ'] || '';
      if (c !== code) continue;
      const key = getLabelKey(r); if (!key) continue;
      const label = r[key];
      if (!hasSeqPrefix(label)) continue;
      const rest = stripSeqPrefix(label);
      r[key] = `${seq}) ${rest}`;
    }
  });
}
function renumberAllFiles(){
  const files = Array.from(new Set(allRows.map(r=>r.file)));
  files.forEach(renumberProductPrefixesPerFile);
}

// === ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ===
inputFilesElem.addEventListener('change', async function(e) { await handleFiles(e.target.files); });
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('setAll99999Btn').addEventListener('click', setAllStock99999);
modeSoldoutBtn.addEventListener('click', () => setMode('soldout'));
modeEditBtn.addEventListener('click', () => setMode('edit'));
downloadBtn.addEventListener('click', downloadFiles);

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
const fileDropZone = document.getElementById('fileDropZone');
fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); fileDropZone.classList.add('dragover'); });
fileDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); fileDropZone.classList.remove('dragover'); });
fileDropZone.addEventListener('drop', (e) => {
  e.preventDefault(); e.stopPropagation();
  fileDropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    handleFiles(e.dataTransfer.files);
  }
});

// ë°”ë”” í´ë¦­ (íŒ¨ë„ ë‹«ê¸°)
document.body.onclick = function(e) {
  // í´ë¦­ëœ ìš”ì†Œê°€ 3ê°œ íŒ¨ë„ ì¤‘ í•˜ë‚˜ì˜ ìì†ì¸ì§€ í™•ì¸
  const isInsideMain = e.target.closest('.main-area');
  const isInsideContext = e.target.closest('.context-area');
  const isInsideSide = e.target.closest('.side-area');
  
  // ì„¸ íŒ¨ë„ ë°”ê¹¥ì˜ íšŒìƒ‰ body ì˜ì—­ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«í˜
  if (!isInsideMain && !isInsideContext && !isInsideSide) {
    if (selectedCode !== null) {
      selectedCode = null;
      updateCodeBtns();
      clearContextPanel();
    }
  }
};


// === í•µì‹¬ ë¡œì§: íŒŒì¼ ì²˜ë¦¬ ë° ë¦¬ì…‹ ===

function resetAll() {
  fileList = []; fileDataArr = []; allRows = []; uniqueCodes = []; soldoutState = {}; selectedCode = null;
  fileNamesElem.textContent = '';
  fileCountElem.textContent = '';
  inputFilesElem.value = '';
  prodCountInfoElem.textContent = '';
  codeBtnArea.innerHTML = '';
  codeSearchInput.value = ''; // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
  updateSoldoutList();
  clearContextPanel();
  downloadBtn.disabled = true;
  setMode('soldout');
}

async function handleFiles(filelist) {
  if (!filelist || filelist.length === 0) return;
  for (let file of filelist) {
    if (fileList.find(f=>f.name===file.name)) continue;
    fileList.push(file);
    let data = await readExcel(file);
    fileDataArr.push({name: file.name, data});
  }
  mergeAllRows();
  updateCodeBtns();
  updateProdCount();
  updateSoldoutList();
  let names = fileList.map(f=>f.name).join(', ');
  if (names.length > 45) {
    let split = names.split(',');
    let shown = split.slice(0,2).join(', ') + ' ...';
    fileNamesElem.textContent = shown;
  } else {
    fileNamesElem.textContent = names;
  }
  fileCountElem.textContent = fileList.length > 1 ? `+${fileList.length}ê°œ` : '';
  downloadBtn.disabled = false;
}

// [ìˆ˜ì •] ì—‘ì…€ íŒŒì¼ ì½ê¸° (í—¤ë” í–‰ ìë™ ì°¾ê¸° ê¸°ëŠ¥ ì¶”ê°€)
function readExcel(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      
      // 1. ë¨¼ì € 2ì°¨ì› ë°°ì—´ë¡œ ì½ì–´ì„œ 'ê´€ë¦¬ì½”ë“œ'ê°€ ìˆëŠ” í–‰(Row)ì„ ì°¾ìŠµë‹ˆë‹¤.
      const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
      let headerRowIndex = 0;
      
      // ìµœëŒ€ 10ë²ˆì§¸ ì¤„ê¹Œì§€ ë’¤ì ¸ì„œ "ê´€ë¦¬ì½”ë“œ"ë‚˜ "ìƒí’ˆì½”ë“œ"ê°€ ìˆëŠ”ì§€ í™•ì¸
      for (let i = 0; i < Math.min(rawData.length, 10); i++) {
        const row = rawData[i];
        // í–‰ ì•ˆì— 'ê´€ë¦¬ì½”ë“œ' ë˜ëŠ” 'ìƒí’ˆì½”ë“œ'ë¼ëŠ” ê¸€ìê°€ í¬í•¨ëœ ì…€ì´ ìˆëŠ”ì§€ ê²€ì‚¬
        const hasCodeHeader = row.some(cell => {
            const str = String(cell || '').replace(/\s+/g, ''); // ê³µë°±ì œê±° ë¹„êµ
            return str === 'ê´€ë¦¬ì½”ë“œ' || str === 'ìƒí’ˆì½”ë“œ' || str === 'ì½”ë“œ';
        });
        
        if (hasCodeHeader) {
          headerRowIndex = i; // ì´ ì¤„ì´ ì§„ì§œ í—¤ë”ë‹¤!
          break;
        }
      }
      
      // 2. ì°¾ì€ í—¤ë” í–‰ë¶€í„° ë‹¤ì‹œ JSONìœ¼ë¡œ ë³€í™˜
      // (defval: "" ì˜µì…˜ìœ¼ë¡œ ë¹ˆ ì…€ë„ ë¹ˆ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜´)
      let json = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex, defval: "" });
      resolve(json);
    };
    reader.readAsArrayBuffer(file);
  });
}

// [ë³µêµ¬] ë°ì´í„° ë³‘í•© (ë²ˆí˜¸ ë¶™ì´ê¸° ê¸°ëŠ¥ ì œê±° -> ì •ì„ëŒ€ë¡œ ì¤‘ë³µ ì²´í¬)
function mergeAllRows() {
  allRows = []; 
  let codeSet = new Set(); 
  soldoutState = {};
  const isAuto99999 = false; 

  for (let { name, data } of fileDataArr) {
    data.forEach(row => {
      const keys = Object.keys(row);
      // ê´€ë¦¬ì½”ë“œ, ìƒí’ˆì½”ë“œ, ì½”ë“œ ì¤‘ í•˜ë‚˜ë¥¼ ì°¾ìŒ
      const codeKey = keys.find(k => ['ê´€ë¦¬ì½”ë“œ','ìƒí’ˆì½”ë“œ','ì½”ë“œ'].includes(k.replace(/\s/g,'')));
      
      let c = codeKey ? String(row[codeKey]).trim() : '';
      let isDiscExcel = false;

      if (c.startsWith('ë‹¨ì¢…')) {
          isDiscExcel = true;
          c = c.replace(/^ë‹¨ì¢…\s*/, '');
      }

      // í–‰ ë°ì´í„° ìƒì„±
      let newRow = { ...row, file: name, ê´€ë¦¬ì½”ë“œ: c, _normCode: normCode(c) };

      // 99999 ìë™ ì ìš©
      if (isAuto99999 && !isDiscExcel) {
          newRow['ì¬ê³ ìˆ˜ëŸ‰'] = 99999;
      }

      allRows.push(newRow);
      
      if (c) {
          codeSet.add(c);
          if(isDiscExcel) {
              soldoutState[c] = { ì „ì²´: 'discont', ë³µí•©: [] };
          }
      }
    });
  }
  
  uniqueCodes = Array.from(codeSet);

  // (ì´í•˜ ì¬ê³  0 ìë™ í’ˆì ˆ ë¡œì§)
  uniqueCodes.forEach(code => {
    if (soldoutState[code]?.ì „ì²´ === 'discont') return; 

    const rows = rowsByCode(code); 
    if (!rows.length) return;

    let zeros = [];
    rows.forEach(r => {
      const stock = Number(r['ì¬ê³ ìˆ˜ëŸ‰']);
      if (isNaN(stock) || stock <= 0) {
        const { color, size } = extractColorAndSize(r);
        zeros.push({ ìƒ‰ìƒ: color, ì‚¬ì´ì¦ˆ: size, ìƒíƒœ: 'soldout' });
      }
    });

    if (zeros.length === rows.length && rows.length > 0) {
      soldoutState[code] = { ì „ì²´: 'soldout', ë³µí•©: [] };
    } else if (zeros.length > 0) {
      const uniq = []; const seen = new Set();
      zeros.forEach(z => { 
        // ì¤‘ë³µ ì œê±° (ì´ì œ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆê°€ ì •í™•íˆ ì½íˆë¯€ë¡œ ì •ìƒ ì‘ë™í•¨)
        const k = z.ìƒ‰ìƒ + '|' + z.ì‚¬ì´ì¦ˆ; 
        if (!seen.has(k)) { seen.add(k); uniq.push(z); }
      });
      soldoutState[code] = { ì „ì²´: false, ë³µí•©: uniq };
    }
  });
}

  // (ì´í•˜ ì¬ê³  0 ìë™ í’ˆì ˆ ë¡œì§ - ì´ë¯¸ ë‹¨ì¢…ì¸ ê±´ ê±´ë„ˆëœ€)
  uniqueCodes.forEach(code => {
    if (soldoutState[code]?.ì „ì²´ === 'discont') return; // ì´ë¯¸ ë‹¨ì¢…ì´ë©´ íŒ¨ìŠ¤

    const rows = rowsByCode(code); 
    if (!rows.length) return;

    let zeros = [];
    rows.forEach(r => {
      const stock = Number(r['ì¬ê³ ìˆ˜ëŸ‰']);
      if (isNaN(stock) || stock <= 0) {
        const { color, size } = extractColorAndSize(r);
        zeros.push({ ìƒ‰ìƒ: color, ì‚¬ì´ì¦ˆ: size, ìƒíƒœ: 'soldout' });
      }
    });

    if (zeros.length === rows.length && rows.length > 0) {
      soldoutState[code] = { ì „ì²´: 'soldout', ë³µí•©: [] };
    } else if (zeros.length > 0) {
      const uniq = []; const seen = new Set();
      zeros.forEach(z => { 
        const k = z.ìƒ‰ìƒ + '|' + z.ì‚¬ì´ì¦ˆ; 
        if (!seen.has(k)) { seen.add(k); uniq.push(z); }
      });
      soldoutState[code] = { ì „ì²´: false, ë³µí•©: uniq };
    }
  });

// [ìˆ˜ì •] 99999 ì„¤ì • (ë‹¨ì¢… ìœ ì§€ + í† ìŠ¤íŠ¸ ì•Œë¦¼)
function setAllStock99999() {
  if (!allRows.length) { alert('ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.'); return; }
  
  const ok = confirm(
    'ëª¨ë“  íŒŒì¼ì˜ ì¬ê³ ë¥¼ 99999ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.\n' +
    'ë‹¨, "ë‹¨ì¢…"ìœ¼ë¡œ ì„¤ì •ëœ í•­ëª©ì€ ìœ ì§€ë˜ê³  "í’ˆì ˆ" ìƒíƒœë§Œ í•´ì œë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
  );
  if (!ok) return;

  // 1. ë°ì´í„° ì¬ê³  ë³€ê²½
  for (const r of allRows) { r['ì¬ê³ ìˆ˜ëŸ‰'] = 99999; }
  
  const fillBox = document.getElementById('fillStockCheckbox');
  if (fillBox) fillBox.checked = false; 
  
  // 2. soldoutState ìƒíƒœ ì •ë¦¬ (í•µì‹¬: ë‹¨ì¢…ì€ ë‚¨ê¸°ê³  í’ˆì ˆë§Œ ì‚­ì œ)
  const newSoldoutState = {};

  for (const code of uniqueCodes) {
      // ì´ë¦„ ìì²´ê°€ 'ë‹¨ì¢…'ì¸ ê²½ìš°
      if (typeof code === 'string' && code.trim().startsWith('ë‹¨ì¢…')) {
          newSoldoutState[code] = { ì „ì²´: "discont", ë³µí•©: [] };
          continue;
      }

      const oldState = soldoutState[code];
      if (!oldState) continue;

      // ì „ì²´ ë‹¨ì¢…ì¸ ê²½ìš° ìœ ì§€
      if (oldState.ì „ì²´ === 'discont') {
          newSoldoutState[code] = oldState;
          continue;
      }

      // ë¶€ë¶„ ì˜µì…˜ ì¤‘ 'ë‹¨ì¢…'ì¸ ê²ƒë§Œ ìœ ì§€
      if (oldState.ë³µí•© && oldState.ë³µí•©.length > 0) {
          const keptOptions = oldState.ë³µí•©.filter(opt => opt.ìƒíƒœ === 'discont');
          if (keptOptions.length > 0) {
              newSoldoutState[code] = { ì „ì²´: false, ë³µí•©: keptOptions };
          }
      }
  }
  
  soldoutState = newSoldoutState;

  // 3. UI ê°±ì‹ 
  updateCodeBtns();
  updateSoldoutList();

  if (selectedCode) {
    renderContextPanel(selectedCode);
  }

  showToast('ì¬ê³  99999 ì„¤ì • ì™„ë£Œ (ë‹¨ì¢…ì€ ìœ ì§€ë¨)');
}

function setMode(newMode) {
  mode = newMode;
  if (mode === 'soldout') {
    modeSoldoutBtn.classList.add('on');
    modeEditBtn.classList.remove('on');
  } else {
    modeSoldoutBtn.classList.remove('on');
    modeEditBtn.classList.add('on');
  }
  // ëª¨ë“œ ë³€ê²½ ì‹œ ì„ íƒëœ ì½”ë“œ íŒ¨ë„ë„ ë‹¤ì‹œ ë Œë”ë§
  if (selectedCode) {
    renderContextPanel(selectedCode);
  } else {
    clearContextPanel();
  }
}

// === [ìˆ˜ì •] UI ë Œë”ë§ (1ë‹¨: ì½”ë“œ ë²„íŠ¼) ===

function updateCodeBtns() {
  codeBtnArea.innerHTML = '';
  // ê²€ìƒ‰ì–´ í•„í„° ì ìš©ì„ ìœ„í•´ í˜„ì¬ ê²€ìƒ‰ì–´ í™•ì¸
  const filterText = codeSearchInput ? codeSearchInput.value.toLowerCase().trim() : '';

  for (let code of uniqueCodes) {
    if (!code) continue;
    const btn = document.createElement('button');
    btn.id = 'codeBtn_' + toSafeId(code);
    btn.className = 'code-btn';

    // ê²€ìƒ‰ í•„í„° ì ìš©
    if (filterText && !code.toLowerCase().includes(filterText)) {
        btn.classList.add('hidden');
    }

    // ìƒíƒœ í´ë˜ìŠ¤ ì ìš©
    const state = soldoutState[code];
    if (state?.ì „ì²´ === "discont") {
      btn.classList.add('is-discont-all');
    } else if (state?.ì „ì²´ === "soldout") {
      btn.classList.add('is-soldout-all');
    } else if ((state?.ë³µí•© || []).length > 0) {
      btn.classList.add('has-soldout');
    }

    // í˜„ì¬ ì„ íƒëœ ë²„íŠ¼ (í™œì„±)
    if (selectedCode === code) {
      btn.classList.add('selected');
    }

    btn.textContent = code;
    
    // [ìˆ˜ì •] ë²„íŠ¼ í´ë¦­ ë¡œì§ ë‹¨ìˆœí™”
    btn.onclick = (e) => {
      e.stopPropagation();
      if (selectedCode === code) {
        // ì´ë¯¸ ì„ íƒëœ ë²„íŠ¼ ë‹¤ì‹œ í´ë¦­ -> ì„ íƒ í•´ì œ
        selectedCode = null;
        updateCodeBtns();
        clearContextPanel();
      } else {
        // ìƒˆ ë²„íŠ¼ í´ë¦­ -> ì„ íƒ
        selectedCode = code;
        updateCodeBtns(); // ë²„íŠ¼ ëª©ë¡ ê°±ì‹  (í•˜ì´ë¼ì´íŠ¸)
        renderContextPanel(code); // ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„ ë Œë”ë§
      }
    };
    codeBtnArea.appendChild(btn);
  }
}

// === [ì‹ ê·œ] UI ë Œë”ë§ (2ë‹¨: ì»¨í…ìŠ¤íŠ¸ íŒ¨ë„) ===

function clearContextPanel() {
  contextArea.innerHTML = `
    <div class="context-placeholder">
      &larr; ì™¼ìª½ì—ì„œ ê´€ë¦¬ì½”ë“œë¥¼ ì„ íƒí•˜ë©´<br>ì´ê³³ì— ìƒì„¸ ì‘ì—… íŒ¨ë„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
    </div>`;
  contextArea.style.borderColor = '#e8f0eb';
  contextArea.style.background = '#fdfdfd';
}

function closeContextPanel() {
  selectedCode = null;
  updateCodeBtns();
  clearContextPanel();
}

function renderContextPanel(code) {
  contextArea.innerHTML = ''; // Clear
  contextArea.style.borderColor = '#7ad4b3'; // Highlight panel
  contextArea.style.background = '#fff';

  if (mode === 'soldout') {
    renderSoldoutPanel(contextArea, code);
  } else {
    renderEditPanel(contextArea, code);
  }
}

// [ìˆ˜ì •] 2ë‹¨: í’ˆì ˆ ëª¨ë“œ íŒ¨ë„ ë Œë”ë§
function renderSoldoutPanel(container, code) {
  const st = soldoutState[code] || {};
  const isSold = st.ì „ì²´ === 'soldout';
  const isDisc = st.ì „ì²´ === 'discont';

  container.innerHTML = `
    <h2>${code}</h2>
    <div class="section-title">ì „ì²´ ì˜µì…˜ ì²˜ë¦¬</div>
    <div class="control-grid">
      <button class="switch-btn ${isSold?'on':''}" onclick="setAllSoldout('${code}')">ì „ì²´ í’ˆì ˆ</button>
      <button class="switch-btn ${isDisc?'on':''}" style="background:${isDisc?'#856ed9':''}; color:${isDisc?'#fff':''}" onclick="setAllDiscont('${code}')">ì „ì²´ ë‹¨ì¢…</button>
    </div>
    <div class="bulk-input-area">
      <div class="bulk-input-row">
        <input type="text" id="bulkInput_${toSafeId(code)}" class="bulk-input" placeholder="ì¼ê´„ í’ˆì ˆ (ì˜ˆ: 90, 95)">
        <button class="bulk-btn" onclick="processBulkSoldout('${code}')">ì ìš©</button>
      </div>
    </div>
    <div class="section-title">ê°œë³„ ì˜µì…˜ (í´ë¦­: í’ˆì ˆâ†’ë‹¨ì¢…â†’í•´ì œ)</div>
    <div class="option-btn-grid" id="optGrid_${toSafeId(code)}"></div>
    <button class="panel-close-btn" onclick="deleteCodeRows('${code}')">âš ï¸ ì´ ê´€ë¦¬ì½”ë“œ í–‰ ì „ì²´ ì‚­ì œ</button>
  `;

  const grid = document.getElementById(`optGrid_${toSafeId(code)}`);
  const rows = rowsByCode(code);
  let colors = new Set(), sizes = new Set();
  
  // ì´ì œ 3XLë„ ì‚¬ì´ì¦ˆë¡œ ì˜ ì¸ì‹í•´ì„œ ë“¤ì–´ì˜µë‹ˆë‹¤
  rows.forEach(r => { 
      const ex = extractColorAndSize(r); 
      if(ex.color) colors.add(String(ex.color).trim()); 
      if(ex.size) sizes.add(String(ex.size).trim()); 
  });
  
  const cArr = [...colors].filter(Boolean);
  const sArr = [...sizes].filter(Boolean).sort(compareSize);

  const createBtn = (c, s, lbl) => {
    const btn = document.createElement('button'); 
    btn.className = 'option-btn';
    btn.textContent = lbl; 
    
    const safeC = String(c || '').trim();
    const safeS = String(s || '').trim();
    btn.dataset.color = safeC;
    btn.dataset.size = safeS;
    btn.dataset.label = lbl;

    if (isSold) btn.classList.add('selected');
    else if (isDisc) btn.classList.add('discont');
    else {
      const match = (st.ë³µí•©||[]).find(x => {
          // 1. ì¡°í•© ë§¤ì¹­ (checkSizeMatch ì‚¬ìš©)
          if (x.ìƒ‰ìƒ && x.ì‚¬ì´ì¦ˆ) {
              return x.ìƒ‰ìƒ === safeC && checkSizeMatch(safeS, x.ì‚¬ì´ì¦ˆ);
          }
          // 2. í‚¤ì›Œë“œ ë§¤ì¹­ (checkSizeMatch ì‚¬ìš©)
          const keyword = x.ì‚¬ì´ì¦ˆ || x.ìƒ‰ìƒ;
          return (keyword === safeC || checkSizeMatch(safeS, keyword));
      });

      if (match?.ìƒíƒœ === 'soldout') btn.classList.add('selected');
      if (match?.ìƒíƒœ === 'discont') btn.classList.add('discont');
    }

    btn.onclick = (e) => {
        e.stopPropagation(); // ì°½ ë‹«í˜ ë°©ì§€
        toggleOptionState(code, safeC, safeS, e.target); 
    };
    grid.appendChild(btn);
  };

  if (cArr.length && sArr.length) cArr.forEach(c => sArr.forEach(s => createBtn(c, s, `${c} / ${s}`)));
  else if (cArr.length) cArr.forEach(c => createBtn(c, '', c));
  else if (sArr.length) sArr.forEach(s => createBtn('', s, s));
  else grid.innerHTML = '<div class="opt-empty" style="grid-column:1/-1;">ì˜µì…˜ ì—†ìŒ</div>';
}

// [ìˆ˜ì •] ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœ í† ê¸€ (í™”ë©´ ì¬ë Œë”ë§ ì—†ì´ ì¦‰ì‹œ ë°˜ì‘)
function toggleOptionState(code, c, s, btnElement) {
  const strC = String(c || '').trim();
  const strS = String(s || '').trim();

  soldoutState[code] = soldoutState[code] || { ì „ì²´: false, ë³µí•©: [] };
  
  // ì „ì²´ ì„¤ì •ì´ ë˜ì–´ìˆì—ˆë‹¤ë©´ í•´ì œ (ê°œë³„ ëª¨ë“œë¡œ ì „í™˜)
  if(soldoutState[code].ì „ì²´) {
      soldoutState[code].ì „ì²´ = false;
      // ì „ì²´ê°€ í•´ì œë˜ì—ˆìœ¼ë¯€ë¡œ í™”ë©´ì˜ ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™” í•„ìš” -> ì´ ê²½ìš°ì—” ì „ì²´ ë Œë”ë§
      renderSoldoutPanel(document.getElementById('contextArea'), code);
      return; 
  }
  
  const list = soldoutState[code].ë³µí•©;
  const idx = list.findIndex(o => String(o.ìƒ‰ìƒ||'').trim() === strC && String(o.ì‚¬ì´ì¦ˆ||'').trim() === strS);
  
  let newState = ''; // none, soldout, discont

  if(idx < 0) {
      list.push({ ìƒ‰ìƒ: strC, ì‚¬ì´ì¦ˆ: strS, ìƒíƒœ: 'soldout' });
      newState = 'soldout';
  } else if(list[idx].ìƒíƒœ === 'soldout') {
      list[idx].ìƒíƒœ = 'discont';
      newState = 'discont';
  } else {
      list.splice(idx, 1);
      newState = 'none';
  }
  
  // [í•µì‹¬] í™”ë©´ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³ , ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½ (ê¹œë¹¡ì„/ìŠ¤í¬ë¡¤íŠ ë°©ì§€)
  if (btnElement) {
      btnElement.classList.remove('selected', 'discont');
      if (newState === 'soldout') btnElement.classList.add('selected');
      if (newState === 'discont') btnElement.classList.add('discont');
  }

  checkAutoTotal(code); 
  updateCodeBtns();      // ì™¼ìª½ ì½”ë“œ ëª©ë¡ì˜ ë°°ì§€ëŠ” ê°±ì‹ 
  updateSoldoutList();   // ì˜¤ë¥¸ìª½ ìš”ì•½ ëª©ë¡ ê°±ì‹ 
}
// [ì‹ ê·œ] ì¼ê´„ í’ˆì ˆ ì²˜ë¦¬ ë¡œì§
function processBulkSoldout(code) {
    const inputEl = document.getElementById(`bulkInput_${toSafeId(code)}`);
    if (!inputEl) return;
    
    const rawVal = inputEl.value;
    if (!rawVal.trim()) {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 90, 95)");
        return;
    }

    const keywords = rawVal.split(',').map(s => s.trim()).filter(s => s);
    const grid = document.getElementById(`optionBtnGrid_${toSafeId(code)}`);
    if (!grid) return;

    const buttons = grid.getElementsByClassName('option-btn');
    let changedCount = 0;

    soldoutState[code] = soldoutState[code] || { ì „ì²´: false, ë³µí•©: [] };
    // ì „ì²´ ìƒíƒœì˜€ìœ¼ë©´ í•´ì œ
    if (soldoutState[code].ì „ì²´ === "soldout" || soldoutState[code].ì „ì²´ === "discont") {
        soldoutState[code].ì „ì²´ = false;
    }

    Array.from(buttons).forEach(btn => {
        const label = btn.textContent.toLowerCase();
        const color = btn.dataset.color;
        const size = btn.dataset.size;

        // í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í’ˆì ˆ ì²˜ë¦¬
        const matched = keywords.some(k => label.includes(k.toLowerCase()));
        
        if (matched) {
             // ì´ë¯¸ í’ˆì ˆ/ë‹¨ì¢… ìƒíƒœì¸ì§€ í™•ì¸
             const existingIdx = (soldoutState[code].ë³µí•© || []).findIndex(o => 
                (o.ìƒ‰ìƒ === color || (!color && !o.ìƒ‰ìƒ)) &&
                (o.ì‚¬ì´ì¦ˆ === size || (!size && !o.ì‚¬ì´ì¦ˆ))
             );
             
             // ìƒíƒœê°€ ì—†ê±°ë‚˜, ë‹¨ì¢…ì´ ì•„ë‹Œ ê²½ìš°ë§Œ 'í’ˆì ˆ'ë¡œ ì„¤ì • (ë‹¨ì¢…ì€ ìœ ì§€)
             if (existingIdx < 0) {
                 soldoutState[code].ë³µí•©.push(
                    color && size ? { ìƒ‰ìƒ: color, ì‚¬ì´ì¦ˆ: size, ìƒíƒœ: "soldout" }
                    : color ?       { ìƒ‰ìƒ: color, ìƒíƒœ: "soldout" }
                            :       { ì‚¬ì´ì¦ˆ: size, ìƒíƒœ: "soldout" }
                 );
                 changedCount++;
             } else if (soldoutState[code].ë³µí•©[existingIdx].ìƒíƒœ !== 'discont' && soldoutState[code].ë³µí•©[existingIdx].ìƒíƒœ !== 'soldout') {
                 // í˜¹ì‹œ ë‹¤ë¥¸ ìƒíƒœê°€ ìˆë‹¤ë©´ ê°±ì‹  (í˜„ì¬ ë¡œì§ìƒ ì´ëŸ´ ì¼ì€ ê±°ì˜ ì—†ìŒ)
                 soldoutState[code].ë³µí•©[existingIdx].ìƒíƒœ = "soldout";
                 changedCount++;
             }
        }
    });

    if (changedCount > 0) {
        checkAndAutoSetAllOptionState(code);
        updateSoldoutList();
        updateCodeBtns();
        renderSoldoutPanel(document.getElementById('contextArea'), code); // íŒ¨ë„ ê°±ì‹ 
        // ì…ë ¥ì°½ ê°’ ìœ ì§€
        setTimeout(() => {
            const newInput = document.getElementById(`bulkInput_${toSafeId(code)}`);
            if(newInput) { newInput.value = rawVal; newInput.focus(); }
        }, 50);
    } else {
        alert("ì¼ì¹˜í•˜ëŠ” ì˜µì…˜ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
}


// [ì‹ ê·œ] 2ë‹¨: í’ˆì ˆ ëª¨ë“œìš© í—¬í¼ í•¨ìˆ˜
function setAllSoldout(code) {
  soldoutState[code] = soldoutState[code] || { ì „ì²´: false, ë³µí•©: [] };
  if (soldoutState[code].ì „ì²´ === 'soldout') {
    soldoutState[code].ì „ì²´ = false; // Toggle off
  } else {
    soldoutState[code].ì „ì²´ = 'soldout'; // Set
    soldoutState[code].ë³µí•© = []; // Clear individuals
  }
  updateSoldoutList();
  updateCodeBtns();
  renderContextPanel(code); // Re-render panel
}

function setAllDiscont(code) {
  soldoutState[code] = soldoutState[code] || { ì „ì²´: false, ë³µí•©: [] };
  if (soldoutState[code].ì „ì²´ === 'discont') {
    soldoutState[code].ì „ì²´ = false; // Toggle off
  } else {
    soldoutState[code].ì „ì²´ = 'discont'; // Set
    soldoutState[code].ë³µí•© = []; // Clear individuals
  }
  updateSoldoutList();
  updateCodeBtns();
  renderContextPanel(code); // Re-render panel
}

// [ì‹ ê·œ] 2ë‹¨: í¸ì§‘ ëª¨ë“œ íŒ¨ë„ ë Œë”ë§
function renderEditPanel(container, code) {
  const rowsOnlyThisCode = rowsByCode(code);
  const template = rowsOnlyThisCode[0] || {};
  const hasSizeCol = Object.prototype.hasOwnProperty.call(template, 'ì‚¬ì´ì¦ˆ');

  const boxHTML = `
    <h2>${code}</h2>
    <div class="section-title">ìƒˆ ì˜µì…˜ ì¶”ê°€</div>
    
    <div class="edit-form-area">
      <div class="input-row">
        <input type="text" id="newColor_${code}" placeholder="ìƒ‰ìƒ">
        <input type="text" id="newSize_${code}" placeholder="${hasSizeCol ? 'ì‚¬ì´ì¦ˆ' : 'ì‚¬ì´ì¦ˆ ì—´ ì—†ìŒ'}"
               ${hasSizeCol ? '' : 'disabled'}>
      </div>
      <div class="input-row">
        <input type="number" id="newStock_${code}" placeholder="ì¬ê³ ìˆ˜ëŸ‰(ê¸°ë³¸: 99999)" value="99999">
      </div>
      <button id="addBtn_${code}" class="add-btn">
        + ì¶”ê°€
      </button>
      <div class="form-help">
        â€¢ ìƒ‰ìƒë§Œ ì…ë ¥ â†’ ëª¨ë“  ê¸°ì¡´ ì‚¬ì´ì¦ˆë¡œ ì¼ê´„ ì¶”ê°€<br>
        â€¢ ì‚¬ì´ì¦ˆë§Œ ì…ë ¥ â†’ ëª¨ë“  ê¸°ì¡´ ìƒ‰ìƒìœ¼ë¡œ ì¼ê´„ ì¶”ê°€<br>
        â€¢ ë‘˜ ë‹¤ ì…ë ¥ â†’ í•´ë‹¹ ì¡°í•© 1ê°œ ì¶”ê°€/ê°±ì‹ 
      </div>
    </div>

    <div class="section-title" style="margin-top: 20px;">í˜„ì¬ ì˜µì…˜ ëª©ë¡</div>
    <div id="optionList_${code}" class="option-list-container">
      ${renderOptionListHTML(code)}
    </div>

    <button class="reset-btn" style="width:100%; margin: 20px 0 10px 0;"
            onclick="event.stopPropagation(); deleteCodeRows('${code}')">
      âš ï¸ ì´ ê´€ë¦¬ì½”ë“œ í–‰ ì „ì²´ ì‚­ì œ
    </button>
    <button class="panel-close-btn" onclick="event.stopPropagation(); closeContextPanel()">
      ë‹«ê¸°
    </button>
  `;
  container.innerHTML = boxHTML;

  // ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  const addBtn = container.querySelector(`#addBtn_${cssEscapeId(code)}`) || container.querySelector(`#addBtn_${code}`);
  if (addBtn) {
    addBtn.onclick = (e) => {
      e.stopPropagation();
      addNewOption(code); // ì˜µì…˜ ì¶”ê°€ ë¡œì§ ì‹¤í–‰
      // addNewOptionì´ ë‚´ë¶€ì ìœ¼ë¡œ listElì„ ê°±ì‹ í•¨
    };
  }
}

// [ìˆ˜ì •] 2ë‹¨: í¸ì§‘ ëª¨ë“œ - ì˜µì…˜ ëª©ë¡ HTML ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
function renderOptionListHTML(code) {
  const rowsForCode = rowsByCode(code);
  if (!rowsForCode.length) return `<div class="opt-empty">ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

  const byFile = {};
  rowsForCode.forEach(r => {
    const ex = extractColorAndSize(r);
    const file = r.file;
    const color = (r['ìƒ‰ìƒ'] || ex.color || '').toString().trim() || '(ìƒ‰ìƒì—†ìŒ)';
    const size  = (r['ì‚¬ì´ì¦ˆ'] || ex.size  || '').toString().trim()  || '(ì‚¬ì´ì¦ˆì—†ìŒ)';
    const stock = r['ì¬ê³ ìˆ˜ëŸ‰'];
    byFile[file] ??= {};
    byFile[file][color] ??= [];
    byFile[file][color].push({ row: r, color, size, stock });
  });

  let html = '';
  Object.keys(byFile).sort().forEach(file => {
    html += `
      <div class="opt-file">
        <div class="opt-file__title">${file}</div>
      `;
    const byColor = byFile[file];
    Object.keys(byColor).sort((a,b)=>a.localeCompare(b,'ko')).forEach(color => {
      const list = byColor[color].sort((a,b)=>compareSize(a.size, b.size));
      html += `<div class="opt-color">
        <div class="opt-color__title">${color}</div>
        <div class="opt-sizes">`;
      list.forEach(item => {
        const zero = Number(item.stock) === 0;
        html += `
          <span class="size-chip ${zero ? 'is-zero' : ''}" title="ì¬ê³ : ${item.stock}">
            ${item.size}
            <em class="size-chip__stock">${item.stock}</em>
          </span>`;
      });
      html += `</div></div>`;
    });
    html += `</div>`;
  });
  if (!html) html = `<div class="opt-empty">ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  return html;
}

// === [ìˆ˜ì •] UI ë Œë”ë§ (3ë‹¨: ìš”ì•½ ë¦¬ìŠ¤íŠ¸) - ê·¸ë£¹í™” ì ìš© ===
function updateSoldoutList() {
  soldoutListUl.innerHTML = '';
  let any = false;

  for (let code of uniqueCodes) {
    const state = soldoutState[code];
    if (!state) continue;

    // 1. ì „ì²´ ë‹¨ì¢…ì¸ ê²½ìš°
    if (state.ì „ì²´ === "discont") {
      soldoutListUl.innerHTML += `
        <li class="side-group">
          <div class="side-group-title">
            ${code} <span class="badge-all-discont">ì „ì²´ë‹¨ì¢…</span>
          </div>
        </li>`;
      any = true;
    }
    // 2. ì „ì²´ í’ˆì ˆì¸ ê²½ìš°
    else if (state.ì „ì²´ === "soldout") {
      soldoutListUl.innerHTML += `
        <li class="side-group">
          <div class="side-group-title">
            ${code} <span class="badge-all-soldout">ì „ì²´í’ˆì ˆ</span>
          </div>
        </li>`;
      any = true;
    }
    // 3. ê°œë³„ ì˜µì…˜ì¸ ê²½ìš° (ê·¸ë£¹í™”)
    else if ((state.ë³µí•© || []).length > 0) {
      let groupHtml = `
        <li class="side-group">
          <div class="side-group-title">${code}</div>
          <ul class="side-sub-list">
      `;
      
      for (let opt of state.ë³µí•©) {
        let badge = opt.ìƒíƒœ === "discont" 
          ? '<span class="badge-state badge-discont">ë‹¨ì¢…</span>' 
          : '<span class="badge-state badge-soldout">í’ˆì ˆ</span>';
        
        let optName = `${opt.ìƒ‰ìƒ ? opt.ìƒ‰ìƒ + ' / ' : ''}${opt.ì‚¬ì´ì¦ˆ || ''}`;
        if (optName.endsWith(' / ')) optName = optName.slice(0, -3); // ì‚¬ì´ì¦ˆ ì—†ìœ¼ë©´ / ì œê±°

        groupHtml += `<li>${badge} ${optName}</li>`;
      }
      
      groupHtml += `</ul></li>`;
      soldoutListUl.innerHTML += groupHtml;
      any = true;
    }
  }
  
  if (!any) soldoutListUl.innerHTML = `<li style="color:#b5b5b5; padding:10px; text-align:center;">(ì„ íƒë‚´ì—­ ì—†ìŒ)</li>`;
}

// === [ìˆ˜ì •] í•µì‹¬ ë¡œì§ (ì˜µì…˜ ì¶”ê°€, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ) ===

// [ìˆ˜ì •] addNewOption: íŒì—… ëŒ€ì‹  íŒ¨ë„ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
function addNewOption(code) {
  const colorInput = document.getElementById(`newColor_${code}`).value.trim();
  const sizeInput  = document.getElementById(`newSize_${code}`)?.value.trim() || '';
  const stock      = parseInt(document.getElementById(`newStock_${code}`).value.trim(), 10) || 99999;
  if (!colorInput && !sizeInput) { alert("ìƒ‰ìƒ ë˜ëŠ” ì‚¬ì´ì¦ˆ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥í•˜ì„¸ìš”."); return; }

  const listForCode = rowsByCode(code);
  const filesForCode = Array.from(new Set(listForCode.map(r => r.file)));

  filesForCode.forEach(fileName => {
    const template = listForCode.find(r => r.file === fileName);
    if (!template) return;

    const pattern = detectSizeDisplayPatternForCodeFile(code, fileName);
    const useColorInLabel = labelHasColorForCodeInFile(code, fileName);
    const useSizeInLabel  = (() => {
      const tokens = labelToTokens(template);
      return tokens.some(isSizeToken);
    })();

    const colorsToUse = colorInput
      ? [colorInput]
      : (Array.from(new Set(
          allRows
            .filter(r => r.file === fileName && r.ê´€ë¦¬ì½”ë“œ === code)
            .map(r => r['ìƒ‰ìƒ'] || extractColorAndSize(r).color || '')
            .filter(Boolean)
        )) || ['']);

    let sizesToUse;
    if (sizeInput) sizesToUse = [sizeInput];
    else {
      const inFileRows = allRows.filter(r => r.file === fileName && r.ê´€ë¦¬ì½”ë“œ === code);
      const fromPattern = inFileRows.map(r => pattern.parse(r)).filter(Boolean);
      sizesToUse = fromPattern.length ? Array.from(new Set(fromPattern)) : [''];
    }
    sizesToUse = [...sizesToUse].sort(compareSize);

    colorsToUse.forEach(col => {
      sizesToUse.forEach(sz => {
        let labelValue = (template['ì œí’ˆì„ íƒ'] || template['ì¶”ê°€ìƒí’ˆê°’'] || '').toString();
        if (useColorInLabel && col) labelValue = buildLabelInsertColorAfterProductForCodeFile(code, fileName, template, col);
        if (useSizeInLabel && sz)  labelValue = replaceLastSizeTokenInLabel(labelValue, sz);

        const existIdx = allRows.findIndex(r => {
          if (r.file !== fileName || r.ê´€ë¦¬ì½”ë“œ !== code) return false;
          if (!rowHasColorWithPattern(r, col, pattern)) return false;
          const existingSize = pattern.parse(r);
          return (existingSize || '') === (sz || '');
        });

        if (existIdx >= 0) {
          const row = allRows[existIdx];
          row['ì¬ê³ ìˆ˜ëŸ‰'] = stock;
          if (pattern.column === 'ì‚¬ì´ì¦ˆ') {
            if ('ì‚¬ì´ì¦ˆ' in row) row['ì‚¬ì´ì¦ˆ'] = pattern.format(sz || '');
            if ('ìƒ‰ìƒ' in row && !useColorInLabel) row['ìƒ‰ìƒ'] = col || row['ìƒ‰ìƒ'];
          } else if (pattern.column === 'ìƒ‰ìƒ') {
            if ('ìƒ‰ìƒ' in row) row['ìƒ‰ìƒ'] = pattern.format(sz);
          }
          if ('ì œí’ˆì„ íƒ'    in row) row['ì œí’ˆì„ íƒ']    = labelValue;
          if ('ì¶”ê°€ìƒí’ˆê°’' in row) row['ì¶”ê°€ìƒí’ˆê°’'] = labelValue;
        } else {
          const newRow = { ...template };
          newRow['ê´€ë¦¬ì½”ë“œ'] = code;
          if ('ìƒí’ˆì½”ë“œ' in newRow) newRow['ìƒí’ˆì½”ë“œ'] = code;
          if ('ì½”ë“œ'      in newRow) newRow['ì½”ë“œ']      = code;
          newRow._normCode = normCode(code);
          newRow['ì¬ê³ ìˆ˜ëŸ‰'] = stock;
          newRow.file = fileName;

          if (pattern.column === 'ì‚¬ì´ì¦ˆ') {
            if ('ì‚¬ì´ì¦ˆ' in newRow) newRow['ì‚¬ì´ì¦ˆ'] = pattern.format(sz || '');
            if ('ìƒ‰ìƒ' in newRow && !useColorInLabel) newRow['ìƒ‰ìƒ'] = col || (newRow['ìƒ‰ìƒ'] || '');
          } else if (pattern.column === 'ìƒ‰ìƒ') {
            if ('ìƒ‰ìƒ' in newRow) newRow['ìƒ‰ìƒ'] = pattern.format(sz);
          }
          if ('ì œí’ˆì„ íƒ'    in newRow) newRow['ì œí’ˆì„ íƒ']    = labelValue;
          if ('ì¶”ê°€ìƒí’ˆê°’' in newRow) newRow['ì¶”ê°€ìƒí’ˆê°’'] = labelValue;

          const lastSameColorIdx = findLastIndex(allRows, r => {
            if (r.file !== fileName || r.ê´€ë¦¬ì½”ë“œ !== code) return false;
            return rowHasColorWithPattern(r, col, pattern);
          });
          const lastCodeIdx = findLastIndex(allRows, r => r.file === fileName && r.ê´€ë¦¬ì½”ë“œ === code);
          const insertAt = (lastSameColorIdx >= 0 ? lastSameColorIdx : lastCodeIdx) + 1;
          allRows.splice(insertAt, 0, newRow);
        }
      });
      reorderColorBlock(fileName, code, col, detectSizeDisplayPatternForCodeFile(code, fileName));
    });
  });

  // UI ê°±ì‹ 
  const listEl = document.getElementById(`optionList_${code}`);
  if (listEl) {
    listEl.innerHTML = renderOptionListHTML(code);
  }
  const cEl  = document.getElementById(`newColor_${code}`);
  const sEl  = document.getElementById(`newSize_${code}`);
  const stEl = document.getElementById(`newStock_${code}`);
  if (cEl) cEl.value = '';
  if (sEl) sEl.value = '';
  if (stEl) stEl.value = '99999';
}

// [ìˆ˜ì •] deleteCodeRows: íŒ¨ë„ ë‹«ê¸° ì¶”ê°€
function deleteCodeRows(code) {
  const target = normCode(code);
  const before = allRows.length;
  if (!confirm(`ê´€ë¦¬ì½”ë“œ "${code}"ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  í–‰ì„ ì‚­ì œí• ê¹Œìš”?\n\nâš ï¸ ë˜ëŒë¦¬ê¸°ëŠ” ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ë¶ˆê°€í•©ë‹ˆë‹¤.`)) {
    return;
  }

  allRows = allRows.filter(r => (
    normCode(r['ê´€ë¦¬ì½”ë“œ']) !== target &&
    normCode(r['ìƒí’ˆì½”ë“œ']) !== target &&
    normCode(r['ì½”ë“œ'])       !== target
  ));

  delete soldoutState[code];
  const set = new Set();
  allRows.forEach(r => {
    const c = r['ê´€ë¦¬ì½”ë“œ'] || r['ìƒí’ˆì½”ë“œ'] || r['ì½”ë“œ'] || '';
    if (c) set.add(c);
  });
  uniqueCodes = Array.from(set);

  renumberAllFiles();
  selectedCode = null;
  updateCodeBtns();    // [1ë‹¨] ê°±ì‹ 
  clearContextPanel(); // [2ë‹¨] ê°±ì‹ 
  updateProdCount();
  updateSoldoutList(); // [3ë‹¨] ê°±ì‹ 

  alert(`ì‚­ì œ ì™„ë£Œ: ${before - allRows.length}ê°œ í–‰`);
}

// [ìˆ˜ì •] checkAndAutoSetAllOptionState: UI ê°±ì‹  ë¡œì§ ì œê±° (ìƒìœ„ í˜¸ì¶œìê°€ ë‹´ë‹¹)
function checkAndAutoSetAllOptionState(code) {
  const rows = rowsByCode(code);
  const totalCnt = rows.length;
  let soldoutCnt = 0, discontCnt = 0;
  soldoutState[code] = soldoutState[code] || { ì „ì²´: false, ë³µí•©: [] };
  const isMatch = (opt, color, size) => {
    const oc = (opt.ìƒ‰ìƒ ?? '').trim();
    const os = (opt.ì‚¬ì´ì¦ˆ ?? '').trim();
    const rc = (color ?? '').trim();
    const rs = (size  ?? '').trim();
    const colorOK = (oc === '' || oc === rc);
    const sizeOK  = (os === '' || os === rs);
    return colorOK && sizeOK;
  };
  for (const r of rows) {
    const { color, size } = extractColorAndSize(r);
    const match = (soldoutState[code].ë³µí•© || []).find(o => isMatch(o, color, size));
    if (match) {
      if (match.ìƒíƒœ === 'discont') discontCnt++;
      else if (match.ìƒíƒœ === 'soldout') soldoutCnt++;
    }
  }
  if (totalCnt > 0 && discontCnt === totalCnt) {
    soldoutState[code].ì „ì²´ = 'discont';
    soldoutState[code].ë³µí•© = [];
  } else if (totalCnt > 0 && (soldoutCnt + discontCnt) === totalCnt) {
    soldoutState[code].ì „ì²´ = 'soldout';
    soldoutState[code].ë³µí•© = [];
  } else {
    soldoutState[code].ì „ì²´ = false;
  }
  // UI ê°±ì‹ ì€ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ê³³(ì˜ˆ: ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬)ì—ì„œ ìˆ˜í–‰
}

function updateProdCount() {
  prodCountInfoElem.textContent = uniqueCodes.length
    ? `ì´ ${uniqueCodes.length}ê°œ ê´€ë¦¬ì½”ë“œ` : '';
}





// [ìˆ˜ì •] ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬ (ë‹¨ì¢…/í’ˆì ˆ/í…ìŠ¤íŠ¸ ëª…í™•íˆ êµ¬ë¶„)
function handlePaste(text) {
  if (!text.trim()) return;

  const rows = text.trim().split(/[\n\r]+/);
  const container = document.getElementById('rowContainer');
  container.innerHTML = ''; 

  let processedCount = 0;

  rows.forEach(rowStr => {
    const cols = rowStr.split('\t'); 
    if (cols.length < 1 || !cols[0].trim()) return;

    const code = cols[0].trim();
    const optionRaw = cols[1] ? cols[1].trim() : '';
    
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    
    let isDisc = false;
    let finalOption = optionRaw;
    
    // ê³µë°± ì œê±° í›„ í‚¤ì›Œë“œ ë¹„êµ
    const cleanOpt = optionRaw.replace(/\s+/g, '');

    // 1. [ì „ì²´ ë‹¨ì¢…] ì •í™•íˆ 'ë‹¨ì¢…'ë§Œ ìˆì„ ë•Œ -> ë²„íŠ¼ ON
    if (cleanOpt === 'ë‹¨ì¢…') {
       isDisc = true;
       finalOption = ''; 
    }
    // 2. [ì „ì²´ í’ˆì ˆ] 'í’ˆì ˆ', 'ì „ì²´', 'ì „ëŸ‰' ë“± -> ë²„íŠ¼ OFF, ë‚´ìš© ë¹„ì›€(ì „ì²´í’ˆì ˆ)
    else if (['í’ˆì ˆ', 'ì „ì²´', 'ì „ì²´í’ˆì ˆ', 'ì „ëŸ‰', 'ì „ëŸ‰í’ˆì ˆ', 'ëª¨ë‘í’ˆì ˆ'].includes(cleanOpt)) {
       isDisc = false;
       finalOption = ''; 
    }
    // 3. [ë¶€ë¶„ ì˜µì…˜] 'ë‹¨ì¢… ë¸”ë™', '95', 'ë¸”ë£¨ ì œì™¸ ì „ëŸ‰' ë“± -> í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì…ë ¥
    else {
       isDisc = false;
       finalOption = optionRaw; 
    }

    div.innerHTML = `
      <input type="text" class="d-input d-code" value="${code}" placeholder="ì½”ë“œ">
      <input type="text" class="d-input d-opt" value="${finalOption}" placeholder="ì˜µì…˜ (ì˜ˆ: ë¹¨ê°•, ë‹¨ì¢… ë¸”ë™)" ${isDisc ? 'disabled style="background:#f3f4f6;"' : ''}>
      <button class="d-disc-btn ${isDisc ? 'active' : ''}" onclick="toggleDisc(this)">${isDisc ? 'ë‹¨ì¢…' : 'ë‹¨ì¢…'}</button>
      <div class="d-del-btn" onclick="removeRow(this)">&times;</div>
    `;

    const inputs = div.querySelectorAll('input');
    inputs.forEach(inp => {
      inp.addEventListener('input', function() { checkAndAddRow(this); });
      inp.addEventListener('keydown', function(e) { if(e.key === 'Enter') saveDynamicRows(); });
    });

    container.appendChild(div);
    processedCount++;
  });

  addDynamicRow();
  document.getElementById('excelPasteArea').value = '';
}

// 4. ìë™ ì¤„ ì¶”ê°€ ê°ì§€
function checkAndAddRow(input) {
  const row = input.closest('.dynamic-row');
  // ë§ˆì§€ë§‰ ì¤„ì— ê¸€ìë¥¼ ì“°ë©´ ìƒˆ ì¤„ ì¶”ê°€
  if(row === document.getElementById('rowContainer').lastElementChild && input.value.trim() !== '') {
    addDynamicRow();
  }
}

// 5. ë‹¨ì¢… ë²„íŠ¼ í† ê¸€
function toggleDisc(btn) {
  btn.classList.toggle('active');
  const row = btn.closest('.dynamic-row');
  const opt = row.querySelector('.d-opt');
  if(btn.classList.contains('active')) {
    opt.disabled = true; opt.placeholder = "(ì „ì²´ ë‹¨ì¢…)"; opt.style.backgroundColor = "#f3f4f6"; opt.value = '';
  } else {
    opt.disabled = false; opt.placeholder = "ì˜µì…˜ (ì˜ˆ: ë¹¨ê°•, 95)"; opt.style.backgroundColor = "#fff";
  }
}

// 6. ì¤„ ì‚­ì œ
function removeRow(btn) { btn.closest('.dynamic-row').remove(); }



function closeModal() {
  document.getElementById('dataModal').style.display = 'none';
}

// ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
  const modal = document.getElementById('dataModal');
  if (event.target == modal) {
    closeModal();
  }
  // (ê¸°ì¡´ body í´ë¦­ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ window.onclick ì‚¬ìš©)
}
// [ìµœì¢… ìˆ˜ì •] ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê´„í˜¸ ì‚¬ì´ì¦ˆ ë§¤ì¹­ ì ìš©)
async function downloadFiles() {
  const report = buildValidationReport();
  if (report.typoFixes && report.typoFixes.count > 0) autoFixTypos(true); 

  const msg = formatValidationSummary(report);
  if (report.totals.issues > 0) { if (!confirm(msg)) return; }

  const fillStock = document.getElementById('fillStockCheckbox').checked;
  if (typeof JSZip === 'undefined') { alert('JSZip ë¡œë“œ ì‹¤íŒ¨'); return; }
  
  const mainZip = new JSZip();

  const codeOptionCount = {};
  for (const row of allRows) {
    const code = row['ê´€ë¦¬ì½”ë“œ'] || row['ìƒí’ˆì½”ë“œ'] || row['ì½”ë“œ'] || '';
    if (!code) continue;
    codeOptionCount[code] ??= { total: 0, soldout: 0, discont: 0 };
    codeOptionCount[code].total++;
    
    const target = soldoutState[code];
    let isSoldout = false, isDiscont = false;
    
    if ((target?.ë³µí•© || []).length > 0) {
      const { color, size } = extractColorAndSize(row);
      for (const opt of target.ë³µí•©) {
        let match = false;
        
        // [ìˆ˜ì •ë¨] checkSizeMatch ì‚¬ìš©
        if (opt.ìƒ‰ìƒ && opt.ì‚¬ì´ì¦ˆ) {
            match = (opt.ìƒ‰ìƒ === color && checkSizeMatch(size, opt.ì‚¬ì´ì¦ˆ));
        } else {
            const keyword = opt.ì‚¬ì´ì¦ˆ || opt.ìƒ‰ìƒ;
            match = (color === keyword || checkSizeMatch(size, keyword));
        }

        if (match) {
          if (opt.ìƒíƒœ === 'discont') isDiscont = true;
          if (opt.ìƒíƒœ === 'soldout') isSoldout = true;
        }
      }
    }
    
    if (target?.ì „ì²´ === 'discont') isDiscont = true;
    else if (target?.ì „ì²´ === 'soldout') isSoldout = true;
    
    if (isDiscont) codeOptionCount[code].discont++;
    else if (isSoldout) codeOptionCount[code].soldout++;
  }

  for (const code in codeOptionCount) {
    const stat = codeOptionCount[code];
    if (stat.discont === stat.total) {
      soldoutState[code] ??= { ì „ì²´: false, ë³µí•©: [] };
      soldoutState[code].ì „ì²´ = 'discont';
      soldoutState[code].ë³µí•© = [];
    } else if (stat.soldout + stat.discont === stat.total) {
      soldoutState[code] ??= { ì „ì²´: false, ë³µí•©: [] };
      if (soldoutState[code].ì „ì²´ !== 'discont') {
        soldoutState[code].ì „ì²´ = 'soldout';
        soldoutState[code].ë³µí•© = [];
      }
    }
  }
  
  const rowsByFile = {};
  for (const r of allRows) {
    const fname = r.file || 'í¸ì§‘ì¶”ê°€.xlsx';
    (rowsByFile[fname] ??= []).push(r);
  }
  
  const fileNames = Object.keys(rowsByFile);
  let singleFileBlob = null;     
  let singleFileName = "";       
  
  for (const name of fileNames) {
    const data = rowsByFile[name].map(row => {
      const codeKey = getCodeKey(row);
      const code = codeKey ? row[codeKey] : '';
      const target = soldoutState[code];
      
      let isSoldout = false, isDiscont = false;

      if ((target?.ë³µí•© || []).length > 0) {
        const { color, size } = extractColorAndSize(row);
        for (const opt of target.ë³µí•©) {
           let match = false;
           // [ìˆ˜ì •ë¨] checkSizeMatch ì‚¬ìš©
           if (opt.ìƒ‰ìƒ && opt.ì‚¬ì´ì¦ˆ) {
               match = (opt.ìƒ‰ìƒ === color && checkSizeMatch(size, opt.ì‚¬ì´ì¦ˆ));
           } else {
               const keyword = opt.ì‚¬ì´ì¦ˆ || opt.ìƒ‰ìƒ;
               match = (color === keyword || checkSizeMatch(size, keyword));
           }

           if (match) {
             if (opt.ìƒíƒœ === 'discont') isDiscont = true;
             if (opt.ìƒíƒœ === 'soldout') isSoldout = true;
           }
        }
      }

      if (target?.ì „ì²´ === 'discont') isDiscont = true;
      else if (target?.ì „ì²´ === 'soldout') isSoldout = true;
      
      const rowCopy = { ...row };
      
      if (isDiscont) {
        if (codeKey && rowCopy[codeKey] && !String(rowCopy[codeKey]).trim().startsWith('ë‹¨ì¢…')) {
             rowCopy[codeKey] = 'ë‹¨ì¢… ' + rowCopy[codeKey];
        }
        rowCopy['ì¬ê³ ìˆ˜ëŸ‰'] = 0;
      } else if (isSoldout || String(code || '').trim().startsWith('ë‹¨ì¢…')) {
        rowCopy['ì¬ê³ ìˆ˜ëŸ‰'] = 0;
      } else if (fillStock && (!rowCopy['ì¬ê³ ìˆ˜ëŸ‰'] || rowCopy['ì¬ê³ ìˆ˜ëŸ‰'] == 0)) {
        rowCopy['ì¬ê³ ìˆ˜ëŸ‰'] = 99999;
      }
      
      delete rowCopy.file;
      delete rowCopy._normCode;
      return rowCopy;
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    const wbOut = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    
    const saveName = name.replace(/\.xls$/i, '.xlsx');
    mainZip.file(saveName, wbOut);
    
    if (fileNames.length === 1) {
        singleFileBlob = new Blob([wbOut], {type:"application/octet-stream"});
        singleFileName = saveName;
    }
  }
  
  if (fileNames.length === 1 && singleFileBlob) {
      saveAs(singleFileBlob, singleFileName);
  } else {
      const zipBlob = await mainZip.generateAsync({ type: 'blob' });
      saveAs(zipBlob, 'í’ˆì ˆì²˜ë¦¬_ì¼ê´„ë‹¤ìš´ë¡œë“œ.zip');
  }
  
  let finishMsg = "âœ… íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
  if(report.typoFixes && report.typoFixes.count > 0) {
      finishMsg += `\n(ì˜¤íƒ€ ${report.typoFixes.count}ê±´ì´ ìë™ ë³´ì •ë˜ì—ˆìŠµë‹ˆë‹¤)`;
  }
  showToast(finishMsg);
}
// === [ì‹ ê·œ] ë°ì´í„° ì˜êµ¬ ì €ì¥ ë° ìë™ ì ìš© ë¡œì§ ===

const STORAGE_KEY = "easyHara_soldout_data_v1"; // ì €ì¥ì†Œ í‚¤ ì´ë¦„

// [ìˆ˜ì •ë¨] ì €ì¥ê°’ ì ìš© (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì½”ë“œë§Œ ì ìš©)
function applyFromBrowser(isAuto = false) {
  if (uniqueCodes.length === 0) {
    if (!isAuto) alert("ì ìš©í•  ì—‘ì…€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
    return;
  }

  const savedJson = localStorage.getItem(STORAGE_KEY);
  if (!savedJson) {
    if (!isAuto) showToast("ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  try {
    const savedState = JSON.parse(savedJson);
    let appliedCount = 0;

    // [ë³€ê²½ ì‚¬í•­] í† í° ë¶„ë¦¬(tokenize) ë¡œì§ ì œê±° -> ì •í™•í•œ Key ë§¤ì¹­ìœ¼ë¡œ ë³€ê²½
    uniqueCodes.forEach(fileCode => {
      // ì—‘ì…€ì˜ ê´€ë¦¬ì½”ë“œ (ì–‘ì˜† ê³µë°±ë§Œ ì œê±°)
      const cleanCode = String(fileCode).trim();

      // ì €ì¥ëœ ë°ì´í„°ì— í•´ë‹¹ ì½”ë“œê°€ ì •í™•íˆ ìˆëŠ”ì§€ í™•ì¸
      // (ì˜ˆ: ì €ì¥ëœ ì½”ë“œê°€ "K2-001"ì´ê³  ì—‘ì…€ì´ "K2-001"ì´ì–´ì•¼ë§Œ í†µê³¼)
      if (savedState[cleanCode]) {
        soldoutState[fileCode] = savedState[cleanCode];
        appliedCount++;
      }
    });

    updateCodeBtns();
    updateSoldoutList();
    if (selectedCode) renderContextPanel(selectedCode);

    const msg = `ë¡œë“œ ì™„ë£Œ: ${appliedCount}ê°œ ì½”ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    const statusEl = document.getElementById('saveStatusMsg');
    if (statusEl) statusEl.textContent = msg;
    
    if (!isAuto) {
        if (appliedCount === 0) {
            showToast("ì¼ì¹˜í•˜ëŠ” ì½”ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        } else {
            showToast(msg);
        }
    }

  } catch (e) {
    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
    if (!isAuto) showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

// 3. ì €ì¥ëœ ë°ì´í„° ì‚­ì œ
function clearBrowserData() {
  if (!confirm("ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  í’ˆì ˆ/ë‹¨ì¢… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  localStorage.removeItem(STORAGE_KEY);
  document.getElementById('saveStatusMsg').textContent = "ğŸ—‘ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// [ì¤‘ìš”] íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜(handleFiles) ìˆ˜ì •
// ê¸°ì¡´ handleFiles í•¨ìˆ˜ ëë¶€ë¶„ì— ìë™ ì ìš© ë¡œì§ì„ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.
// ì•„ë˜ ì½”ë“œë¥¼ ê¸°ì¡´ handleFiles í•¨ìˆ˜ ë§ˆì§€ë§‰ ë¶€ë¶„(downloadBtn.disabled = false; ë‹¤ìŒ ì¤„)ì— ë®ì–´ì“°ê±°ë‚˜ ì¶”ê°€í•˜ì„¸ìš”.

/*
  (ê¸°ì¡´ handleFiles í•¨ìˆ˜ ë‚´ë¶€...)
  ...
  fileCountElem.textContent = fileList.length > 1 ? `+${fileList.length}ê°œ` : '';
  downloadBtn.disabled = false;
  
  // --- [ì¶”ê°€ëœ ë¶€ë¶„] ---
  const autoCheck = document.getElementById('autoApplyCheck');
  if (autoCheck && autoCheck.checked) {
    applyFromBrowser(true); // ìë™ìœ¼ë¡œ ì €ì¥ëœ ë‚´ì—­ ì ìš©
  }
  // -------------------
*/
// === [ì—…ë°ì´íŠ¸] ëª¨ë‹¬ ê´€ë ¨ ë¡œì§ ===

function openModal() {
  document.getElementById('dataModal').style.display = 'flex';
  document.getElementById('saveStatusMsg').textContent = '';
  refreshStorageList();
  initDynamicRows();
}

// [ìˆ˜ì •] ëª©ë¡ ê·¸ë¦¬ê¸° (ê²€ìƒ‰ í•„í„° ê¸°ëŠ¥ ì¶”ê°€)
function refreshStorageList(filterText = '') {
  const container = document.getElementById('storageListContainer');
  const countEl = document.getElementById('storageCount');
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){}
  
  container.innerHTML = '';
  
  // í‚¤(ê´€ë¦¬ì½”ë“œ) ê°€ì ¸ì˜¤ê¸°
  let keys = Object.keys(saved).sort();

  // [í•µì‹¬] ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ í•„í„°ë§
  if (filterText.trim() !== '') {
    const query = filterText.toLowerCase().trim();
    keys = keys.filter(key => key.toLowerCase().includes(query));
  }

  countEl.textContent = `${keys.length}ê°œ`;
  
  if(!keys.length) { 
    const msg = filterText ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    container.innerHTML = `<div style="padding:20px; text-align:center; color:#aaa; font-size:13px;">${msg}</div>`; 
    return; 
  }

  keys.forEach(code => {
    const item = saved[code];
    let contentHtml = '';

    // ë°°ì§€ ìƒì„± ë¡œì§
    if (item.ì „ì²´ === 'soldout') {
      contentHtml = '<span class="item-badge badge-sold">ì „ì²´í’ˆì ˆ</span>';
    } else if (item.ì „ì²´ === 'discont') {
      contentHtml = '<span class="item-badge badge-disc">ì „ì²´ë‹¨ì¢…</span>';
    } else if ((item.ë³µí•© || []).length > 0) {
      contentHtml = '<div class="opt-detail-wrap">';
      item.ë³µí•©.forEach(opt => {
        const isDisc = opt.ìƒíƒœ === 'discont';
        const cls = isDisc ? 'disc' : 'sold';
        const labelState = isDisc ? 'ë‹¨ì¢…' : 'í’ˆì ˆ';
        const name = (opt.ìƒ‰ìƒ && opt.ì‚¬ì´ì¦ˆ) ? `${opt.ìƒ‰ìƒ}-${opt.ì‚¬ì´ì¦ˆ}` : (opt.ì‚¬ì´ì¦ˆ || opt.ìƒ‰ìƒ);
        contentHtml += `<div class="opt-chip ${cls}">${name} <span>${labelState}</span></div>`;
      });
      contentHtml += '</div>';
    } else {
      contentHtml = '<span class="item-badge" style="background:#eee; color:#777;">ì„¤ì •ì—†ìŒ</span>';
    }

    const div = document.createElement('div');
    div.className = 'storage-item';
    
    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸ (ì„ íƒì‚¬í•­)
    const displayCode = filterText ? code.replace(new RegExp(filterText, 'gi'), match => `<span style="background:#fff7ed; color:#c2410c;">${match}</span>`) : code;

    div.innerHTML = `
      <div class="item-info" style="width:100%;" onclick="loadItemForEdit('${code}')" title="í´ë¦­í•´ì„œ ìˆ˜ì •í•˜ê¸°">
        <div class="item-code" style="margin-bottom:2px;">${displayCode}</div>
        <div>${contentHtml}</div>
      </div>
      <div class="delete-icon-btn" title="ì‚­ì œ" onclick="deleteSingleStorageItem('${code}')">
        &times;
      </div>
    `;
    container.appendChild(div);
  });
}

// [ì‹ ê·œ] ì„ íƒëœ í•­ëª© ì¼ê´„ ì‚­ì œ
function deleteSelectedItems() {
  const checkboxes = document.querySelectorAll('.item-chk:checked');
  if (checkboxes.length === 0) {
    alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm(`ì„ íƒí•œ ${checkboxes.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  
  checkboxes.forEach(chk => {
    delete saved[chk.value];
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
  refreshStorageList();
}

// [ì‹ ê·œ] ìˆ˜ì •í•˜ê¸° (ë°ì´í„°ë¥¼ ì…ë ¥ì°½ìœ¼ë¡œ ë¶ˆëŸ¬ì˜´)
function loadItemForEdit(code) {
  let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  const item = saved[code];
  if (!item) return;

  // 1. ì…ë ¥ì°½ ì´ˆê¸°í™” (ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê³  1ì¤„ë§Œ ë‚¨ê¹€)
  initDynamicRows();
  
  // 2. ì²« ë²ˆì§¸ ì¤„ ê°€ì ¸ì˜¤ê¸°
  const row = document.querySelector('.dynamic-row');
  const codeInput = row.querySelector('.d-code');
  const optInput = row.querySelector('.d-opt');
  const discBtn = row.querySelector('.d-disc-btn');

  // 3. ë°ì´í„° ì±„ì›Œë„£ê¸°
  codeInput.value = code; // ê´€ë¦¬ì½”ë“œ

  if (item.ì „ì²´ === 'discont') {
    // ì „ì²´ ë‹¨ì¢…ì¸ ê²½ìš°
    if (!discBtn.classList.contains('active')) toggleDisc(discBtn);
  } else if (item.ì „ì²´ === 'soldout') {
    // ì „ì²´ í’ˆì ˆì¸ ê²½ìš° (ì˜µì…˜ ë¹ˆì¹¸, ë²„íŠ¼ OFF)
    if (discBtn.classList.contains('active')) toggleDisc(discBtn);
    optInput.value = "";
  } else if (item.ë³µí•© && item.ë³µí•©.length > 0) {
    // ë¶€ë¶„ ì˜µì…˜ì¸ ê²½ìš° -> í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì…ë ¥ì°½ì— ë„£ìŒ
    // ì˜ˆ: [{ìƒ‰ìƒ:'ë¸”ë™', ì‚¬ì´ì¦ˆ:'95', ìƒíƒœ:'soldout'}] -> "ë¸”ë™-95"
    const textParts = item.ë³µí•©.map(opt => {
      let str = "";
      // ìƒ‰ìƒ-ì‚¬ì´ì¦ˆ ì¡°í•©ì¸ì§€, ë‹¨ì¼ í‚¤ì›Œë“œì¸ì§€ í™•ì¸
      if (opt.ìƒ‰ìƒ && opt.ì‚¬ì´ì¦ˆ) {
        str = `${opt.ìƒ‰ìƒ}-${opt.ì‚¬ì´ì¦ˆ}`;
      } else {
        str = opt.ì‚¬ì´ì¦ˆ || opt.ìƒ‰ìƒ;
      }
      // ë‹¨ì¢… ìƒíƒœë©´ ì ‘ë‘ì–´ ë¶™ì„
      if (opt.ìƒíƒœ === 'discont') {
        str = `ë‹¨ì¢…-${str}`;
      }
      return str;
    });
    
    optInput.value = textParts.join(', '); // ì½¤ë§ˆë¡œ ì—°ê²°í•´ì„œ ì…ë ¥ì°½ì— í‘œì‹œ
  }

  // 4. ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë° ìŠ¤í¬ë¡¤ ì´ë™
  // (ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ)
  document.querySelector('.manual-scroll-box').scrollTop = 0;
  
  // ì‹œê°ì  íš¨ê³¼ (ì…ë ¥ì°½ ê¹œë¹¡ì„ ë“±)
  row.style.transition = "background 0.3s";
  row.style.background = "#e6fffa";
  setTimeout(() => row.style.background = "transparent", 500);
}

// === [ìˆ˜ì •] ìŠ¤ë§ˆíŠ¸ ë¶™ì—¬ë„£ê¸° ë¡œì§ (ì§ì ‘ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ê¸°) ===

// 1. ì´ˆê¸°í™”
function initDynamicRows() {
  const container = document.getElementById('rowContainer');
  container.innerHTML = '';
  addDynamicRow(true); // ê¸°ë³¸ 1ì¤„ ìƒì„±
}

// [ìˆ˜ì •] ì¤„ ì¶”ê°€ í•¨ìˆ˜ (ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€ë¨)
function addDynamicRow(isFirst = false) {
  const container = document.getElementById('rowContainer');
  const div = document.createElement('div');
  div.className = 'dynamic-row';
  div.innerHTML = `
    <input type="text" class="d-input d-code" placeholder="ì½”ë“œ (ì˜ˆ: P-001)">
    <input type="text" class="d-input d-opt" placeholder="ì˜µì…˜ (ì˜ˆ: ë¸”ë™-95, ë‹¨ì¢… ë„¤ì´ë¹„-100)">
    <button class="d-disc-btn" onclick="toggleDisc(this)">ë‹¨ì¢…</button>
    <div class="d-del-btn ${isFirst ? 'disabled' : ''}" onclick="removeRow(this)">&times;</div>
  `;
  
  // 1. ê´€ë¦¬ì½”ë“œ ì…ë ¥ì°½ ê°€ì ¸ì˜¤ê¸°
  const codeInput = div.querySelector('.d-code');

  // [ì´ë²¤íŠ¸ 1] ë¶™ì—¬ë„£ê¸° ê°ì§€ (ìŠ¤ë§ˆíŠ¸ ë¶™ì—¬ë„£ê¸°)
  codeInput.addEventListener('paste', function(e) { 
      handleSmartPaste(e, div); 
  });

  // [ì´ë²¤íŠ¸ 2] ì…ë ¥ ê°ì§€ (â˜… ì—¬ê¸°ê°€ ìˆ˜ì •ë¨: ìë™ ì¤„ ì¶”ê°€ + ì‹¤ì‹œê°„ ê²€ìƒ‰)
  codeInput.addEventListener('input', function() {
      checkAndAddRow(this);           // ì¤„ ì¶”ê°€ í™•ì¸
      refreshStorageList(this.value); // â˜… ì…ë ¥ëœ ê°’ìœ¼ë¡œ ì•„ë˜ ëª©ë¡ ê²€ìƒ‰
  });

  // 2. ë‚˜ë¨¸ì§€ ì…ë ¥ì°½ ì´ë²¤íŠ¸ (ì˜µì…˜ì°½ ë“±)
  const inputs = div.querySelectorAll('input');
  inputs.forEach(inp => {
    // ê´€ë¦¬ì½”ë“œê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì…ë ¥ì°½ì€ ì¤„ ì¶”ê°€ ê¸°ëŠ¥ë§Œ ìˆ˜í–‰
    if (!inp.classList.contains('d-code')) {
        inp.addEventListener('input', function() { checkAndAddRow(this); });
    }
    // ì—”í„°í‚¤ ì €ì¥ ê¸°ëŠ¥
    inp.addEventListener('keydown', function(e) { if(e.key === 'Enter') saveDynamicRows(); });
  });

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// [ìˆ˜ì •] ìŠ¤ë§ˆíŠ¸ ë¶™ì—¬ë„£ê¸° (ê´€ë¦¬ì½”ë“œ ì—´ì˜ 'ë‹¨ì¢…' ì ‘ë‘ì–´ ìë™ ì¸ì‹ ì¶”ê°€)
function handleSmartPaste(e, currentRow) {
  const text = (e.clipboardData || window.clipboardData).getData('text');
  if (!text.includes('\n') && !text.includes('\t')) return;
  e.preventDefault();
  
  const rows = text.trim().split(/[\n\r]+/);
  const container = document.getElementById('rowContainer');
  
  rows.forEach((rowStr, i) => {
    const cols = rowStr.split('\t');
    let code = cols[0] ? cols[0].trim() : ''; // ê´€ë¦¬ì½”ë“œ
    let opt = cols[1] ? cols[1].trim() : '';  // í’ˆì ˆì˜µì…˜
    
    if (!code) return;

    let isDisc = false;

    // [ì¶”ê°€ëœ ê¸°ëŠ¥] ê´€ë¦¬ì½”ë“œ ìì²´ê°€ "ë‹¨ì¢… ..."ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
    if (code.startsWith('ë‹¨ì¢…')) {
        isDisc = true; // ë‹¨ì¢… ë²„íŠ¼ ON
        // "ë‹¨ì¢… K2-90" -> "K2-90"ìœ¼ë¡œ ê¸€ìë§Œ ë°œë¼ë‚´ê¸°
        code = code.replace(/^ë‹¨ì¢…\s*/, '').trim(); 
        opt = ''; // ì „ì²´ ë‹¨ì¢…ì´ë¯€ë¡œ ì˜µì…˜ ë‚´ìš©ì€ ë¬´ì‹œ
    }

    let targetRow;
    if (i === 0) {
      targetRow = currentRow;
    } else { 
      addDynamicRow(); 
      targetRow = container.lastElementChild; 
    }
    
    // ê¸°ì¡´ ë¡œì§ (ì˜µì…˜ì¹¸ì— "í’ˆì ˆ/ë‹¨ì¢…" ì í˜€ìˆëŠ”ì§€ í™•ì¸) + ìœ„ì—ì„œ ì°¾ì€ isDisc í•©ì¹˜ê¸°
    fillRowData(targetRow, code, opt, isDisc);
  });

  addDynamicRow();
}

// [ìˆ˜ì •] fillRowData í•¨ìˆ˜ë„ íŒŒë¼ë¯¸í„° ì¶”ê°€ í•„ìš” (isDiscForce)
function fillRowData(rowElement, code, optionRaw, isDiscForce = false) {
  const codeInput = rowElement.querySelector('.d-code');
  const optInput = rowElement.querySelector('.d-opt');
  const discBtn = rowElement.querySelector('.d-disc-btn');

  codeInput.value = code;
  const cleanOpt = optionRaw.replace(/\s+/g, '');

  // 1. ì½”ë“œ ìì²´ì— 'ë‹¨ì¢…'ì´ ë¶™ì–´ìˆì—ˆê±°ë‚˜(isDiscForce), ì˜µì…˜ì¹¸ì— 'ë‹¨ì¢…'ì´ë¼ê³  ì“´ ê²½ìš°
  if (isDiscForce || cleanOpt === 'ë‹¨ì¢…') {
      if (!discBtn.classList.contains('active')) toggleDisc(discBtn);
  } 
  // 2. ì˜µì…˜ì¹¸ì— 'í’ˆì ˆ', 'ì „ì²´' ë“±ì´ ìˆëŠ” ê²½ìš°
  else if (['í’ˆì ˆ', 'ì „ì²´', 'ì „ì²´í’ˆì ˆ', 'ì „ëŸ‰', 'ì „ëŸ‰í’ˆì ˆ'].includes(cleanOpt)) {
      if (discBtn.classList.contains('active')) toggleDisc(discBtn); // ë‹¨ì¢…ë²„íŠ¼ì€ ë”
      optInput.value = ''; // ë‚´ìš©ì€ ë¹„ì›€ (ì „ì²´í’ˆì ˆ)
  } 
  // 3. ì¼ë°˜ ë¶€ë¶„ì˜µì…˜ì¸ ê²½ìš°
  else {
      if (discBtn.classList.contains('active')) toggleDisc(discBtn);
      optInput.value = optionRaw;
  }
}


// ìë™ í–‰ ì¶”ê°€ ê°ì§€
function checkAndAddRow(inputElement) {
  const row = inputElement.closest('.dynamic-row');
  const container = document.getElementById('rowContainer');
  
  // í˜„ì¬ ì…ë ¥ ì¤‘ì¸ í–‰ì´ ë§ˆì§€ë§‰ í–‰ì¸ì§€ í™•ì¸
  if (row === container.lastElementChild) {
    // ë‚´ìš©ì´ ì¡°ê¸ˆì´ë¼ë„ ìˆìœ¼ë©´ ìƒˆ ì¤„ ì¶”ê°€
    if (inputElement.value.trim() !== '') {
      addDynamicRow();
    }
  }
}

// ë‹¨ì¢… ë²„íŠ¼ í† ê¸€
function toggleDisc(btn) {
  btn.classList.toggle('active');
  const row = btn.closest('.dynamic-row');
  const optInput = row.querySelector('.d-opt');
  
  if (btn.classList.contains('active')) {
    optInput.disabled = true;
    optInput.placeholder = "(ì „ì²´ ë‹¨ì¢… ì„¤ì •ë¨)";
    optInput.style.backgroundColor = "#f3f4f6";
  } else {
    optInput.disabled = false;
    optInput.placeholder = "ì˜µì…˜ (ì˜ˆ: ë¹¨ê°•, 95)";
    optInput.style.backgroundColor = "#fff";
  }
}

// í–‰ ì‚­ì œ
function removeRow(btn) {
  const row = btn.closest('.dynamic-row');
  row.remove();
}

// [ìˆ˜ì •] ì €ì¥ ë¡œì§ (ì…ë ¥ì°½ ë‚´ 'ë‹¨ì¢…' ì ‘ë‘ì–´ ìë™ ì¸ì‹)
function saveDynamicRows() {
  const rows = document.querySelectorAll('.dynamic-row');
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){}
  
  let newCount = 0;
  let updateCount = 0; 

  rows.forEach(row => {
    let code = row.querySelector('.d-code').value.trim();
    const optRaw = row.querySelector('.d-opt').value.trim();
    const isDiscBtn = row.querySelector('.d-disc-btn').classList.contains('active');
    
    // [í•µì‹¬] ì…ë ¥ì°½ì— "ë‹¨ì¢… ..." ì´ë¼ê³  ì¼ëŠ”ì§€ í™•ì¸
    let isDiscInput = false;
    if (code.startsWith('ë‹¨ì¢…')) {
        isDiscInput = true;
        code = code.replace(/^ë‹¨ì¢…\s*/, ''); // "ë‹¨ì¢… " ì œê±°
    }

    if(!code) return;

    if (saved[code]) updateCount++; else newCount++;
    
    // ë²„íŠ¼ì´ ì¼œì ¸ìˆê±°ë‚˜, ì½”ë“œ ì•ì— 'ë‹¨ì¢…'ì„ ì¼ë‹¤ë©´ -> ì „ì²´ ë‹¨ì¢…
    if(isDiscBtn || isDiscInput) {
      saved[code] = { ì „ì²´: 'discont', ë³µí•©: [] };
    } 
    // (ì´í•˜ ë¶€ë¶„ í’ˆì ˆ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
    else if(optRaw) {
      if(saved[code]?.ì „ì²´) saved[code].ì „ì²´ = false;
      saved[code] = { ì „ì²´: false, ë³µí•©: [] };
      const tokens = optRaw.split(',').map(s=>s.trim()).filter(s=>s);
      tokens.forEach(t => {
        let status = 'soldout', val = t;
        if (val.startsWith('ë‹¨ì¢…')) { status = 'discont'; val = val.replace('ë‹¨ì¢…', '').trim(); val = val.replace(/^[-/ ]+/, ''); }
        
        let subValues = [];
        const parenMatch = val.match(/^([^(]+)\s*\(\s*([^)]+)\s*\)$/);
        if(parenMatch) { subValues = [parenMatch[1].trim(), parenMatch[2].trim()]; }
        else { subValues = [val]; }

        subValues.forEach(sv => {
            let newOpt = {};
            if (sv.includes('-')) {
                const idx = sv.lastIndexOf('-');
                newOpt = { ìƒ‰ìƒ: sv.substring(0, idx).trim(), ì‚¬ì´ì¦ˆ: sv.substring(idx+1).trim(), ìƒíƒœ: status };
            } else if (sv.includes('/')) {
                 const idx = sv.lastIndexOf('/');
                 newOpt = { ìƒ‰ìƒ: sv.substring(0, idx).trim(), ì‚¬ì´ì¦ˆ: sv.substring(idx+1).trim(), ìƒíƒœ: status };
            } else {
                newOpt = { ìƒ‰ìƒ: '', ì‚¬ì´ì¦ˆ: sv, ìƒíƒœ: status };
            }
            if(!saved[code].ë³µí•©.some(o => o.ìƒ‰ìƒ===newOpt.ìƒ‰ìƒ && o.ì‚¬ì´ì¦ˆ===newOpt.ì‚¬ì´ì¦ˆ && o.ìƒíƒœ===newOpt.ìƒíƒœ)) {
               saved[code].ë³µí•©.push(newOpt);
            }
        });
      });
    } else {
      saved[code] = { ì „ì²´: 'soldout', ë³µí•©: [] };
    }
  });
  
  if(newCount === 0 && updateCount === 0) { showToast('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
  refreshStorageList();
  initDynamicRows();
  
  let msg = "âœ… ì €ì¥ ì™„ë£Œ!";
  if (newCount > 0) msg += ` (ì‹ ê·œ: ${newCount}ê±´)`;
  if (updateCount > 0) msg += ` (ìˆ˜ì •: ${updateCount}ê±´)`;
  showToast(msg);
}

// [ì‹ ê·œ] ëª©ë¡ì—ì„œ ê°œë³„ ì‚­ì œ í•¨ìˆ˜
function deleteSingleStorageItem(code) {
  if (!confirm(`'${code}' ì„¤ì •ì„ ì €ì¥ì†Œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  let savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  delete savedState[code];
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
  refreshStorageList(); // ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
}

// [ìˆ˜ì • ì™„ë£Œ] ë™ê¸°í™” ì €ì¥ (ë®ì–´ì“°ê¸° ë°©ì§€ -> ë³‘í•©/ì¶”ê°€ ëª¨ë“œ) + ë³€ìˆ˜ ì˜¤ë¥˜ í•´ê²°
function saveToBrowser() {
  // 1. í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì•Œë¦¼
  if (Object.keys(soldoutState).length === 0) {
    alert("í˜„ì¬ ì‘ì—… ì¤‘ì¸ í’ˆì ˆ/ë‹¨ì¢… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì™¼ìª½ í™”ë©´ì—ì„œ í’ˆì ˆ ì„¤ì •ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
    return;
  }

  // 2. ê¸°ì¡´ì— ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  let savedData = {};
  try {
    savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch(e) {
    savedData = {};
  }

  // 3. ë°ì´í„° ë³‘í•© (Merge) & ì¹´ìš´íŒ… ë³€ìˆ˜ ì„ ì–¸ (ì´ê²Œ ë¹ ì ¸ì„œ ì—ëŸ¬ê°€ ë‚¬ì—ˆìŠµë‹ˆë‹¤)
  let newCount = 0;    // ì‹ ê·œ ì¶”ê°€ ê±´ìˆ˜
  let updateCount = 0; // ìˆ˜ì • ê±´ìˆ˜

  for (const code in soldoutState) {
    if (savedData[code]) {
      updateCount++; // ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
    } else {
      newCount++;    // ì—†ìœ¼ë©´ ì‹ ê·œ ì¶”ê°€
    }
    // í˜„ì¬ ì‘ì—… ë‚´ìš©ì„ ì €ì¥ì†Œ ë°ì´í„°ì— ë®ì–´ì”Œì›€ (ì—…ë°ì´íŠ¸)
    savedData[code] = soldoutState[code];
  }

  // 4. í•©ì³ì§„ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì €ì¥
  localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));

  // 5. ëª©ë¡ ê°±ì‹  ë° ì•Œë¦¼
  refreshStorageList();
  
  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶œë ¥
  showToast(`âœ… ì €ì¥ ì™„ë£Œ! (ì‹ ê·œ: ${newCount}ê±´, ìˆ˜ì •: ${updateCount}ê±´)`);
}

// === [ì‹ ê·œ] ë°ì´í„° ì—‘ì…€ ë°±ì—…(ë‚´ë³´ë‚´ê¸°) ë° ë³µì›(ë¶ˆëŸ¬ì˜¤ê¸°) ===

// 1. ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° (Export)
function exportDataToExcel() {
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){}
  
  if (Object.keys(saved).length === 0) {
    alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ì—‘ì…€ìš© ë°ì´í„° ë³€í™˜
  const exportData = [];
  
  for (const code in saved) {
    const item = saved[code];
    let statusText = "";
    let optionsText = "";

    if (item.ì „ì²´ === 'discont') {
      statusText = "ì „ì²´ë‹¨ì¢…";
    } else if (item.ì „ì²´ === 'soldout') {
      statusText = "ì „ì²´í’ˆì ˆ";
    } else {
      statusText = "ë¶€ë¶„ì„¤ì •";
      // ë³µí•© ì˜µì…˜ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì˜ˆ: "ë‹¨ì¢…-ë¸”ë™-95, í™”ì´íŠ¸-100")
      const parts = item.ë³µí•©.map(opt => {
        let str = "";
        // ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ì¡°í•©
        if (opt.ìƒ‰ìƒ && opt.ì‚¬ì´ì¦ˆ) str = `${opt.ìƒ‰ìƒ}-${opt.ì‚¬ì´ì¦ˆ}`;
        else str = opt.ì‚¬ì´ì¦ˆ || opt.ìƒ‰ìƒ;
        
        // ë‹¨ì¢… ì—¬ë¶€
        if (opt.ìƒíƒœ === 'discont') str = `ë‹¨ì¢…-${str}`;
        return str;
      });
      optionsText = parts.join(', ');
    }

    exportData.push({
      "ê´€ë¦¬ì½”ë“œ": code,
      "ìƒíƒœ": statusText,
      "ìƒì„¸ì˜µì…˜": optionsText
    });
  }

  // ì—‘ì…€ íŒŒì¼ ìƒì„±
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "í’ˆì ˆë‹¨ì¢…ë°ì´í„°");
  XLSX.writeFile(wb, `í’ˆì ˆë°ì´í„°ë°±ì—…_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// [ìµœì¢… ìˆ˜ì •] ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸° (ê´„í˜¸ ë¶„ë¦¬ ë¡œì§ ì¶”ê°€ë¨)
function importDataFromExcel(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type: 'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(ws);

    if (jsonData.length === 0) {
      alert("ë°ì´í„°ê°€ ì—†ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.");
      return;
    }

    let saved = {};
    try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){}
    
    let successCount = 0;

    jsonData.forEach(row => {
      const code = row['ê´€ë¦¬ì½”ë“œ'] || row['ìƒí’ˆì½”ë“œ'] || row['ì½”ë“œ'];
      const status = row['ìƒíƒœ'];     
      const details = row['ìƒì„¸ì˜µì…˜']; 

      if (!code) return;

      let newItem = { ì „ì²´: false, ë³µí•©: [] };

      if (status === 'ì „ì²´ë‹¨ì¢…') {
        newItem.ì „ì²´ = 'discont';
      } else if (status === 'ì „ì²´í’ˆì ˆ') {
        newItem.ì „ì²´ = 'soldout';
      } else if (details) {
        // ì½¤ë§ˆë¡œ 1ì°¨ ë¶„ë¦¬
        const tokens = details.split(',').map(s => s.trim()).filter(s => s);
        
        tokens.forEach(t => {
          let optState = 'soldout';
          let val = t;
          
          // ë‹¨ì¢… ì ‘ë‘ì–´ ì²˜ë¦¬
          if (val.startsWith('ë‹¨ì¢…')) { 
             optState = 'discont'; 
             val = val.replace('ë‹¨ì¢…', '').trim(); 
             val = val.replace(/^[-/ ]+/, '');
          }

          let color = '', sizeRaw = val;
          
          // í•˜ì´í”ˆ(-)ìœ¼ë¡œ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ë¶„ë¦¬
          if (val.includes('-')) {
            const idx = val.lastIndexOf('-');
            color = val.substring(0, idx).trim();
            sizeRaw = val.substring(idx + 1).trim();
          } 

          // [ì¶”ê°€ë¨] ê´„í˜¸ ë¶„ë¦¬ ë¡œì§ (105(XL) -> 105, XL)
          let subValues = [];
          const parenMatch = sizeRaw.match(/^([^(]+)\s*\(\s*([^)]+)\s*\)$/);
          
          if (parenMatch) {
              subValues = [parenMatch[1].trim(), parenMatch[2].trim()];
          } else {
              subValues = [sizeRaw];
          }

          // ë¶„ë¦¬ëœ ê°’ë“¤ì„ ê°ê° ì €ì¥
          subValues.forEach(finalSize => {
              newItem.ë³µí•©.push({ 
                  ìƒ‰ìƒ: color, 
                  ì‚¬ì´ì¦ˆ: finalSize, 
                  ìƒíƒœ: optState 
              });
          });
        });
      }

      // ë°ì´í„° ë³‘í•© (ë®ì–´ì“°ê¸°)
      saved[code] = newItem;
      successCount++;
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
    refreshStorageList();
    initDynamicRows();
    
    alert(`âœ… ${successCount}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ í•©ì³¤ìŠµë‹ˆë‹¤.`);
    input.value = ''; 
  };
  reader.readAsArrayBuffer(file);
}

// [ìµœì¢… ìˆ˜ì •] ì‚¬ì´ì¦ˆ ë§¤ì¹­ í—¬í¼ (ê´„í˜¸ ì–‘ë°©í–¥ ì¸ì‹ ê°•í™”)
function checkSizeMatch(rowSize, targetKey) {
  // 1. ê³µë°± ì œê±° ë° ëŒ€ë¬¸ì ë³€í™˜ (ì†Œë¬¸ì xlê³¼ ëŒ€ë¬¸ì XLë„ ê°™ê²Œ ì¸ì‹)
  const rS = String(rowSize).replace(/\s+/g, '').toUpperCase(); 
  const tK = String(targetKey).replace(/\s+/g, '').toUpperCase();

  // 2. ì •í™•íˆ ì¼ì¹˜í•˜ë©´ í†µê³¼ (ì˜ˆ: "XL" == "XL")
  if (rS === tK) return true;
  
  // ì •ê·œì‹: "ê°’(ê´„í˜¸ì•ˆë‚´ìš©)" í˜•íƒœ ë¶„ë¦¬
  const regex = /^([^(]+)\(([^)]+)\)$/;

  // 3. Case A: ì—‘ì…€ ë°ì´í„°(rS)ê°€ "105(XL)" í˜•íƒœì¼ ë•Œ -> "105"ë‚˜ "XL"ì´ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ í†µê³¼
  let m = rS.match(regex);
  if (m) {
      const main = m[1]; // ê´„í˜¸ ì•
      const sub = m[2];  // ê´„í˜¸ ì•ˆ
      if (main === tK || sub === tK) return true;
  }

  // 4. Case B: ì €ì¥ëœ ë°ì´í„°(tK)ê°€ "105(XL)" í˜•íƒœì¼ ë•Œ -> ì—‘ì…€ì— "105"ë‚˜ "XL"ì´ ìˆìœ¼ë©´ í†µê³¼
  // (â˜… ì§€ê¸ˆ ê³ ê°ë‹˜ ìƒí™© í•´ê²°í•˜ëŠ” ë¶€ë¶„)
  m = tK.match(regex);
  if (m) {
      const main = m[1]; // 105
      const sub = m[2];  // XL
      if (main === rS || sub === rS) return true;
  }
  
  return false;
}

// [ì¶”ê°€] ì˜µì…˜ ëª©ë¡ ì¤‘ë³µ ì œê±° ìœ í‹¸
function getUniqueOptions(rows) {
  const map = new Map();
  rows.forEach(r => {
    const ex = extractColorAndSize(r);
    const key = ex.color + '|' + ex.size;
    if (!map.has(key)) {
      map.set(key, { color: ex.color, size: ex.size });
    }
  });
  return Array.from(map.values()).sort((a, b) => 
    a.color.localeCompare(b.color) || compareSize(a.size, b.size)
  );
}

// [ì¶”ê°€] ê°œë³„ ì˜µì…˜ ë³€ê²½ ì‹œ ì „ì²´ ìƒíƒœ ìë™ ê³„ì‚° (ì—ëŸ¬ ë°©ì§€ìš© ë¹ˆ í•¨ìˆ˜)
function checkAutoTotal(code) {
  // ê¸°ëŠ¥ ë¹„í™œì„±í™” ìƒíƒœ
}

// [ìµœì¢… ìˆ˜ì •] ì‚¬ì´ì¦ˆ ë§¤ì¹­ í—¬í¼ ("105(XL)" ê´„í˜¸ ì¸ì‹)
function checkSizeMatch(rowSize, targetKey) {
  const rS = String(rowSize).replace(/\s+/g, '').toUpperCase(); 
  const tK = String(targetKey).replace(/\s+/g, '').toUpperCase();

  if (rS === tK) return true;
  
  const regex = /^([^(]+)\(([^)]+)\)$/;
  
  // ì—‘ì…€ ë°ì´í„°ê°€ ê´„í˜¸ í¬í•¨ì¼ ë•Œ
  let m = rS.match(regex);
  if (m) {
      if (m[1].trim().toUpperCase() === tK || m[2].trim().toUpperCase() === tK) return true;
  }

  // ì €ì¥ëœ ë°ì´í„°ê°€ ê´„í˜¸ í¬í•¨ì¼ ë•Œ
  m = tK.match(regex);
  if (m) {
      if (m[1].trim().toUpperCase() === rS || m[2].trim().toUpperCase() === rS) return true;
  }
  
  return false;
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë„ìš°ê¸° í•¨ìˆ˜
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.className = "show";
  toast.innerText = message;
  
  setTimeout(function(){ 
    toast.className = toast.className.replace("show", ""); 
  }, 3000);
}

// ==========================================
//  [ì‹ ê·œ] GitHub API ì—°ë™ (í´ë¼ìš°ë“œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°)
// ==========================================

// 1. ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', () => {
    const DEFAULT_REPO = 'EasyHara/stock_zero_tool';
    const DEFAULT_PATH = 'soldout_data.json';

    document.getElementById('ghRepo').value = DEFAULT_REPO;
    document.getElementById('ghPath').value = DEFAULT_PATH;

    const ghConfig = JSON.parse(localStorage.getItem('gh_config') || '{}');
    if(ghConfig.token) {
        document.getElementById('ghToken').value = ghConfig.token;
    }
});

// 2. ì„¤ì • ì €ì¥
function saveGithubConfig() {
    const token = document.getElementById('ghToken').value.trim();
    const repo = document.getElementById('ghRepo').value.trim();
    const path = document.getElementById('ghPath').value.trim() || 'soldout_data.json';
    
    if(!token || !repo) return alert('í† í°ê³¼ ì €ì¥ì†Œ ì´ë¦„(User/Repo)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    
    localStorage.setItem('gh_config', JSON.stringify({ token, repo, path }));
    showToast("âœ… GitHub ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// 3. ì—…ë¡œë“œ
async function uploadToGithub() {
    const token = document.getElementById('ghToken').value.trim();
    const repo = document.getElementById('ghRepo').value.trim();
    const path = document.getElementById('ghPath').value.trim();
    
    if(!token || !repo) return alert('GitHub ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.');
    
    let dataToUpload = {};
    try {
        dataToUpload = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    } catch (e) {
        dataToUpload = {};
    }

    if (Object.keys(dataToUpload).length === 0) {
        if(!confirm('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    } else {
        if(!confirm(`ì €ì¥ì†Œì— ë³´ê´€ëœ ì´ ${Object.keys(dataToUpload).length}ê±´ì˜ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.`)) return;
    }

    const content = JSON.stringify(dataToUpload, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(content)));
    
    const url = `https://api.github.com/repos/${repo}/contents/${path}`;
    
    try {
        let sha = null;
        const getRes = await fetch(url, {
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        
        if (getRes.ok) {
            const getData = await getRes.json();
            sha = getData.sha;
        }

        const putRes = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Data Backup (${new Date().toLocaleString()})`,
                content: contentBase64,
                sha: sha 
            })
        });

        if (putRes.ok) {
            showToast(`âœ… GitHub ì—…ë¡œë“œ ì„±ê³µ! (ì´ ${Object.keys(dataToUpload).length}ê±´)`);
        } else {
            const err = await putRes.json();
            alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
        }
    } catch (e) {
        console.error(e);
        alert('í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// 4. ë‹¤ìš´ë¡œë“œ
async function loadFromGithub() {
    const token = document.getElementById('ghToken').value.trim();
    const repo = document.getElementById('ghRepo').value.trim();
    const path = document.getElementById('ghPath').value.trim();
    
    if(!token || !repo) return alert('GitHub ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    
    const url = `https://api.github.com/repos/${repo}/contents/${path}`;
    
    try {
        const res = await fetch(url, {
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
        });

        if (!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
        
        const data = await res.json();
        const decodedContent = decodeURIComponent(escape(atob(data.content)));
        const parsedData = JSON.parse(decodedContent);
        
        let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        let newCount = 0;
        for(const key in parsedData) {
            saved[key] = parsedData[key];
            newCount++;
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
        
        refreshStorageList();
        applyFromBrowser(true); 

        showToast(`âœ… GitHub ë™ê¸°í™” ì™„ë£Œ! (${newCount}ê±´ ë°›ì•„ì˜´)`);

    } catch (e) {
        console.error(e);
        alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
    }
}
  </script>
<div id="dataModal" class="modal-overlay">
    <div class="modal-content" style="width: 550px; max-width: 95vw;">
      <div class="modal-header">
        <span>í’ˆì ˆ/ë‹¨ì¢… ë°ì´í„° ê´€ë¦¬</span>
        <span class="modal-close-icon" onclick="closeModal()">&times;</span>
      </div>

      <div class="manual-add-area">
        <div style="font-size:13px; font-weight:700; color:#2c6e58; margin-bottom:6px; display:flex; justify-content:space-between;">
          <span>âš¡ ê´€ë¦¬ì½”ë“œ ë° ì˜µì…˜ ë“±ë¡</span>
          <span style="font-size:11px; color:#888; font-weight:400;">(ì½”ë“œ ì¹¸ì— ì—‘ì…€ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)</span>
        </div>
        
        <div style="display:flex; gap:6px; padding:0 6px; margin-bottom:4px; font-size:12px; color:#555; font-weight:600;">
          <div style="flex:1;">ê´€ë¦¬ì½”ë“œ</div>
          <div style="flex:1.8;">í’ˆì ˆì˜µì…˜ (ì˜ˆ: ë¸”ë™-95, ë‹¨ì¢…-100)</div>
          <div style="width:50px; text-align:center;">ìƒíƒœ</div>
          <div style="width:20px;"></div>
        </div>

        <div id="rowContainer" class="manual-scroll-box"></div>

        <div style="text-align:right; margin-top:10px;">
           <button class="manual-btn" onclick="saveDynamicRows()">ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€(ì €ì¥)</button>
        </div>
      </div>
      
      <div class="storage-ctrl-bar">
        <div>
          <span style="font-size:13px; font-weight:600; color:#444;">ì €ì¥ëœ ëª©ë¡</span>
          <span id="storageCount" style="font-size:12px; color:#888;">0ê°œ</span>
        </div>
        <button class="del-sel-btn" onclick="deleteSelectedItems()">ì„ íƒ ì‚­ì œ</button>
      </div>
      
      <div class="storage-list-area" id="storageListContainer">
        <div style="padding:20px; text-align:center; color:#aaa; font-size:13px;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <div class="modal-row">
         <label style="font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="autoApplyCheck" checked> íŒŒì¼ ì—´ ë•Œ ì´ ë°ì´í„° ìë™ ì ìš©
        </label>
      </div>
      <div id="saveStatusMsg" style="font-size:12px; color:#2c6e58; margin-bottom:8px; height:16px;"></div>
      
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button class="switch-btn" style="flex:1; margin:0;" onclick="saveToBrowser()">ë™ê¸°í™”ì €ì¥</button>
        <button class="switch-btn" style="flex:1; margin:0; background:#fff;" onclick="applyFromBrowser()">í˜„ì¬ íŒŒì¼ì— ì ìš©</button>
      </div>

<div style="margin-top:15px; border:1px solid #ddd; padding:12px; border-radius:8px; background:#fafafa;">
        <div style="font-weight:700; color:#444; font-size:13px; margin-bottom:8px; display:flex; align-items:center; gap:6px;">
           â˜ï¸ GitHub í´ë¼ìš°ë“œ ë™ê¸°í™”
        </div>

        <input id="ghToken" type="password" placeholder="ì—¬ê¸°ì— GitHub í† í°ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (ghp_...)" class="d-input" style="background:#fff; width:100%; margin-bottom:8px;">
        
        <input id="ghRepo" type="hidden">
        <input id="ghPath" type="hidden">
        
        <div style="display:flex; gap:6px;">
             <button class="manual-btn" onclick="saveGithubConfig()" style="background:#666; color:#fff; border:none; width:80px;">í† í° ì €ì¥</button>
             <button class="manual-btn" onclick="uploadToGithub()" style="flex:1; background:#0ea5e9; color:#fff; border:none;">â˜ï¸ ì—…ë¡œë“œ</button>
             <button class="manual-btn" onclick="loadFromGithub()" style="flex:1; background:#22c55e; color:#fff; border:none;">â˜ï¸ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div style="font-size:11px; color:#999; margin-top:6px;">
          * [í† í° ì €ì¥]ì„ ëˆ„ë¥´ë©´ ë¸Œë¼ìš°ì €ì— í† í°ì´ ê¸°ì–µë˜ì–´ ë§¤ë²ˆ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
        </div>
      </div>
      <div style="height:10px;"></div>

      <div style="border-top:1px dashed #ddd; padding-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:12px; color:#666;">ğŸ“‚ ë°ì´í„° ë°±ì—…</div>
        <div style="display:flex; gap:6px;">
            <button class="del-sel-btn" style="background:#f0f9ff; border-color:#bae6fd; color:#0284c7;" onclick="exportDataToExcel()">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
            <button class="del-sel-btn" style="background:#fff; border-color:#bae6fd; color:#0284c7;" onclick="document.getElementById('backupFileInput').click()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="backupFileInput" style="display:none;" accept=".xlsx, .xls" onchange="importDataFromExcel(this)">
        </div>
      </div>

      <div style="margin-top:12px; text-align:right;">
        <button class="reset-btn" style="padding:6px 10px; font-size:12px;" onclick="clearBrowserData()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>
  </div>
  <div id="toast"></div>
</body>
</html>
