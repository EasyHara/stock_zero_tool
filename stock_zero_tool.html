<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리코드별 색상/사이즈 품절툴</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=1200">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
body {
  font-family: 'Pretendard', 'Apple SD Gothic Neo', '맑은 고딕', sans-serif;
  background: #f8fcf9;
  color: #163326;
  font-size: 16px;
  margin: 0; padding: 0;
}
.container {
  max-width: 1500px;
  margin: 22px auto 0 auto;
  background: #fff;
  padding: 30px 42px 38px 42px;
  border-radius: 18px;
  box-shadow: 0 2px 28px rgba(60,80,60,0.09);
  overflow-x: auto;
  min-height: 96vh;
  display: flex;
  flex-direction: row;
}
.main-area {
  flex: 1; min-width: 900px; margin-right: 32px;
}
.side-area {
  width: 380px; min-width: 320px;
  background: #f7faf8;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(120,160,120,0.07);
  padding: 18px 22px 18px 22px;
  margin-top: 22px;
  align-self: flex-start;
  position: sticky; top: 32px; height: fit-content;
}
.side-area h3 { font-size: 1.1rem; font-weight: 600; color: #195140; margin-bottom: 6px; }
.side-area ul {
  font-size: 14.5px; list-style: none; margin: 0; padding: 0;
}
.side-area ul li {
  background: #e1ece6; border-radius: 7px;
  margin-bottom: 7px; padding: 6px 11px; color: #315e4d;
  font-weight: 500; word-break: break-all;
}
.main-title-wrap {
  display: flex; align-items: flex-end; justify-content: space-between;
  min-height: 48px; margin-bottom: 16px; position: relative; padding-right: 42px;
}
.main-title {
  font-size: 2.2rem; font-weight: 700; color: #184c37;
  margin: 0 0 0 16px; letter-spacing: 0.02em;
}
.back-btn {
  background: #e1ece6;
  border: 1.2px solid #b0c9bb;
  color: #246b5c;
  border-radius: 10px;
  padding: 11px 22px;
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 18px;
  margin-top: 6px;
  margin-left: 8px;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
}
.back-btn:hover {
  background: #d2e3da;
  color: #184c37;
  border-color: #89ac98;
}

.file-select-area {
  display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
}
.file-label {
  background: #e1ece6;
  color: #296149;
  border: 1.2px solid #b0c9bb;
  border-radius: 10px;
  padding: 11px 23px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: inline-block;
  margin-right: 8px;
  transition: background 0.13s; text-align: center;
}
.file-label:hover { background: #d2e3da; color: #184c37; border-color: #89ac98; }
.file-input { display: none; }

.switch-btn {
  min-width: 135px;
  background: #e1ece6;
  color: #247467;
  border: 1.2px solid #b0c9bb;
  border-radius: 10px;
  padding: 11px 18px;
  font-size: 15px;
  font-weight: 700;
  margin-left: 8px;
  cursor: pointer;
  transition: background 0.14s;
}
.switch-btn.on { background: #61ad80; color: #fff; border-color: #38885b; }

.reset-btn {
  min-width: 72px; margin-left: 8px; background: #f5c8c8; color: #ad2c2c;
  border: 1.2px solid #f3d1d1; font-weight: 500; transition: background 0.12s, color 0.13s; padding: 11px 14px;
  font-size: 14px; border-radius: 10px;
}
.reset-btn:hover { background: #f3b0b0; color: #8a2525; border-color: #e2b1b1; }

.check-row {
  display: flex; align-items: center; gap: 18px; margin: 7px 0 18px 0; font-size: 15px;
}
.check-row input[type="checkbox"] {
  accent-color: #2a6e52; width: 19px; height: 19px; vertical-align: middle; margin-right: 5px; margin-top: 1.5px;
}

/* 관리코드 옵션 버튼 */
#codeBtnArea {
  margin-top: 15px;
  margin-bottom: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px 16px;
}
.code-btn-wrap {
  position: relative;
  display: inline-block;
  vertical-align: top;
}
.code-btn {
  min-width: 128px;
  max-width: 220px;
  background: #e1ece6;
  border: 1.2px solid #b0c9bb;
  border-radius: 13px;
  font-size: 15px;
  font-weight: 700;
  color: #255c43;
  padding: 11px 12px;
  margin: 0;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
  outline: none;
  box-shadow: 0 1px 3px rgba(60,90,60,0.03);
  text-align: center;
  word-break: keep-all;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: 0.01em;
}
.code-btn.selected, .code-btn.has-soldout {
  background: #73bc98 !important; color: #fff !important; border-color: #5cb88a;
}

.code-btn.selected { box-shadow: 0 0 0 2px #b5e9d6 inset; border-width: 2px; }
.code-btn.has-soldout:not(.selected) { filter: brightness(0.98); border-style: dashed; }

/* 옵션 선택 박스 (popup) - "색상/사이즈 옵션을 선택하세요." */
.option-select-area.popup {
  position: absolute;
  left: 0;
  top: calc(100% + 15px); /* 버튼 아래로 충분히 여백 */
  z-index: 20;
  min-width: 220px;
  max-width: 320px;
  box-shadow: 0 6px 36px rgba(80,100,80,0.14);
  background: #fff;
  border: 1.5px solid #7ad4b3;
  padding: 18px 13px 16px 13px;
  margin: 0;
  border-radius: 11px;
  text-align: left;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.option-select-area .option-btn-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(46px, 1fr));
  gap: 8px 10px;
  width: 100%;
  margin: 11px 0 6px 0;
}

/* 옵션 선택 박스 내부 옵션 버튼 */
.option-btn {
  display: inline-block;
  min-width: 46px;
  min-height: 28px;
  background: #e1ece6;
  border: 1.2px solid #b0c9bb;
  border-radius: 9px;
  font-size: 12px !important;
  font-weight: 500;
  color: #315e4d;
  padding: 8px 0;
  margin: 0;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
  outline: none;
  text-align: center;
  box-sizing: border-box;
}


/* 옵션 선택 팝업 닫기 버튼 */
.option-soldout-area {
  margin-top: 6px;
  background: #f8f3f3;
  border-radius: 8px;
  padding: 10px 0;
  border: 1.1px solid #eed1d1;
  font-size: 14px !important;
  color: #c34343;
  text-align: center;
  cursor: pointer;
  width: 100%;
  font-weight: 600;
  margin-bottom: 0;
}

.download-btn {
  margin-top: 36px; background: #e1ece6; color: #27624f; border: 1.2px solid #b0c9bb;
  border-radius: 11px; padding: 16px 22px; font-size: 17px; font-weight: 700; cursor: pointer;
  min-width: 240px; transition: background 0.13s, color 0.13s;
  display: block; margin-left: auto; margin-right: auto;
  box-shadow: 0 2px 14px rgba(120,180,120,0.09);
}
.download-btn:hover { background: #bce3c7; color: #155c3f; border-color: #5cb88a; }

.option-btn.selected {
  background: #f3d8d8 !important;
  color: #b45454 !important;
  border-color: #e1bbbb;
  font-weight: 600;
}
.option-btn.discont {
  background: #533e8e !important;
  color: #fff !important;
  border-color: #6c4ff8;
  font-weight: 700;
}
.code-btn.discont { background: #856ed9 !important; color: #fff !important; border-color: #533e8e; }

#fileDropZone.dragover {
  background: #c9e8de;
  border-radius: 13px;
  box-shadow: 0 0 0 3px #2ba87d7a;
}

.code-btn[style*="box-shadow"] {
  outline: 2.5px solid #7ae8c8;
}
.switch-btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #f4f4f4;
  cursor: pointer;
  font-size: 14px;
}
.switch-btn.on {
  background: #2b7365;
  color: #fff;
  border-color: #2b7365;
}


@media (max-width: 1100px) {
  .container { flex-direction: column; max-width: 99vw; padding: 22px 3vw; }
  .main-area, .side-area { min-width: unset; width: unset; }
  .side-area { margin-top: 30px; width: 96vw; max-width: 460px; }
  .code-btn { min-width: 92px; font-size: 13px; padding: 9px 7px; }
}
@media (max-width: 660px) {
  .main-title { font-size: 1.1rem; }
  .container { padding: 5vw 0; }
  .side-area { padding: 6px 2vw; }
}
  </style>
</head>
<body>
  <div class="container">
    <div class="main-area">
      <button class="back-btn" onclick="location.href='https://easyhara.github.io/smartstore_options/smartstore_options.html'">
        &larr; 옵션 자동 생성기로 돌아가기
      </button>
      <div class="main-title-wrap">
        <h1 class="main-title">관리코드별 색상/사이즈 품절툴</h1>
      </div>
      <div style="margin-bottom:12px; font-size:15.5px; line-height:1.54;">
        여러 옵션 파일을 업로드하고<br>
        <b style="color:#248960;">관리코드</b>를 클릭하면 전체 품절, 또는<br>
        <span style="color:#3c6844; font-weight:600;">색상·사이즈별 품절</span>을 선택해서 원하는 옵션만 재고 0(품절)로 변경합니다.<br>
        <span style="color:#c63737;">
        옵션 이름은 반드시 각 행의 ‘색상’, ‘사이즈’ 컬럼에 정확히 입력되어 있어야 합니다.
        </span>
      </div>
      <div class="file-select-area" id="fileDropZone">
        <label class="file-label">
          엑셀파일선택
          <input type="file" id="inputFiles" class="file-input" multiple accept=".xls,.xlsx">
        </label>
        <span id="fileNames" style="font-size:15px;max-width:360px;display:inline-block;vertical-align:middle;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
        <span id="fileCount" style="font-size:14px;color:#1b8863;margin-left:7px;"></span>
       <div id="modeSwitchGroup" style="display:flex; align-items:center; gap:6px; margin-left:8px;">
        <button class="switch-btn on"  id="modeSoldoutBtn"  title="품절/단종 선택 모드">품절/단종 모드</button>
        <button class="switch-btn"      id="modeEditBtn"     title="옵션 추가/삭제 모드">옵션 편집 모드</button>
        </div>
        <button class="switch-btn" id="toggleOptionModeBtn">색상,사이즈별 품절 OFF</button>
        <button class="reset-btn" id="resetBtn">초기화</button>
      </div>

      <div class="check-row">
        <label>
          <input type="checkbox" id="fillStockCheckbox" checked>
          품절 외 재고 99999
        </label>
        <span id="prodCountInfo" style="font-size:15.2px;color:#3b7c53;"></span>
      </div>
      <div id="codeBtnArea"></div>
      <button class="download-btn" id="downloadBtn" disabled>선택 품절처리 & 파일 다운로드</button>
    </div>
    <div class="side-area">
      <h3>선택된 품절 옵션</h3>
      <ul id="soldoutList">
        <li style="color:#b5b5b5;">(선택내역 없음)</li>
      </ul>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
function toSafeId(str) {
  return str.replace(/[^a-zA-Z0-9\-_:.]/g, '_');
}

function extractColorAndSize(row) {
  let color = row['색상'] ? String(row['색상']).trim() : '';
  let size  = row['사이즈'] ? String(row['사이즈']).trim() : '';
  const base = (row['제품선택'] || row['추가상품값'] || '').toString().trim();

  const tokens = base ? base.split('/').map(s => s.trim()).filter(Boolean) : [];
  const isSizeToken = v => /^(FREE|XS|S|M|L|XL|XXL|\d{2,3})$/i.test(v);

  // 1) 사이즈가 비어 있으면 라벨에서 "마지막" 사이즈스러운 토큰을 사이즈로
  if (!size && tokens.length) {
    for (let i = tokens.length - 1; i >= 0; i--) {
      if (isSizeToken(tokens[i])) { size = tokens[i]; break; }
    }
  }

  // 2) 색상이 비어 있으면
  if (!color && tokens.length) {
    if (size) {
      // 라벨 안에서 size의 "마지막 등장 위치" 바로 앞 토큰을 색상으로
      const up = tokens.map(t => t.toUpperCase());
      let idx = -1;
      for (let i = up.length - 1; i >= 0; i--) {
        if (up[i] === size.toUpperCase()) { idx = i; break; }
      }
      if (idx > 0) color = tokens[idx - 1];
    }
    // 그래도 못 찾으면 마지막 토큰을 색상으로 추정
    if (!color) color = tokens[tokens.length - 1];
  }

  // 방어: '58/60' 같은 값 들어오면 첫 토큰만 사용
  if (size && size.includes('/')) size = size.split('/')[0].trim();

  return { color: color || '', size: size || '' };
}


let fileList = [], fileDataArr = [], allRows = [], uniqueCodes = [], soldoutState = {};
let optionMode = false, selectedCode = null;

// ▼ 모드 상태: 'soldout' | 'edit'
let mode = 'soldout';

document.getElementById('inputFiles').addEventListener('change', async function(e) { await handleFiles(e.target.files); });
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('toggleOptionModeBtn').addEventListener('click', function(){
  optionMode = !optionMode;
  this.textContent = optionMode ? '색상,사이즈별 품절 ON' : '색상,사이즈별 품절 OFF';
  if(optionMode) this.classList.add('on');
  else this.classList.remove('on');
  selectedCode = null;
  updateCodeBtns();
});

// 상단 모드 스위치 버튼
const modeSoldoutBtn = document.getElementById('modeSoldoutBtn');
const modeEditBtn    = document.getElementById('modeEditBtn');

modeSoldoutBtn.addEventListener('click', () => {
  if (mode === 'soldout') return;
  mode = 'soldout';
  modeSoldoutBtn.classList.add('on');
  modeEditBtn.classList.remove('on');

  // 필요하면 편집 모드에서 비활성화했던 토글 되살리기
  const tBtn = document.getElementById('toggleOptionModeBtn');
  tBtn.disabled = false; // 선택사항

  selectedCode = null;
  updateCodeBtns();
});

modeEditBtn.addEventListener('click', () => {
  if (mode === 'edit') return;
  mode = 'edit';
  modeEditBtn.classList.add('on');
  modeSoldoutBtn.classList.remove('on');

  optionMode = true;
  const tBtn = document.getElementById('toggleOptionModeBtn');
  tBtn.classList.add('on');
  tBtn.textContent = '색상,사이즈별 품절 ON';
  tBtn.disabled = true; // 선택사항: 편집 모드에서는 토글 못 누르게

  selectedCode = null;
  updateCodeBtns();
});



function resetAll() {
  fileList = []; fileDataArr = []; allRows = []; uniqueCodes = []; soldoutState = {}; selectedCode = null;
  document.getElementById('fileNames').textContent = '';
  document.getElementById('fileCount').textContent = '';
  document.getElementById('inputFiles').value = '';
  document.getElementById('prodCountInfo').textContent = '';
  document.getElementById('codeBtnArea').innerHTML = '';
  updateSoldoutList();
  document.getElementById('downloadBtn').disabled = true;
}

async function handleFiles(filelist) {
  if (!filelist || filelist.length === 0) return;
  for (let file of filelist) {
    if (fileList.find(f=>f.name===file.name)) continue;
    fileList.push(file);
    let data = await readExcel(file);
    fileDataArr.push({name: file.name, data});
  }
  mergeAllRows();
  updateCodeBtns();
  updateProdCount();
  updateSoldoutList();
  let names = fileList.map(f=>f.name).join(', ');
  let fileNamesElem = document.getElementById('fileNames');
  if (names.length > 45) {
    let split = names.split(',');
    let shown = split.slice(0,2).join(', ') + ' ...';
    fileNamesElem.textContent = shown;
  } else {
    fileNamesElem.textContent = names;
  }
  document.getElementById('fileCount').textContent = fileList.length > 1 ? `+${fileList.length}개` : '';
  document.getElementById('downloadBtn').disabled = false;
}

function readExcel(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      let json = XLSX.utils.sheet_to_json(ws, {defval:""});
      resolve(json);
    };
    reader.readAsArrayBuffer(file);
  });
}

function mergeAllRows() {
  allRows = [];
  let codeSet = new Set();
  for (let {name, data} of fileDataArr) {
    data.forEach(row => {
      let code = row['관리코드'] || row['상품코드'] || row['코드'] || '';
      allRows.push({...row, file:name, 관리코드:code});
      if(code) codeSet.add(code);

      // [추가] "단종"으로 시작하는 관리코드 자동 단종처리
      if (typeof code === 'string' && code.trim().startsWith('단종')) {
        soldoutState[code] = { 전체: "discont", 복합: [] };
      }
    });
  }
  uniqueCodes = Array.from(codeSet);
}

function updateCodeBtns() {
  const area = document.getElementById('codeBtnArea');
  area.innerHTML = '';
  for (let code of uniqueCodes) {
    if (!code) continue;
    const wrap = document.createElement('div');
    wrap.className = 'code-btn-wrap';
    const btn = document.createElement('button');
    btn.id = 'codeBtn_' + toSafeId(code);
    btn.className = 'code-btn'; // 항상 초기화

    // 상태 class 1개만!
if (soldoutState[code]?.전체 === "discont") {
  btn.classList.add('discont');
} else if (soldoutState[code]?.전체 === "soldout") {
  btn.classList.add('selected');
} else if ((soldoutState[code]?.복합 || []).length > 0) {
  btn.classList.add('has-soldout');
}



    // 선택된(팝업 오픈) 버튼은 boxShadow로만 강조, class 추가 X
    if (selectedCode === code) btn.style.boxShadow = '0 0 0 2px #b5e9d6 inset';
    else btn.style.boxShadow = '';

    btn.textContent = code;
    btn.onclick = (e) => {
      e.stopPropagation();
      if (optionMode) {
        selectedCode = code;
        updateCodeBtns();
      } else {
        if (!soldoutState[code] || !soldoutState[code].전체) {
          soldoutState[code] = { 전체: "soldout", 복합: [] };
        } else if (soldoutState[code].전체 === "soldout") {
          soldoutState[code].전체 = "discont";
        } else if (soldoutState[code].전체 === "discont") {
          soldoutState[code] = { 전체: false, 복합: [] };
        }
        selectedCode = null;
        updateCodeBtns();
        updateSoldoutList();
      }
    };

    wrap.appendChild(btn);

    if (optionMode && selectedCode === code) {
  let rows = allRows.filter(r => r.관리코드 === code);
  let colorSet = new Set(), sizeSet = new Set();
  rows.forEach(r => {
    let { color, size } = extractColorAndSize(r);
    if (color && color !== "") colorSet.add(color);
    if (size && size !== "") sizeSet.add(size);
  });
  let colors = Array.from(colorSet).filter(x => x !== "");
  let sizes  = Array.from(sizeSet).filter(x => x !== "");

  if (mode === 'soldout') {
    if (colors.length > 0 || sizes.length > 0) {
      showOptionSelect(code, wrap, colors, sizes); // 기존 품절/단종 팝업
    }
  } else {
    // 옵션 편집 모드 팝업 (플레이스홀더/기본 뼈대)
    showOptionSelectForEdit(code, wrap, colors, sizes);
  }
}

    area.appendChild(wrap);
  }
  document.body.onclick = function() {
    if (selectedCode !== null) {
      selectedCode = null;
      updateCodeBtns();
    }
  }
}


function showOptionSelect(code, wrapElem, colors, sizes) {
  // 기존 팝업 DOM 제거
  Array.from(wrapElem.querySelectorAll('.option-select-area.popup')).forEach(el => el.remove());

  let box = document.createElement('div');
  box.id = 'optionBox_' + toSafeId(code);
  box.className = 'option-select-area popup';
  box.innerHTML = `
    <div style="margin-bottom:5px;font-weight:500;font-size:13.3px;color:#2b7365">
      품절로 처리할 색상/사이즈 옵션을 선택하세요.
    </div>
    <div id="optionBtnArea_${toSafeId(code)}"></div>
    <button class="option-soldout-area" style="width:100%;" onclick="event.stopPropagation();hideOptionSelect('${code}')">닫기</button>
  `;
  setTimeout(() => {

    let optArea = box.querySelector('#optionBtnArea_' + toSafeId(code));
    if (!optArea) return;
    const grid = document.createElement('div');
    grid.className = 'option-btn-grid';

    // 관리코드 전체 상태
    const 전체상태 = soldoutState[code]?.전체;
    const isAllSoldout = 전체상태 === "soldout";
    const isAllDiscont = 전체상태 === "discont";

    // 옵션별 상태 추출 함수
    function getBtnClass(opt) {
      if (!opt) return '';
      if (opt.상태 === "discont") return 'discont';
      if (opt.상태 === "soldout") return 'selected';
      return '';
    }
      // 팝업 내부 버튼들의 표시 상태를 soldoutState 기준으로 리프레시
  function refreshPopup() {
    const 전체상태 = soldoutState[code]?.전체;
    const isAllSoldout = 전체상태 === "soldout";
    const isAllDiscont = 전체상태 === "discont";

    grid.querySelectorAll('.option-btn').forEach(btn => {
      const c = (btn.dataset.color || '').trim();
      const s = (btn.dataset.size  || '').trim();
      btn.classList.remove('selected','discont');

      if (isAllSoldout) { btn.classList.add('selected'); return; }
      if (isAllDiscont) { btn.classList.add('discont');  return; }

      const st = getState(code, c || null, s || null);
      if (st?.상태 === 'soldout') btn.classList.add('selected');
      if (st?.상태 === 'discont') btn.classList.add('discont');
    });
  }


    function getState(code, color, size) {
      const arr = soldoutState[code]?.복합 || [];
      const nc = (color ?? '').trim();
      const ns = (size  ?? '').trim();
      return arr.find(o => (o.색상 ?? '').trim() === nc && (o.사이즈 ?? '').trim() === ns);
    }

    // 옵션 버튼 생성
function createOptionBtn(color, size, label) {
  const b = document.createElement('button');
  b.className = 'option-btn';
  b.textContent = label;
  b.dataset.color = color || '';
  b.dataset.size  = size  || '';

  // 초기 상태 도색
  let opt = getState(code, color, size);
  let btnClass = getBtnClass(opt);
  if (isAllSoldout) b.classList.add('selected');
  else if (isAllDiscont) b.classList.add('discont');
  else if (btnClass) b.classList.add(btnClass);

  b.onclick = (e) => {
    e.stopPropagation();
    soldoutState[code] = soldoutState[code] || { 전체: false, 복합: [] };

    // 전체 상태였으면 해제(개별로 전환)
    if (soldoutState[code].전체 === "soldout" || soldoutState[code].전체 === "discont") {
      soldoutState[code].전체 = false;
    }

    // 옵션별 상태 순환: 품절 → 단종 → 해제
    let idx = (soldoutState[code].복합 || []).findIndex(o =>
      (o.색상 === color || (!color && !o.색상)) &&
      (o.사이즈 === size || (!size && !o.사이즈))
    );

    if (idx < 0) {
      soldoutState[code].복합.push(
        color && size ? { 색상: color, 사이즈: size, 상태: "soldout" }
        : color ?      { 색상: color, 상태: "soldout" }
                 :      { 사이즈: size, 상태: "soldout" }
      );
    } else if (soldoutState[code].복합[idx].상태 === "soldout") {
      soldoutState[code].복합[idx].상태 = "discont";
    } else {
      soldoutState[code].복합.splice(idx, 1);
    }

    // 전체 승격 여부 계산 (전부 단종/전부 품절)
    checkAndAutoSetAllOptionState(code);

    // 팝업은 그대로, 표시만 갱신
    refreshPopup();

    // 사이드 리스트는 즉시 반영
    updateSoldoutList();
  };

  grid.appendChild(b);
}


    // 색상+사이즈
    if (colors.length && sizes.length) {
      for (let color of colors) {
        for (let size of sizes) {
          createOptionBtn(color, size, `${color} / ${size}`);
        }
      }
    } else if (colors.length) {
      colors.forEach(color => {
        createOptionBtn(color, '', color);   // 사이즈는 ''로 고정
      });
    } else if (sizes.length) {
     sizes.forEach(size => {
        createOptionBtn('', size, size);     // 색상은 ''로 고정
      });
    }

    optArea.appendChild(grid);
  }, 0);
  wrapElem.appendChild(box);
  box.onclick = function(e){ e.stopPropagation(); };
}



// updateSoldoutList 함수 전체 교체!
function updateSoldoutList() {
  const ul = document.getElementById('soldoutList');
  ul.innerHTML = '';
  let any = false;
  for (let code of uniqueCodes) {
    if (soldoutState[code]?.전체 === "discont") {
      ul.innerHTML += `<li><b>${code}</b> <span style="color:#533e8e;font-weight:700;">전체단종</span></li>`;
      any = true;
    } else if (soldoutState[code]?.전체 === "soldout") {
      ul.innerHTML += `<li><b>${code}</b> <span style="color:#606060;font-weight:700;">전체품절</span></li>`;
      any = true;
    } else if ((soldoutState[code]?.복합||[]).length > 0) {
      for (let opt of soldoutState[code].복합) {
        let stateLabel = opt.상태 === "discont" ? '<span style="color:#533e8e;font-weight:700;">단종</span>' : '품절';
        ul.innerHTML += `<li><b>${code}</b> ${opt.색상?opt.색상+'/':''}${opt.사이즈||''} ${stateLabel}</li>`;
        any = true;
      }
    }
  }
  if (!any) ul.innerHTML = `<li style="color:#b5b5b5;">(선택내역 없음)</li>`;
}




document.getElementById('downloadBtn').addEventListener('click', async function() {
  let fillStock = document.getElementById('fillStockCheckbox').checked;
  const zip = new JSZip();

  // 1. 관리코드별 옵션 현황 계산
  // allRows를 바로 사용
let codeOptionCount = {};
for (let row of allRows) {
  let code = row['관리코드'] || row['상품코드'] || row['코드'] || '';
  if (!code) continue;
  codeOptionCount[code] = codeOptionCount[code] || { total: 0, soldout: 0, discont: 0 };
  codeOptionCount[code].total += 1;

  let target = soldoutState[code];
  let isSoldout = false, isDiscont = false;

  if ((target?.복합 || []).length > 0) {
    let { color, size } = extractColorAndSize(row);
    for (let opt of target.복합) {
      let matchColor = (!opt.색상 || (color == opt.색상));
      let matchSize = (!opt.사이즈 || (size == opt.사이즈));
      if (matchColor && matchSize) {
        if (opt.상태 === "discont") isDiscont = true;
        if (opt.상태 === "soldout") isSoldout = true;
      }
    }
  }
  if (target?.전체 === "discont") isDiscont = true;
  else if (target?.전체 === "soldout") isSoldout = true;

  if (isDiscont) codeOptionCount[code].discont += 1;
  else if (isSoldout) codeOptionCount[code].soldout += 1;
}


  // 2. 옵션 전부가 품절/단종이면 관리코드 전체에 자동 반영
  for (let code in codeOptionCount) {
    if (codeOptionCount[code].discont === codeOptionCount[code].total) {
      soldoutState[code] = soldoutState[code] || { 전체: false, 복합: [] };
      soldoutState[code].전체 = "discont";
      soldoutState[code].복합 = [];
    } else if (codeOptionCount[code].soldout + codeOptionCount[code].discont === codeOptionCount[code].total) {
      soldoutState[code] = soldoutState[code] || { 전체: false, 복합: [] };
      if (soldoutState[code].전체 !== "discont") {
        soldoutState[code].전체 = "soldout";
        soldoutState[code].복합 = [];
      }
    }
  }

  // 3. 엑셀 데이터 가공 및 zip파일로 저장
// 1) allRows를 파일명으로 그룹핑
const rowsByFile = {};
for (let r of allRows) {
  const fname = r.file || '편집추가.xlsx'; // 파일명 없으면 기본 이름
  if (!rowsByFile[fname]) rowsByFile[fname] = [];
  rowsByFile[fname].push(r);
}

// 2) 각 파일별로 가공해서 xlsx 생성
for (let name in rowsByFile) {
  const data = rowsByFile[name];

  const newData = data.map(row => {
    let code = row['관리코드'] || row['상품코드'] || row['코드'] || '';
    let target = soldoutState[code];
    let isSoldout = false, isDiscont = false;

    if ((target?.복합 || []).length > 0) {
      let { color, size } = extractColorAndSize(row);
      for (let opt of target.복합) {
        let matchColor = (!opt.색상 || (color == opt.색상));
        let matchSize = (!opt.사이즈 || (size == opt.사이즈));
        if (matchColor && matchSize) {
          if (opt.상태 === "discont") isDiscont = true;
          if (opt.상태 === "soldout") isSoldout = true;
        }
      }
    }
    if (target?.전체 === "discont") isDiscont = true;
    else if (target?.전체 === "soldout") isSoldout = true;

    let rowCopy = { ...row };

    if (isDiscont) {
      let originCode = row['관리코드'] || row['상품코드'] || row['코드'] || '';
      let discontCode = originCode.replace(/^(단종\s*)+/g, '');
      discontCode = '단종 ' + discontCode.trim();
      if (discontCode.length > 20) {
        let compactOrigin = discontCode.replace(/\s+/g, '');
        discontCode = '단종' + compactOrigin.slice(2);
        if (discontCode.length > 20) discontCode = discontCode.slice(0, 20);
      }
      rowCopy['관리코드'] = discontCode;
      rowCopy['재고수량'] = 0;
    } else if (isSoldout || (row['관리코드']||'').trim().startsWith('단종')) {
      if ((row['관리코드']||'').trim().startsWith('단종')) {
        let cleanCode = row['관리코드'].replace(/^(단종\s*)+/g, '');
        rowCopy['관리코드'] = '단종 ' + cleanCode.trim();
      }
      rowCopy['재고수량'] = 0;
} else {
  // 품절/단종이 아닌 모든 경우: 체크가 켜져 있으면 재고수량 99999로 강제 설정
  if (fillStock) {
    rowCopy['재고수량'] = 99999;
  }
}


    // 내부용 'file' 컬럼은 엑셀에 안 나가게 제거
    delete rowCopy.file;
    return rowCopy;
  });

  const ws = XLSX.utils.json_to_sheet(newData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
  const xlsBlob = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  zip.file(name.endsWith('.xlsx') ? name : name.replace(/\.xls$/, '.xlsx'), xlsBlob);
}


  zip.generateAsync({ type: "blob" }).then(function (blob) {
    saveAs(blob, "품절처리_일괄다운로드.zip");
  });
});

function updateProdCount() {
  document.getElementById('prodCountInfo').textContent = uniqueCodes.length
    ? `총 ${uniqueCodes.length}개 선택됨` : '';
}

const fileDropZone = document.getElementById('fileDropZone');
fileDropZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileDropZone.classList.add('dragover');
});
fileDropZone.addEventListener('dragleave', function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileDropZone.classList.remove('dragover');
});
fileDropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileDropZone.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length) {
    handleFiles(files);
  }
});
function checkAndAutoSetAllOptionState(code) {
  // 대상 관리코드 행 모으기
  const rows = allRows.filter(r => r.관리코드 === code);
  const totalCnt = rows.length;
  let soldoutCnt = 0, discontCnt = 0;

  // 상태 컨테이너 보정
  soldoutState[code] = soldoutState[code] || { 전체: false, 복합: [] };

  // 와일드카드 매칭: 옵션에 저장된 색상/사이즈가 '' 이면 그 축은 모두 매칭
  const isMatch = (opt, color, size) => {
    const oc = (opt.색상 ?? '').trim();
    const os = (opt.사이즈 ?? '').trim();
    const rc = (color ?? '').trim();
    const rs = (size  ?? '').trim();
    const colorOK = (oc === '' || oc === rc);
    const sizeOK  = (os === '' || os === rs);
    return colorOK && sizeOK;
  };

  // 각 행 상태 집계
  for (const r of rows) {
    const { color, size } = extractColorAndSize(r);
    const match = (soldoutState[code].복합 || []).find(o => isMatch(o, color, size));
    if (match) {
      if (match.상태 === 'discont') discontCnt++;
      else if (match.상태 === 'soldout') soldoutCnt++;
    }
  }

  // 승격: 전부 단종 → 전체단종 / 전부 품절 → 전체품절 / 혼합이면 승격 안 함
  if (totalCnt > 0 && discontCnt === totalCnt) {
    soldoutState[code].전체 = 'discont';
    soldoutState[code].복합 = [];
  } else if (totalCnt > 0 && soldoutCnt === totalCnt) {
    soldoutState[code].전체 = 'soldout';
    soldoutState[code].복합 = [];
  } else {
    soldoutState[code].전체 = false;
  }

  // 사이드 리스트만 갱신 (코드버튼 전체 리렌더는 팝업 클릭 중엔 금지)
  updateSoldoutList();

}

function hideOptionSelect(code) {
  let box = document.getElementById('optionBox_' + toSafeId(code));
  if (box) box.remove();
  selectedCode = null;
  updateCodeBtns();
}

function showOptionSelectForEdit(code, wrapElem, colors, sizes) {
  // 같은 코드의 기존 편집 팝업 제거
  Array.from(wrapElem.querySelectorAll('.option-select-area.popup')).forEach(el => el.remove());

  // 해당 코드의 첫 행(템플릿)로 사이즈 컬럼 존재 여부 파악
  const template = allRows.find(r => r.관리코드 === code) || {};
  const hasSizeCol = Object.prototype.hasOwnProperty.call(template, '사이즈');

  // 팝업 DOM 생성
  const box = document.createElement('div');
  box.id = 'editOptionBox_' + toSafeId(code);
  box.className = 'option-select-area popup';
  box.style.minWidth = '380px';
  box.innerHTML = `
    <div style="margin-bottom:8px;font-weight:600;font-size:14px;color:#2b7365">
      옵션 편집 모드 – <span style="color:#146f58">${code}</span>
    </div>

    <!-- 신규 옵션 추가 -->
    <div style="padding:8px;border:1px solid #cfe3d8;border-radius:8px;margin-bottom:10px;">
      <div style="font-size:12px;color:#547a6b;margin-bottom:6px;">새 옵션 추가</div>

      <div style="display:flex;gap:6px;margin-bottom:6px;">
        <input type="text" id="newColor_${code}" placeholder="색상" style="flex:1;padding:4px;font-size:12px;">
        <input type="text" id="newSize_${code}" placeholder="${hasSizeCol ? '사이즈' : '사이즈 열 없음'}"
               ${hasSizeCol ? '' : 'disabled'} style="flex:1;padding:4px;font-size:12px;">
      </div>

      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <input type="number" id="newStock_${code}" placeholder="재고수량(기본: 99999)"
               value="99999" style="flex:1;padding:4px;font-size:12px;">
      </div>

      <button id="addBtn_${code}"
        style="width:100%;padding:6px;font-size:13px;background:#2b7365;color:#fff;border:none;border-radius:4px;cursor:pointer;">
        + 추가
      </button>

      <div style="margin-top:6px;font-size:11px;color:#7a8d84;line-height:1.4;">
        • 색상만 입력하면 &rarr; 해당 코드의 <b>모든 기존 사이즈</b>로 일괄 추가<br>
        • 사이즈만 입력하면 &rarr; 해당 코드의 <b>모든 기존 색상</b>으로 일괄 추가<br>
        • 색상+사이즈를 모두 입력하면 &rarr; 해당 조합 1개 추가/갱신<br>
        • 재고수량 미입력 시 기본 99999 적용
      </div>
    </div>

    <!-- 기존 옵션 목록 -->
    <div style="font-size:12px;color:#547a6b;margin-bottom:4px;">현재 옵션 목록</div>
    <div id="optionList_${code}" style="display:flex;flex-direction:column;gap:4px;max-height:220px;overflow:auto;">
      ${renderOptionListHTML(code)}
    </div>

    <button class="option-soldout-area" style="width:100%;margin-top:8px;"
            onclick="event.stopPropagation();hideOptionSelect('${code}')">닫기</button>
  `;

  wrapElem.appendChild(box);
  box.onclick = (e) => e.stopPropagation();

  // 추가 버튼 이벤트 (전역의 addNewOption을 사용)
  const addBtn = box.querySelector(`#addBtn_${cssEscapeId(code)}`) || box.querySelector(`#addBtn_${code}`);
  if (addBtn) {
    addBtn.onclick = (e) => {
      e.stopPropagation();
      addNewOption(code);
      // 목록 즉시 갱신 (addNewOption 내부에서도 갱신하지만 안전하게 한 번 더)
      const listEl = document.getElementById(`optionList_${code}`);
      if (listEl) listEl.innerHTML = renderOptionListHTML(code);
    };
  }
}

// 내부에서 id 선택 시 특수문자 이슈를 줄이기 위한 보조 함수 (안전하지 않은 코드값 대비)
function cssEscapeId(raw) {
  // 간단 escape: 공백/특수문자 -> 백슬래시 이스케이프
  return String(raw).replace(/([ #;?%&,.+*~\':"!^$[\]()=>|\/@])/g, '\\$1');
}


function renderOptionListHTML(code) {
  const rows = allRows.filter(r => r.관리코드 === code);
  if (!rows.length) return `<div style="font-size:12px;color:#aaa;">(옵션 없음)</div>`;

  // color||size 키로 유니크 처리
  const seen = new Set();
  const items = [];
  for (const r of rows) {
    const { color, size } = extractColorAndSize(r);
    const key = `${color||''}||${size||''}`;
    if (seen.has(key)) continue;
    seen.add(key);
    items.push({
      color: color || '-',
      size:  size  || '-',
      stock: r['재고수량'] ?? 0
    });
  }

  return items.map(it => `
    <div style="display:flex;align-items:center;justify-content:space-between;border:1px solid #ddd;padding:4px 6px;border-radius:4px;">
      <span style="font-size:12px;">${it.color} / ${it.size}</span>
      <div style="display:flex;align-items:center;gap:4px;">
        <span style="font-size:11px;color:#666;">재고: ${it.stock}</span>
        <button style="background:#ff5c5c;color:#fff;border:none;padding:2px 6px;border-radius:3px;font-size:11px;cursor:pointer;"
          onclick="removeOption('${code}','${it.color === '-' ? '' : it.color}','${it.size === '-' ? '' : it.size}')">−</button>
      </div>
    </div>
  `).join('');
}


function removeOption(code, color, size) {
  allRows = allRows.filter(r => {
    const cs = extractColorAndSize(r);
    return !(r.관리코드 === code && (cs.color || '') === color && (cs.size || '') === size);
  });

  document.getElementById(`optionList_${code}`).innerHTML = renderOptionListHTML(code);
}
function getSizesByCode(code) {
  const set = new Set();
  allRows
    .filter(r => r.관리코드 === code)
    .forEach(r => {
      const { size } = extractColorAndSize(r);
      if (size) set.add(size.trim());
    });
  return Array.from(set);
}
// 해당 관리코드의 "기존 색상" 목록을 중복 없이 반환
function getColorsByCode(code) {
  const set = new Set();
  allRows
    .filter(r => r.관리코드 === code)
    .forEach(r => {
      const { color } = extractColorAndSize(r);
      if (color) set.add(color.trim());
    });
  return Array.from(set);
}
// 라벨(제품선택/추가상품값)에서 끝의 [사이즈]와 [색상]을 지우고 새 색상만 붙임
function buildProductTextFromTemplateForCode(code, tplRow, newColor) {
  const raw = (tplRow['제품선택'] || tplRow['추가상품값'] || '').toString();
  const tokens = raw.split('/').map(s => s.trim()).filter(Boolean);

  const isSize = v => /^(FREE|XS|S|M|L|XL|XXL|\d{2,3})$/i.test(v);
  const colorSet = new Set(getColorsByCode(code).map(c => c.toUpperCase()));

  // 1) 끝이 사이즈면 제거
  if (tokens.length && isSize(tokens[tokens.length - 1])) tokens.pop();
  // 2) 끝이 '이 코드에서 쓰는 색상'이면 제거
  if (tokens.length && colorSet.has(tokens[tokens.length - 1].toUpperCase())) tokens.pop();

  tokens.push(newColor);
  return tokens.join(' / ');
}


// 보조: 뒤에서부터 조건에 맞는 인덱스 찾기
function findLastIndex(arr, pred){
  for (let i = arr.length - 1; i >= 0; i--) if (pred(arr[i], i, arr)) return i;
  return -1;
}

function addNewOption(code) {
  const colorInput = document.getElementById(`newColor_${code}`).value.trim();
  const sizeInput  = document.getElementById(`newSize_${code}`)?.value.trim() || '';
  const stock      = parseInt(document.getElementById(`newStock_${code}`).value.trim(), 10) || 99999;

  if (!colorInput && !sizeInput) { alert("색상 또는 사이즈 중 최소 하나는 입력하세요."); return; }

  const template = allRows.find(r => r.관리코드 === code);
  if (!template) { alert("추가할 기준 행을 찾을 수 없습니다."); return; }

  const hasSizeCol = Object.prototype.hasOwnProperty.call(template, '사이즈');
  const colorsToUse = colorInput ? [colorInput] : (getColorsByCode(code).length ? getColorsByCode(code) : ['']);
  const sizesToUse  = hasSizeCol ? (sizeInput ? [sizeInput] : (getSizesByCode(code).length ? getSizesByCode(code) : [''])) : [''];

  const buildLabel = col => buildProductTextFromTemplateForCode(code, template, col);


  colorsToUse.forEach(col => {
    sizesToUse.forEach(sz => {
      const existIdx = allRows.findIndex(r => {
        if (r.관리코드 !== code) return false;
        const cs = extractColorAndSize(r);
        return (cs.color || '') === (col || '') && (cs.size || '') === (sz || '');
      });

      if (existIdx >= 0) {
        // 기존 조합 업데이트
        const row = allRows[existIdx];
        row['재고수량'] = stock;
        if ('색상' in row)   row['색상']   = col || '';
        if ('사이즈' in row) row['사이즈'] = sz  || '';
        if ('제품선택'   in row) row['제품선택']   = buildLabel(col); // 라벨엔 사이즈 넣지 않음
        if ('추가상품값' in row) row['추가상품값'] = buildLabel(col);
      } else {
        // 새 조합 추가 → 같은 파일·같은 관리코드 블록 끝에 끼워넣기
        const newRow = { ...template };
        newRow['관리코드'] = code;
        if ('상품코드' in newRow) newRow['상품코드'] = code;
        if ('코드'     in newRow) newRow['코드']     = code;
        if ('색상'   in newRow) newRow['색상']   = col || '';
        if ('사이즈' in newRow) newRow['사이즈'] = sz  || '';
        newRow['재고수량'] = stock;
        if ('제품선택'   in newRow) newRow['제품선택']   = buildLabel(col);
        if ('추가상품값' in newRow) newRow['추가상품값'] = buildLabel(col);
        newRow.file = template.file;

        const lastIdx = findLastIndex(allRows, r => r.file === template.file && r.관리코드 === code);
        if (lastIdx >= 0) allRows.splice(lastIdx + 1, 0, newRow);
        else allRows.push(newRow);
      }
    });
  });

  // UI 갱신
  document.getElementById(`optionList_${code}`).innerHTML = renderOptionListHTML(code);
  document.getElementById(`newColor_${code}`).value = '';
  const szEl = document.getElementById(`newSize_${code}`); if (szEl) szEl.value = '';
  document.getElementById(`newStock_${code}`).value = '';

  // 품절/단종 팝업에도 바로 반영되길 원하면 활성화
  updateCodeBtns();
}


// 코드에 '사이즈' 열이 있는지 확인
function hasSizeColumnForCode(code) {
  const tpl = allRows.find(r => r.관리코드 === code) || {};
  return Object.prototype.hasOwnProperty.call(tpl, '사이즈');
}

  </script>
</body>
</html>
